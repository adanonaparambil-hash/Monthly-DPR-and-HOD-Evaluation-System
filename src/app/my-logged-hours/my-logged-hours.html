<div class="logged-hours-container" [class.dark-mode]="isDarkMode">
  <!-- Toaster Component -->
  <app-toaster></app-toaster>
  <!-- Header Section -->
  <header class="page-header">
    <div class="header-left">
      <div class="header-info">
        <h1 class="page-title">
          <i class="fas fa-clock animated-clock-title"></i>
          My Logged Hours
        </h1>
        <!-- <p class="page-subtitle">PRODUCTIVITY DASHBOARD</p> -->
      </div>
    </div>
    <div class="header-actions">
      <button class="action-btn secondary" (click)="openManageFieldsModal()">
        <i class="fas fa-cog"></i>
        <span>Manage Fields</span>
      </button>
      <button class="action-btn secondary" (click)="exportReport()">
        <i class="fas fa-download"></i>
        <span>Export Report</span>
      </button>
      <button class="action-btn primary" (click)="openBreakHistoryModal()">
        <i class="fas fa-coffee"></i>
        <span>Break History</span>
      </button>
    </div>
  </header>

  <!-- Filters Section -->
  <div class="filters-section">
    <div class="filters-row">
      <div class="filter-group">
        <label class="filter-label">From Date</label>
        <div class="filter-input-wrapper">
          <i class="fas fa-calendar-alt filter-icon"></i>
          <input type="date" class="filter-date-input" [(ngModel)]="fromDate" (change)="onDateChange()" placeholder="Select from date">
        </div>
      </div>

      <div class="filter-group">
        <label class="filter-label">To Date</label>
        <div class="filter-input-wrapper">
          <i class="fas fa-calendar-alt filter-icon"></i>
          <input type="date" class="filter-date-input" [(ngModel)]="toDate" (change)="onDateChange()" placeholder="Select to date">
        </div>
      </div>

      <div class="filter-group">
        <label class="filter-label">Project</label>
        <div class="filter-input-wrapper">
          <i class="fas fa-project-diagram filter-icon"></i>
          <select class="filter-select" [(ngModel)]="selectedProject" (change)="onProjectChange()">
            <option value="all">All Projects</option>
            <option *ngFor="let project of projects" [value]="project.projectId">
              {{ project.projectName }}
            </option>
          </select>
        </div>
      </div>

      <div class="filter-group">
        <label class="filter-label">Department</label>
        <div class="filter-input-wrapper">
          <i class="fas fa-building filter-icon"></i>
          <select class="filter-select" [(ngModel)]="selectedDepartment" (change)="onDepartmentChange()">
            <option value="all">All Departments</option>
            <option *ngFor="let dept of departments" [value]="dept.departmentId">
              {{ dept.deptName }}
            </option>
          </select>
        </div>
      </div>

      <div class="filter-group">
        <label class="filter-label">Employee</label>
        <div class="filter-input-wrapper">
          <i class="fas fa-user filter-icon"></i>
          <select class="filter-select" [(ngModel)]="selectedEmployee" (change)="onEmployeeChange()" [disabled]="selectedDepartment === 'all'">
            <option value="all">{{ selectedDepartment === 'all' ? 'Select Department First' : 'All Employees' }}</option>
            <option *ngFor="let employee of employees" [value]="employee.employeeCode">
              {{ employee.employeeName }}
            </option>
          </select>
        </div>
      </div>

      <div class="filter-group">
        <label class="filter-label">Task Category</label>
        <div class="filter-input-wrapper">
          <i class="fas fa-tags filter-icon"></i>
          <select class="filter-select" [(ngModel)]="selectedCategory" (change)="onCategoryChange()" [disabled]="selectedDepartment === 'all'">
            <option value="all">{{ selectedDepartment === 'all' ? 'Select Department First' : 'All Categories' }}</option>
            <option *ngFor="let category of taskCategories" [value]="category.categoryId">
              {{ category.categoryName }}
            </option>
          </select>
        </div>
      </div>
    </div>

    <div class="filter-actions">
      <button class="filter-btn apply-filter-btn" (click)="loadLoggedHours()">
        <i class="fas fa-check-circle"></i>
        <span>Apply Filter</span>
      </button>
      <button class="filter-btn" (click)="openColumnModal()">
        <i class="fas fa-columns"></i>
        <span>Edit Columns</span>
      </button>
    </div>
  </div>

  <!-- Data Table -->
  <div class="table-wrapper">
    <div class="data-table">
    <!-- Table Header -->
    <div class="table-header" [style.grid-template-columns]="getGridTemplateColumns()">
      @for (column of getVisibleColumns(); track column.key) {
        <div class="header-col" [class]="column.key">{{ column.label }}</div>
      }
    </div>

    <!-- Table Body -->
    <div class="table-body">
      <!-- Loading State -->
      @if (isLoadingData) {
        <div class="loading-state">
          <i class="fas fa-spinner fa-spin"></i>
          <p>Loading logged hours...</p>
        </div>
      }

      <!-- Empty State -->
      @if (!isLoadingData && loggedHours.length === 0) {
        <div class="empty-state">
          <div class="empty-state-icon">
            <i class="fas fa-clock"></i>
          </div>
          <h3 class="empty-state-title">No Logged Hours Found</h3>
          <p class="empty-state-message">You don't have any logged hours for the selected date range and filters.</p>
          <div class="empty-state-suggestions">
            <p class="suggestion-title">Try the following:</p>
            <ul class="suggestion-list">
              <li><i class="fas fa-calendar-alt"></i> Adjust your date range</li>
              <li><i class="fas fa-filter"></i> Clear or modify your filters</li>
              <li><i class="fas fa-tasks"></i> Start working on a task to log hours</li>
            </ul>
          </div>
        </div>
      }

      <!-- Dynamic Day Groups -->
      @if (!isLoadingData && loggedHours.length > 0) {
        @for (dayGroup of getGroupedLoggedHours(); track dayGroup.date) {
          <div class="day-group">
            <div class="day-header">
              <h3 class="day-title">{{ dayGroup.displayDay }}</h3>
              <span class="day-date">{{ dayGroup.displayDate }}</span>
            </div>
            <div class="day-records">
              @for (record of dayGroup.records; track record.id) {
                <div class="record-row" [style.grid-template-columns]="getGridTemplateColumns()" (click)="openTaskModal(record)" style="cursor: pointer;">
                  @for (column of getVisibleColumns(); track column.key) {
                    <div class="record-col" [class]="column.key">
                      @switch (column.key) {
                        @case ('title') {
                          <div class="title-column-content">
                            <h4 class="task-title" [title]="record.title">{{ record.title }}</h4>
                            @if (!isDescriptionColumnVisible()) {
                              <p class="task-description" [title]="record.description">{{ record.description }}</p>
                            }
                          </div>
                        }
                        @case ('description') {
                          <span class="column-value" [title]="record.description">{{ record.description }}</span>
                        }
                        @case ('category') {
                          <span class="category-badge" [class]="getCategoryClass(record.category)">
                            {{ record.category }}
                          </span>
                          @if (record.priority) {
                            <span class="priority-badge" [class]="getPriorityClass(record.priority)">
                              {{ record.priority }}
                            </span>
                          }
                        }
                        @case ('loggedBy') {
                          <span class="logged-by-name">{{ record.loggedBy }}</span>
                        }
                        @case ('duration') {
                          <span class="duration-text">{{ record.duration }}</span>
                          <button class="more-btn" (click)="$event.stopPropagation()">
                            <i class="fas fa-ellipsis-h"></i>
                          </button>
                        }
                        @case ('progress') {
                          <div class="progress-container">
                            <div class="progress-bar">
                              <div class="progress-fill" [style.width.%]="getColumnValue(record, column.key)"></div>
                            </div>
                            <span class="progress-text">{{ formatColumnValue(getColumnValue(record, column.key), column) }}</span>
                          </div>
                        }
                        @default {
                          <span class="column-value" 
                                [title]="getTooltipText(record, column.key)">
                            {{ formatColumnValue(getColumnValue(record, column.key), column) }}
                          </span>
                        }
                      }
                    </div>
                  }
                </div>
              }
            </div>
          </div>
        }
        
        <!-- Scroll Hint -->
        @if (getVisibleColumns().length > 4) {
          <div class="scroll-hint">
            <i class="fas fa-arrows-alt-h"></i>
            Scroll horizontally to see more columns
          </div>
        }
      }
    </div>
  </div>
</div>

<!-- Column Management Modal -->
@if (showColumnModal) {
  <div class="column-modal-overlay" (click)="closeColumnModal()">
    <div class="column-modal-container" (click)="$event.stopPropagation()">
      <!-- Modal Header -->
      <div class="column-modal-header">
        <div class="modal-header-content">
          <h3 class="modal-title">
            <i class="fas fa-columns"></i>
            Manage Table Columns
          </h3>
          <p class="modal-subtitle">Select which columns to display in the logged hours table</p>
        </div>
        <button class="modal-close-btn" (click)="closeColumnModal()">
          <i class="fas fa-times"></i>
        </button>
      </div>

      <!-- Modal Content -->
      <div class="column-modal-content">
        <div class="column-search">
          <div class="search-input-wrapper">
            <i class="fas fa-search search-icon"></i>
            <input type="text" placeholder="Search columns..." class="column-search-input" #searchInput>
          </div>
        </div>

        <div class="columns-list-container">
          <div class="columns-list">
            @for (column of availableColumns; track column.key) {
              <div class="column-item" 
                   [class.visible]="column.visible" 
                   [class.required]="column.required"
                   (click)="toggleColumn(column.key)">
                <div class="column-checkbox">
                  <input type="checkbox" 
                         [checked]="column.visible" 
                         [disabled]="column.required"
                         class="checkbox-input">
                  <div class="checkbox-custom">
                    <i class="fas fa-check"></i>
                  </div>
                </div>
                
                <div class="column-info">
                  <div class="column-name">{{ column.label }}</div>
                  <div class="column-meta">
                    <span class="column-type" [class]="'type-' + column.type">{{ column.type }}</span>
                    @if (column.required) {
                      <span class="required-badge">Required</span>
                    }
                  </div>
                </div>
                
                <div class="column-drag-handle">
                  <i class="fas fa-grip-vertical"></i>
                </div>
              </div>
            }
          </div>
        </div>

        <!-- Column Summary -->
        <div class="column-summary">
          <div class="summary-stats">
            <div class="stat-item">
              <span class="stat-value">{{ getVisibleColumns().length }}</span>
              <span class="stat-label">Visible</span>
            </div>
            <div class="stat-divider"></div>
            <div class="stat-item">
              <span class="stat-value">{{ availableColumns.length - getVisibleColumns().length }}</span>
              <span class="stat-label">Hidden</span>
            </div>
            <div class="stat-divider"></div>
            <div class="stat-item">
              <span class="stat-value">{{ getRequiredColumnsCount() }}</span>
              <span class="stat-label">Required</span>
            </div>
          </div>
        </div>
      </div>

      <!-- Modal Footer -->
      <div class="column-modal-footer">
        <div class="footer-left">
          <button class="reset-btn" (click)="resetColumns()">
            <i class="fas fa-undo"></i>
            Reset to Default
          </button>
        </div>
        <div class="footer-right">
          <button class="cancel-btn" (click)="closeColumnModal()">
            Cancel
          </button>
          <button class="apply-btn" (click)="applyColumnChanges()">
            <i class="fas fa-check"></i>
            Apply Changes
          </button>
        </div>
      </div>
    </div>
  </div>
}

<!-- Task Details Modal -->
@if (showTaskModal) {
  <app-task-details-modal
    [taskId]="selectedTaskId"
    [userId]="currentUserId"
    [categoryId]="selectedTaskCategoryId"
    (closeModal)="closeTaskModal()"
    (taskUpdated)="onTaskUpdated($event)"
    (taskPaused)="onTaskPaused($event)"
    (taskResumed)="onTaskResumed($event)"
    (taskStopped)="onTaskStopped($event)">
  </app-task-details-modal>
}

<!-- Break History Modal - Large Table Design -->
@if (showBreakHistoryModal) {
  <div class="modal-overlay-large" (click)="closeBreakHistoryModal()">
    <div class="break-history-modal-large" (click)="$event.stopPropagation()">
      <!-- Modal Header -->
      <div class="modal-header-large">
        <div class="modal-title-section-large">
          <i class="fas fa-coffee modal-icon-large"></i>
          <div>
            <h2 class="modal-title-large">Break History</h2>
            <p class="modal-subtitle-large">Active break sessions across the organization</p>
          </div>
        </div>
        <button class="close-btn-large" (click)="closeBreakHistoryModal()">
          <i class="fas fa-times"></i>
        </button>
      </div>

      <!-- Modal Body with Table -->
      <div class="modal-body-large">
        <!-- Loading State -->
        @if (isLoadingBreaks) {
          <div class="loading-state-large">
            <i class="fas fa-spinner fa-spin"></i>
            <p>Loading break history...</p>
          </div>
        }

        <!-- Empty State -->
        @if (!isLoadingBreaks && openBreaks.length === 0) {
          <div class="empty-state-large">
            <i class="fas fa-coffee"></i>
            <p>No Active Breaks</p>
            <span>All employees are currently working</span>
          </div>
        }

        <!-- Break History Table -->
        @if (!isLoadingBreaks && openBreaks.length > 0) {
          <div class="break-table-container">
            <table class="break-table">
              <thead>
                <tr>
                  <th class="th-employee">Employee</th>
                  <th class="th-department">Department</th>
                  <th class="th-reason">Break Reason</th>
                  <th class="th-start">Start Time</th>
                  <th class="th-duration">Duration</th>
                  <th class="th-remarks">Remarks</th>
                  <th class="th-status">Status</th>
                </tr>
              </thead>
              <tbody>
                @for (breakRecord of openBreaks; track breakRecord.employeeId) {
                  <tr class="break-row">
                    <td class="td-employee">
                      <div class="employee-cell">
                        <div class="employee-avatar-small">
                          @if (breakRecord.profilePicture) {
                            <img [src]="'data:image/jpeg;base64,' + breakRecord.profilePicture" 
                                 [alt]="breakRecord.employeeName"
                                 class="avatar-img-small">
                          } @else {
                            <div class="avatar-placeholder-small">
                              {{ getInitials(breakRecord.employeeName) }}
                            </div>
                          }
                        </div>
                        <div class="employee-info-small">
                          <span class="employee-name-small">{{ breakRecord.employeeName }}</span>
                          <span class="employee-id-small">{{ breakRecord.employeeId }}</span>
                        </div>
                      </div>
                    </td>
                    <td class="td-department">
                      <div class="department-cell">
                        <span class="department-name">{{ breakRecord.department }}</span>
                        <span class="designation-name">{{ breakRecord.designation }}</span>
                      </div>
                    </td>
                    <td class="td-reason">
                      <span class="break-reason-badge">
                        <i class="fas fa-mug-hot"></i>
                        {{ breakRecord.breakReason }}
                      </span>
                    </td>
                    <td class="td-start">
                      <span class="start-time">{{ formatBreakTime(breakRecord.breakStartTime) }}</span>
                    </td>
                    <td class="td-duration">
                      <span class="duration-badge">
                        <i class="fas fa-clock"></i>
                        {{ formatDuration(breakRecord.breakDurationMinutes) }}
                      </span>
                    </td>
                    <td class="td-remarks">
                      @if (breakRecord.remarks) {
                        <span class="remarks-text">{{ breakRecord.remarks }}</span>
                      } @else {
                        <span class="no-remarks">â€”</span>
                      }
                    </td>
                    <td class="td-status">
                      <span class="status-badge-active">
                        <i class="fas fa-circle pulse-dot"></i>
                        On Break
                      </span>
                    </td>
                  </tr>
                }
              </tbody>
            </table>
          </div>
        }
      </div>

      <!-- Modal Footer -->
      <div class="modal-footer-large">
        <div class="footer-info">
          <i class="fas fa-info-circle"></i>
          <span>Showing {{ openBreaks.length }} active break(s)</span>
        </div>
        <div class="footer-actions">
          <button class="btn-secondary-large" (click)="closeBreakHistoryModal()">
            <i class="fas fa-times"></i>
            Close
          </button>
          <button class="btn-primary-large" (click)="refreshBreakHistory()">
            <i class="fas fa-sync-alt"></i>
            Refresh
          </button>
        </div>
      </div>
    </div>
  </div>
}


<!-- Manage Fields Modal -->
@if (showManageFieldsModal) {
  <div class="modal-overlay-large" (click)="closeManageFieldsModal()">
    <div class="manage-fields-modal" (click)="$event.stopPropagation()">
      <!-- Modal Header -->
      <div class="modal-header-large">
        <div class="modal-title-section-large">
          <i class="fas fa-cog modal-icon-large"></i>
          <div>
            <h2 class="modal-title-large">Manage Custom Fields</h2>
            <p class="modal-subtitle-large">Create and manage custom fields for your tasks</p>
          </div>
        </div>
        <button class="close-btn-large" (click)="closeManageFieldsModal()">
          <i class="fas fa-times"></i>
        </button>
      </div>

      <!-- Modal Body -->
      <div class="modal-body-large">
        <div class="fields-container">
          <!-- Add New Field Section -->
          <div class="add-field-section">
            <h3 class="section-title">
              <i class="fas fa-plus-circle"></i>
              Create New Field
            </h3>
            <div class="field-form">
              <div class="form-row">
                <div class="form-group">
                  <label class="form-label">Field Name <span class="required">*</span></label>
                  <input 
                    type="text" 
                    class="form-input" 
                    [(ngModel)]="newField.fieldName"
                    placeholder="Enter field name"
                    maxlength="50">
                </div>
                <div class="form-group">
                  <label class="form-label">Field Type <span class="required">*</span></label>
                  <select class="form-select" [(ngModel)]="newField.fieldType">
                    <option value="">Select type</option>
                    <option value="Text">Text</option>
                    <option value="Number">Number</option>
                    <option value="Date">Date</option>
                    <option value="Dropdown">Dropdown</option>
                  </select>
                </div>
              </div>

              @if (newField.fieldType === 'Dropdown') {
                <div class="form-group">
                  <label class="form-label">Dropdown Options <span class="required">*</span></label>
                  <input 
                    type="text" 
                    class="form-input" 
                    [(ngModel)]="newField.options"
                    placeholder="Enter options separated by commas (e.g., Option1, Option2, Option3)">
                  <small class="form-hint">Separate multiple options with commas</small>
                </div>
              }

              <div class="form-actions">
                <button class="btn-create" (click)="createField()" [disabled]="!isNewFieldValid()">
                  <i class="fas fa-plus"></i>
                  Create Field
                </button>
                <button class="btn-clear" (click)="clearNewField()">
                  <i class="fas fa-times"></i>
                  Clear
                </button>
              </div>
            </div>
          </div>

          <!-- Existing Fields Section -->
          <div class="existing-fields-section">
            <h3 class="section-title">
              <i class="fas fa-list"></i>
              Existing Fields ({{ customFields.length }})
            </h3>

            <!-- Loading State -->
            @if (isLoadingFields) {
              <div class="loading-state-small">
                <i class="fas fa-spinner fa-spin"></i>
                <p>Loading fields...</p>
              </div>
            }

            <!-- Empty State -->
            @if (!isLoadingFields && customFields.length === 0) {
              <div class="empty-state-small">
                <i class="fas fa-inbox"></i>
                <p>No custom fields yet</p>
                <span>Create your first custom field above</span>
              </div>
            }

            <!-- Fields List -->
            @if (!isLoadingFields && customFields.length > 0) {
              <div class="fields-list">
                @for (field of customFields; track field.fieldId) {
                  <div class="field-card">
                    @if (field.isEditing) {
                      <!-- Edit Mode -->
                      <div class="field-edit-mode">
                        <div class="form-row">
                          <div class="form-group">
                            <label class="form-label-small">Field Name</label>
                            <input 
                              type="text" 
                              class="form-input-small" 
                              [(ngModel)]="field.fieldName"
                              maxlength="50">
                          </div>
                          <div class="form-group">
                            <label class="form-label-small">Field Type</label>
                            <select class="form-select-small" [(ngModel)]="field.fieldType">
                              <option value="Text">Text</option>
                              <option value="Number">Number</option>
                              <option value="Date">Date</option>
                              <option value="Dropdown">Dropdown</option>
                            </select>
                          </div>
                        </div>

                        @if (field.fieldType === 'Dropdown') {
                          <div class="form-group">
                            <label class="form-label-small">Options</label>
                            <input 
                              type="text" 
                              class="form-input-small" 
                              [(ngModel)]="field.options"
                              placeholder="Comma-separated options">
                          </div>
                        }

                        <div class="field-actions">
                          <button class="btn-save-small" (click)="saveField(field)">
                            <i class="fas fa-check"></i>
                            Save
                          </button>
                          <button class="btn-cancel-small" (click)="cancelEdit(field)">
                            <i class="fas fa-times"></i>
                            Cancel
                          </button>
                        </div>
                      </div>
                    } @else {
                      <!-- View Mode -->
                      <div class="field-view-mode">
                        <div class="field-info">
                          <div class="field-header">
                            <h4 class="field-name">{{ field.fieldName }}</h4>
                            <span class="field-type-badge" [class]="'type-' + field.fieldType.toLowerCase()">
                              <i [class]="getFieldTypeIcon(field.fieldType)"></i>
                              {{ field.fieldType }}
                            </span>
                          </div>
                          @if (field.fieldType === 'Dropdown' && field.options) {
                            <div class="field-options">
                              <span class="options-label">Options:</span>
                              <span class="options-value">{{ field.options }}</span>
                            </div>
                          }
                          <div class="field-meta">
                            <span class="field-id">ID: {{ field.fieldId }}</span>
                          </div>
                        </div>
                        <div class="field-actions">
                          <button class="btn-edit-small" (click)="editField(field)">
                            <i class="fas fa-edit"></i>
                            Edit
                          </button>
                          <button class="btn-delete-small" (click)="deleteField(field)">
                            <i class="fas fa-trash"></i>
                            Delete
                          </button>
                        </div>
                      </div>
                    }
                  </div>
                }
              </div>
            }
          </div>
        </div>
      </div>

      <!-- Modal Footer -->
      <div class="modal-footer-large">
        <div class="footer-info">
          <i class="fas fa-info-circle"></i>
          <span>Custom fields can be used in task details</span>
        </div>
        <div class="footer-actions">
          <button class="btn-secondary-large" (click)="closeManageFieldsModal()">
            <i class="fas fa-times"></i>
            Close
          </button>
        </div>
      </div>
    </div>
  </div>
}
