<div class="logged-hours-container" [class.dark-mode]="isDarkMode">
  <!-- Toaster Component -->
  <app-toaster></app-toaster>
  <!-- Header Section -->
  <header class="page-header">
    <div class="header-left">
      <div class="header-info">
        <h1 class="page-title">
          <i class="fas fa-clock animated-clock-title"></i>
          My Logged Hours
        </h1>
        <!-- <p class="page-subtitle">PRODUCTIVITY DASHBOARD</p> -->
      </div>
    </div>
    <div class="header-actions">
      <button class="action-btn secondary" (click)="openManageFieldsModal()">
        <i class="fas fa-cog"></i>
        <span>Manage Fields</span>
      </button>
      <button class="action-btn secondary" (click)="exportReport()">
        <i class="fas fa-download"></i>
        <span>Export Report</span>
      </button>
      <button class="action-btn primary" (click)="openBreakHistoryModal()">
        <i class="fas fa-coffee"></i>
        <span>Break History</span>
      </button>
    </div>
  </header>

  <!-- Filters Section -->
  <div class="filters-section">
    <div class="filters-row">
      <div class="filter-group">
        <label class="filter-label">From Date</label>
        <div class="filter-input-wrapper">
          <i class="fas fa-calendar-alt filter-icon"></i>
          <input type="date" class="filter-date-input" [(ngModel)]="fromDate" (change)="onDateChange()" placeholder="Select from date">
        </div>
      </div>

      <div class="filter-group">
        <label class="filter-label">To Date</label>
        <div class="filter-input-wrapper">
          <i class="fas fa-calendar-alt filter-icon"></i>
          <input type="date" class="filter-date-input" [(ngModel)]="toDate" (change)="onDateChange()" placeholder="Select to date">
        </div>
      </div>

      <div class="filter-group">
        <label class="filter-label">Project</label>
        <div class="filter-input-wrapper">
          <i class="fas fa-project-diagram filter-icon"></i>
          <select class="filter-select" [(ngModel)]="selectedProject" (change)="onProjectChange()">
            <option value="all">All Projects</option>
            <option *ngFor="let project of projects" [value]="project.projectId">
              {{ project.projectName }}
            </option>
          </select>
        </div>
      </div>

      <div class="filter-group">
        <label class="filter-label">Department</label>
        <div class="filter-input-wrapper">
          <i class="fas fa-building filter-icon"></i>
          <select class="filter-select" [(ngModel)]="selectedDepartment" (change)="onDepartmentChange()">
            <option value="all">All Departments</option>
            <option *ngFor="let dept of departments" [value]="dept.departmentId">
              {{ dept.deptName }}
            </option>
          </select>
        </div>
      </div>

      <div class="filter-group">
        <label class="filter-label">Employee</label>
        <div class="filter-input-wrapper">
          <i class="fas fa-user filter-icon"></i>
          <select class="filter-select" [(ngModel)]="selectedEmployee" (change)="onEmployeeChange()" [disabled]="selectedDepartment === 'all'">
            <option value="all">{{ selectedDepartment === 'all' ? 'Select Department First' : 'All Employees' }}</option>
            <option *ngFor="let employee of employees" [value]="employee.employeeCode">
              {{ employee.employeeName }}
            </option>
          </select>
        </div>
      </div>

      <div class="filter-group">
        <label class="filter-label">Task Category</label>
        <div class="filter-input-wrapper">
          <i class="fas fa-tags filter-icon"></i>
          <select class="filter-select" [(ngModel)]="selectedCategory" (change)="onCategoryChange()" [disabled]="selectedDepartment === 'all'">
            <option value="all">{{ selectedDepartment === 'all' ? 'Select Department First' : 'All Categories' }}</option>
            <option *ngFor="let category of taskCategories" [value]="category.categoryId">
              {{ category.categoryName }}
            </option>
          </select>
        </div>
      </div>
    </div>

    <div class="filter-actions">
      <button class="filter-btn apply-filter-btn" (click)="loadLoggedHours()">
        <i class="fas fa-check-circle"></i>
        <span>Apply Filter</span>
      </button>
      <button class="filter-btn" (click)="openColumnModal()">
        <i class="fas fa-columns"></i>
        <span>Edit Columns</span>
      </button>
    </div>
  </div>

  <!-- Data Table -->
  <div class="table-wrapper">
    <div class="data-table">
    <!-- Table Header -->
    <div class="table-header" [style.grid-template-columns]="getGridTemplateColumns()">
      @for (column of getVisibleColumns(); track column.key) {
        <div class="header-col" [class]="column.key">{{ column.label }}</div>
      }
    </div>

    <!-- Table Body -->
    <div class="table-body">
      <!-- Loading State -->
      @if (isLoadingData) {
        <div class="loading-state">
          <i class="fas fa-spinner fa-spin"></i>
          <p>Loading logged hours...</p>
        </div>
      }

      <!-- Empty State -->
      @if (!isLoadingData && loggedHours.length === 0) {
        <div class="empty-state">
          <div class="empty-state-icon">
            <i class="fas fa-clock"></i>
          </div>
          <h3 class="empty-state-title">No Logged Hours Found</h3>
          <p class="empty-state-message">You don't have any logged hours for the selected date range and filters.</p>
          <div class="empty-state-suggestions">
            <p class="suggestion-title">Try the following:</p>
            <ul class="suggestion-list">
              <li><i class="fas fa-calendar-alt"></i> Adjust your date range</li>
              <li><i class="fas fa-filter"></i> Clear or modify your filters</li>
              <li><i class="fas fa-tasks"></i> Start working on a task to log hours</li>
            </ul>
          </div>
        </div>
      }

      <!-- Dynamic Day Groups -->
      @if (!isLoadingData && loggedHours.length > 0) {
        @for (dayGroup of getGroupedLoggedHours(); track dayGroup.date) {
          <div class="day-group">
            <div class="day-header">
              <h3 class="day-title">{{ dayGroup.displayDay }}</h3>
              <span class="day-date">{{ dayGroup.displayDate }}</span>
            </div>
            <div class="day-records">
              @for (record of dayGroup.records; track record.id) {
                <div class="record-row" [style.grid-template-columns]="getGridTemplateColumns()" (click)="openTaskModal(record)" style="cursor: pointer;">
                  @for (column of getVisibleColumns(); track column.key) {
                    <div class="record-col" [class]="column.key">
                      @switch (column.key) {
                        @case ('title') {
                          <div class="title-column-content">
                            <h4 class="task-title" [title]="record.title">{{ record.title }}</h4>
                            @if (!isDescriptionColumnVisible()) {
                              <p class="task-description" [title]="record.description">{{ record.description }}</p>
                            }
                          </div>
                        }
                        @case ('description') {
                          <span class="column-value" [title]="record.description">{{ record.description }}</span>
                        }
                        @case ('category') {
                          <span class="category-badge" [class]="getCategoryClass(record.category)">
                            {{ record.category }}
                          </span>
                          @if (record.priority) {
                            <span class="priority-badge" [class]="getPriorityClass(record.priority)">
                              {{ record.priority }}
                            </span>
                          }
                        }
                        @case ('loggedBy') {
                          <span class="logged-by-name">{{ record.loggedBy }}</span>
                        }
                        @case ('duration') {
                          <span class="duration-text">{{ record.duration }}</span>
                          <button class="more-btn" (click)="$event.stopPropagation()">
                            <i class="fas fa-ellipsis-h"></i>
                          </button>
                        }
                        @case ('progress') {
                          <div class="progress-container">
                            <div class="progress-bar">
                              <div class="progress-fill" [style.width.%]="getColumnValue(record, column.key)"></div>
                            </div>
                            <span class="progress-text">{{ formatColumnValue(getColumnValue(record, column.key), column) }}</span>
                          </div>
                        }
                        @default {
                          <span class="column-value" 
                                [title]="getTooltipText(record, column.key)">
                            {{ formatColumnValue(getColumnValue(record, column.key), column) }}
                          </span>
                        }
                      }
                    </div>
                  }
                </div>
              }
            </div>
          </div>
        }
        
        <!-- Scroll Hint -->
        @if (getVisibleColumns().length > 4) {
          <div class="scroll-hint">
            <i class="fas fa-arrows-alt-h"></i>
            Scroll horizontally to see more columns
          </div>
        }
      }
    </div>
  </div>
</div>

<!-- Column Management Modal -->
@if (showColumnModal) {
  <div class="column-modal-overlay" (click)="closeColumnModal()">
    <div class="column-modal-container" (click)="$event.stopPropagation()">
      <!-- Modal Header -->
      <div class="column-modal-header">
        <div class="modal-header-content">
          <h3 class="modal-title">
            <i class="fas fa-columns"></i>
            Manage Table Columns
          </h3>
          <p class="modal-subtitle">Select which columns to display in the logged hours table</p>
        </div>
        <button class="modal-close-btn" (click)="closeColumnModal()">
          <i class="fas fa-times"></i>
        </button>
      </div>

      <!-- Modal Content -->
      <div class="column-modal-content">
        <div class="column-search">
          <div class="search-input-wrapper">
            <i class="fas fa-search search-icon"></i>
            <input type="text" placeholder="Search columns..." class="column-search-input" #searchInput>
          </div>
        </div>

        <div class="columns-list-container">
          <div class="columns-list">
            @for (column of availableColumns; track column.key) {
              <div class="column-item" 
                   [class.visible]="column.visible" 
                   [class.required]="column.required"
                   (click)="toggleColumn(column.key)">
                <div class="column-checkbox">
                  <input type="checkbox" 
                         [checked]="column.visible" 
                         [disabled]="column.required"
                         class="checkbox-input">
                  <div class="checkbox-custom">
                    <i class="fas fa-check"></i>
                  </div>
                </div>
                
                <div class="column-info">
                  <div class="column-name">{{ column.label }}</div>
                  <div class="column-meta">
                    <span class="column-type" [class]="'type-' + column.type">{{ column.type }}</span>
                    @if (column.required) {
                      <span class="required-badge">Required</span>
                    }
                  </div>
                </div>
                
                <div class="column-drag-handle">
                  <i class="fas fa-grip-vertical"></i>
                </div>
              </div>
            }
          </div>
        </div>

        <!-- Column Summary -->
        <div class="column-summary">
          <div class="summary-stats">
            <div class="stat-item">
              <span class="stat-value">{{ getVisibleColumns().length }}</span>
              <span class="stat-label">Visible</span>
            </div>
            <div class="stat-divider"></div>
            <div class="stat-item">
              <span class="stat-value">{{ availableColumns.length - getVisibleColumns().length }}</span>
              <span class="stat-label">Hidden</span>
            </div>
            <div class="stat-divider"></div>
            <div class="stat-item">
              <span class="stat-value">{{ getRequiredColumnsCount() }}</span>
              <span class="stat-label">Required</span>
            </div>
          </div>
        </div>
      </div>

      <!-- Modal Footer -->
      <div class="column-modal-footer">
        <div class="footer-left">
          <button class="reset-btn" (click)="resetColumns()">
            <i class="fas fa-undo"></i>
            Reset to Default
          </button>
        </div>
        <div class="footer-right">
          <button class="cancel-btn" (click)="closeColumnModal()">
            Cancel
          </button>
          <button class="apply-btn" (click)="applyColumnChanges()">
            <i class="fas fa-check"></i>
            Apply Changes
          </button>
        </div>
      </div>
    </div>
  </div>
}

<!-- Task Details Modal -->
@if (showTaskModal) {
  <app-task-details-modal
    [taskId]="selectedTaskId"
    [userId]="currentUserId"
    [categoryId]="selectedTaskCategoryId"
    (closeModal)="closeTaskModal()"
    (taskUpdated)="onTaskUpdated($event)"
    (taskPaused)="onTaskPaused($event)"
    (taskResumed)="onTaskResumed($event)"
    (taskStopped)="onTaskStopped($event)">
  </app-task-details-modal>
}

<!-- Break History Modal - Large Table Design -->
@if (showBreakHistoryModal) {
  <div class="modal-overlay-large" (click)="closeBreakHistoryModal()">
    <div class="break-history-modal-large" (click)="$event.stopPropagation()">
      <!-- Modal Header -->
      <div class="modal-header-large">
        <div class="modal-title-section-large">
          <i class="fas fa-coffee modal-icon-large"></i>
          <div>
            <h2 class="modal-title-large">Break History</h2>
            <p class="modal-subtitle-large">Active break sessions across the organization</p>
          </div>
        </div>
        <button class="close-btn-large" (click)="closeBreakHistoryModal()">
          <i class="fas fa-times"></i>
        </button>
      </div>

      <!-- Modal Body with Table -->
      <div class="modal-body-large">
        <!-- Loading State -->
        @if (isLoadingBreaks) {
          <div class="loading-state-large">
            <i class="fas fa-spinner fa-spin"></i>
            <p>Loading break history...</p>
          </div>
        }

        <!-- Empty State -->
        @if (!isLoadingBreaks && openBreaks.length === 0) {
          <div class="empty-state-large">
            <i class="fas fa-coffee"></i>
            <p>No Active Breaks</p>
            <span>All employees are currently working</span>
          </div>
        }

        <!-- Break History Table -->
        @if (!isLoadingBreaks && openBreaks.length > 0) {
          <div class="break-table-container">
            <table class="break-table">
              <thead>
                <tr>
                  <th class="th-employee">Employee</th>
                  <th class="th-department">Department</th>
                  <th class="th-reason">Break Reason</th>
                  <th class="th-start">Start Time</th>
                  <th class="th-duration">Duration</th>
                  <th class="th-remarks">Remarks</th>
                  <th class="th-status">Status</th>
                </tr>
              </thead>
              <tbody>
                @for (breakRecord of openBreaks; track breakRecord.employeeId) {
                  <tr class="break-row">
                    <td class="td-employee">
                      <div class="employee-cell">
                        <div class="employee-avatar-small">
                          @if (breakRecord.profilePicture) {
                            <img [src]="'data:image/jpeg;base64,' + breakRecord.profilePicture" 
                                 [alt]="breakRecord.employeeName"
                                 class="avatar-img-small">
                          } @else {
                            <div class="avatar-placeholder-small">
                              {{ getInitials(breakRecord.employeeName) }}
                            </div>
                          }
                        </div>
                        <div class="employee-info-small">
                          <span class="employee-name-small">{{ breakRecord.employeeName }}</span>
                          <span class="employee-id-small">{{ breakRecord.employeeId }}</span>
                        </div>
                      </div>
                    </td>
                    <td class="td-department">
                      <div class="department-cell">
                        <span class="department-name">{{ breakRecord.department }}</span>
                        <span class="designation-name">{{ breakRecord.designation }}</span>
                      </div>
                    </td>
                    <td class="td-reason">
                      <span class="break-reason-badge">
                        <i class="fas fa-mug-hot"></i>
                        {{ breakRecord.breakReason }}
                      </span>
                    </td>
                    <td class="td-start">
                      <span class="start-time">{{ formatBreakTime(breakRecord.breakStartTime) }}</span>
                    </td>
                    <td class="td-duration">
                      <span class="duration-badge">
                        <i class="fas fa-clock"></i>
                        {{ formatDuration(breakRecord.breakDurationMinutes) }}
                      </span>
                    </td>
                    <td class="td-remarks">
                      @if (breakRecord.remarks) {
                        <span class="remarks-text">{{ breakRecord.remarks }}</span>
                      } @else {
                        <span class="no-remarks">â€”</span>
                      }
                    </td>
                    <td class="td-status">
                      <span class="status-badge-active">
                        <i class="fas fa-circle pulse-dot"></i>
                        On Break
                      </span>
                    </td>
                  </tr>
                }
              </tbody>
            </table>
          </div>
        }
      </div>

      <!-- Modal Footer -->
      <div class="modal-footer-large">
        <div class="footer-info">
          <i class="fas fa-info-circle"></i>
          <span>Showing {{ openBreaks.length }} active break(s)</span>
        </div>
        <div class="footer-actions">
          <button class="btn-secondary-large" (click)="closeBreakHistoryModal()">
            <i class="fas fa-times"></i>
            Close
          </button>
          <button class="btn-primary-large" (click)="refreshBreakHistory()">
            <i class="fas fa-sync-alt"></i>
            Refresh
          </button>
        </div>
      </div>
    </div>
  </div>
}


<!-- Manage Fields Modal - Modern Clean Design -->
@if (showManageFieldsModal) {
  <div class="modal-overlay-fields" (click)="closeManageFieldsModal()">
    <div class="manage-fields-modal-ultra" (click)="$event.stopPropagation()">
      <!-- Modal Header -->
      <div class="fields-modal-header">
        <div class="header-content">
          <h2 class="modal-title-ultra">Manage Custom Fields</h2>
          <p class="modal-subtitle-ultra">Configure and manage your custom field attributes</p>
        </div>
        <div class="header-actions-ultra">
          <button class="btn-add-new-field" (click)="openAddFieldModal()">
            <i class="fas fa-plus-circle"></i>
            <span>Add New Field</span>
          </button>
          <button class="close-btn-ultra" (click)="closeManageFieldsModal()">
            <i class="fas fa-times"></i>
          </button>
        </div>
      </div>

      <!-- Modal Body -->
      <div class="fields-modal-body">
        <!-- Loading State -->
        @if (isLoadingFields) {
          <div class="loading-state-ultra">
            <div class="spinner-ultra"></div>
            <p>Loading fields...</p>
          </div>
        }

        <!-- Empty State -->
        @if (!isLoadingFields && customFields.length === 0) {
          <div class="empty-state-ultra">
            <div class="empty-icon-ultra">
              <i class="fas fa-inbox"></i>
            </div>
            <h3>No Custom Fields Yet</h3>
            <p>Get started by adding your first custom field</p>
            <button class="btn-primary-ultra" (click)="openAddFieldModal()">
              <i class="fas fa-plus-circle"></i>
              Add Your First Field
            </button>
          </div>
        }

        <!-- Fields Table -->
        @if (!isLoadingFields && customFields.length > 0) {
          <div class="fields-table-ultra">
            <table>
              <thead>
                <tr>
                  <th class="col-name">FIELD NAME</th>
                  <th class="col-type">TYPE</th>
                  <th class="col-active">ACTIVE</th>
                  <th class="col-mandatory">MANDATORY</th>
                  <th class="col-actions">ACTION</th>
                </tr>
              </thead>
              <tbody>
                @for (field of customFields; track field.fieldId) {
                  <tr class="field-row-ultra">
                    <td class="col-name">
                      <div class="field-name-wrapper">
                        <span class="field-name-main">{{ field.fieldName }}</span>
                      </div>
                    </td>
                    <td class="col-type">
                      <span class="type-badge-ultra" [class]="'type-' + field.fieldType.toLowerCase()">
                        {{ field.fieldType }}
                      </span>
                    </td>
                    <td class="col-active">
                      <label class="switch-ultra">
                        <input type="checkbox" [checked]="field.isActive === true" disabled>
                        <span class="slider-ultra"></span>
                      </label>
                    </td>
                    <td class="col-mandatory">
                      <label class="switch-ultra">
                        <input type="checkbox" [checked]="field.isMandatory === true" disabled>
                        <span class="slider-ultra"></span>
                      </label>
                    </td>
                    <td class="col-actions">
                      <div class="action-btns-ultra">
                        <button class="btn-icon-ultra btn-edit" (click)="editFieldInModal(field)" title="Edit">
                          <i class="fas fa-pencil-alt"></i>
                        </button>
                      </div>
                    </td>
                  </tr>
                }
              </tbody>
            </table>
          </div>

          <!-- Pagination -->
          <div class="pagination-ultra">
            <span class="pagination-info">Showing 1 to {{ customFields.length }} of {{ customFields.length }} fields</span>
            <div class="pagination-btns">
              <button class="page-btn-ultra" disabled>
                <i class="fas fa-chevron-left"></i>
              </button>
              <button class="page-btn-ultra active">1</button>
              <button class="page-btn-ultra">2</button>
              <button class="page-btn-ultra">3</button>
              <button class="page-btn-ultra">
                <i class="fas fa-chevron-right"></i>
              </button>
            </div>
          </div>
        }
      </div>
    </div>
  </div>
}

<!-- Add/Edit Field Modal - Separate Modal -->
@if (showAddFieldModal) {
  <div class="modal-overlay-add-field" (click)="closeAddFieldModal()">
    <div class="add-field-modal-ultra" (click)="$event.stopPropagation()">
      <!-- Modal Header -->
      <div class="add-field-header">
        <div>
          <h2 class="add-field-title">{{ editingField ? 'Edit' : 'Add' }} Custom Field</h2>
          <p class="add-field-subtitle">Configure a new attribute for your data.</p>
        </div>
        <button class="close-btn-circle" (click)="closeAddFieldModal()">
          <i class="fas fa-times"></i>
        </button>
      </div>

      <!-- Modal Body -->
      <div class="add-field-body">
        <!-- Field Name -->
        <div class="form-field-ultra">
          <label class="field-label-ultra">Field Name</label>
          <input 
            type="text" 
            class="field-input-ultra" 
            [(ngModel)]="currentField.fieldName"
            placeholder="Priority Level"
            maxlength="50">
          <small class="field-hint-ultra">This name will be displayed in the project forms.</small>
        </div>

        <!-- Field Type Selector -->
        <div class="form-field-ultra">
          <label class="field-label-ultra">Field Type</label>
          <div class="type-selector-ultra">
            <button 
              type="button"
              class="type-btn-ultra" 
              [class.active]="currentField.fieldType === 'Text'"
              [disabled]="editingField"
              (click)="!editingField && (currentField.fieldType = 'Text')">
              <i class="fas fa-align-left"></i>
              <span>TEXT</span>
            </button>
            <button 
              type="button"
              class="type-btn-ultra" 
              [class.active]="currentField.fieldType === 'Number'"
              [disabled]="editingField"
              (click)="!editingField && (currentField.fieldType = 'Number')">
              <i class="fas fa-hashtag"></i>
              <span>NUMBER</span>
            </button>
            <button 
              type="button"
              class="type-btn-ultra" 
              [class.active]="currentField.fieldType === 'Dropdown'"
              [disabled]="editingField"
              (click)="!editingField && (currentField.fieldType = 'Dropdown')">
              <i class="fas fa-list"></i>
              <span>DROPDOWN</span>
            </button>
            <button 
              type="button"
              class="type-btn-ultra" 
              [class.active]="currentField.fieldType === 'Date'"
              [disabled]="editingField"
              (click)="!editingField && (currentField.fieldType = 'Date')">
              <i class="fas fa-calendar"></i>
              <span>DATE</span>
            </button>
          </div>
        </div>

        <!-- Active Toggle -->
        <div class="form-field-ultra toggle-field">
          <div class="toggle-info">
            <span class="toggle-title">Active</span>
            <small class="toggle-desc">Enable or disable this field.</small>
          </div>
          <label class="switch-ultra-large">
            <input type="checkbox" [(ngModel)]="currentField.isActive">
            <span class="slider-ultra-large"></span>
          </label>
        </div>

        <!-- Mandatory Toggle -->
        <div class="form-field-ultra toggle-field">
          <div class="toggle-info">
            <span class="toggle-title">Mandatory</span>
            <small class="toggle-desc">Users must fill this field to save.</small>
          </div>
          <label class="switch-ultra-large">
            <input type="checkbox" [(ngModel)]="currentField.isMandatory">
            <span class="slider-ultra-large"></span>
          </label>
        </div>

        <!-- Dropdown Options (only if Dropdown type) -->
        @if (currentField.fieldType === 'Dropdown') {
          <div class="form-field-ultra">
            <label class="field-label-ultra">Dropdown Options <span class="options-count">{{ getOptionsCount() }} Options</span></label>
            
            <!-- Options List -->
            <div class="options-list-ultra">
              @for (option of currentFieldOptions; track $index; let i = $index) {
                <div class="option-item-ultra">
                  <i class="fas fa-grip-vertical drag-handle"></i>
                  <input 
                    type="text" 
                    class="option-input-ultra" 
                    [(ngModel)]="option.optionValue"
                    placeholder="Option name">
                  <label class="option-checkbox-container">
                    <input 
                      type="checkbox" 
                      [(ngModel)]="option.isActive"
                      class="option-checkbox">
                    <span class="option-checkbox-label">Active</span>
                  </label>
                </div>
              }
            </div>

            <!-- Add Option Button -->
            <button type="button" class="btn-add-option-ultra" (click)="addOption()">
              <i class="fas fa-plus-circle"></i>
              Add Option
            </button>
          </div>
        }
      </div>

      <!-- Modal Footer -->
      <div class="add-field-footer">
        <button type="button" class="btn-cancel-ultra" (click)="closeAddFieldModal()">
          Cancel
        </button>
        <button 
          type="button"
          class="btn-save-ultra" 
          (click)="saveCurrentField()" 
          [disabled]="!isCurrentFieldValid()">
          <i class="fas fa-check"></i>
          Save Changes
        </button>
      </div>
    </div>
  </div>
}
