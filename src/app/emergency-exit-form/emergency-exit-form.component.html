<div class="emergency-exit-container" [@slideInUp]="'in'">


  <!-- Header -->
  <div class="form-header">
    <div class="header-content">
      <div class="company-branding">

        <div class="form-title-section">
          <div class="title-with-icon">
            <div class="animated-icon" [ngClass]="formType === 'E' ? 'emergency-icon' : 'planned-icon'">
              <i class="fas" [ngClass]="formType === 'E' ? 'fa-exclamation-triangle' : 'fa-calendar-check'"></i>
            </div>
            <div class="title-text">
              <h1>{{ getFormHeaderTitle() }}</h1>
              <p>Digital approval workflow system</p>
            </div>
          </div>
        </div>
      </div>
      <div class="form-status" *ngIf="!formSubmitted">
        <div class="status-badge" [ngClass]="'status-' + getAllApprovalStatus()">
          {{ getAllApprovalStatus() | titlecase }}
        </div>
      </div>
    </div>
  </div>

  <!-- Progress Stepper -->
  <div class="stepper-container" *ngIf="!formSubmitted">
    <div class="stepper">
      <ng-container *ngFor="let step of [1,2,3,4]; let i = index">
        <div class="step" *ngIf="shouldShowStep(step)" [ngClass]="{
               'active': currentStep === step,
               'completed': currentStep > step,
               'disabled': currentStep < step
             }" (click)="goToStep(step)">
          <div class="step-circle">
            <i class="fas fa-check" *ngIf="currentStep > step"></i>
            <span *ngIf="currentStep <= step">{{ getDisplayStepNumber(step) }}</span>
          </div>
          <div class="step-label">
            <span class="step-title">Step {{ getDisplayStepNumber(step) }}</span>
          </div>
        </div>
      </ng-container>
    </div>
    <div class="step-description">
      <p>{{ getStepDescription() }}</p>
    </div>
  </div>

  <!-- Form Content -->
  <div class="form-content" *ngIf="!formSubmitted">
    <form [formGroup]="exitForm" [@stepTransition]>


      <!-- Step 1: Employee Information -->
      <div class="step-content" *ngIf="currentStep === 1" [@fadeInUp]="'in'">
        <div class="form-section">
          <h3><i class="fas fa-user"></i> Personal Information</h3>
          <div [ngClass]="formType === 'P' ? 'form-grid-planned' : 'form-grid'">
            <!-- Left Column for Personal Info -->
            <div class="form-group">
              <label for="employeeName">Name *</label>
              <input type="text" id="employeeName" formControlName="employeeName"
                [class.error]="isFieldInvalid('employeeName')" placeholder="Enter full name" [disabled]="true">
              <span class="error-message" *ngIf="isFieldInvalid('employeeName')">
                {{ getFieldError('employeeName') }}
              </span>
            </div>

            <div class="form-group">
              <label for="employeeId">ID No. *</label>
              <input type="text" id="employeeId" formControlName="employeeId"
                [class.error]="isFieldInvalid('employeeId')" placeholder="Employee ID" [disabled]="true">
              <span class="error-message" *ngIf="isFieldInvalid('employeeId')">
                {{ getFieldError('employeeId') }}
              </span>
            </div>

            <div class="form-group">
              <label for="department">Department/Site *</label>
              <input type="text" id="department" formControlName="department" placeholder="Department/Site"
                [disabled]="true">
              <span class="error-message" *ngIf="isFieldInvalid('department')">
                {{ getFieldError('department') }}
              </span>

            </div>

            <div class="form-group">
              <label for="hodName">HOD Name *</label>
              <select id="hodName" formControlName="hodName" [class.error]="isFieldInvalid('hodName')">
                <option value="">Select HOD</option>
                @for (hod of hodList; track hod.idValue) {
                <option [value]="hod.idValue">
                  {{ hod.description }}
                </option>
                } @empty {
                <option value="" disabled>Loading HODs...</option>
                }
              </select>
              <span class="error-message" *ngIf="isFieldInvalid('hodName')">
                {{ getFieldError('hodName') }}
              </span>
              <!-- Debug info - remove in production -->
              <!-- <small style="color: #666; font-size: 12px;">
                Emergency Form HOD Count: {{ hodList.length }}
              </small> -->
            </div>

            <!-- Planned Leave Specific Fields -->
            <div class="form-group" *ngIf="formType === 'P'">
              <label>Category *</label>
              <div class="radio-group">
                <label class="radio-label">
                  <input type="radio" formControlName="category" value="Staff">
                  <span class="radio-mark"></span>
                  Staff
                </label>
                <label class="radio-label">
                  <input type="radio" formControlName="category" value="Worker">
                  <span class="radio-mark"></span>
                  Worker
                </label>
              </div>
              <span class="error-message" *ngIf="isFieldInvalid('category')">
                {{ getFieldError('category') }}
              </span>
            </div>

            <!-- Project Manager / Site Incharge Selection (Planned Leave Only) -->
            <div class="form-group" *ngIf="formType === 'P'">
              <label for="projectManagerName">Project Manager / Site Incharge *</label>
              <select id="projectManagerName" formControlName="projectManagerName"
                [class.error]="isFieldInvalid('projectManagerName')">
                <option value="">Select Project Manager / Site Incharge</option>
                @for (pm of projectManagerList; track pm.idValue) {
                <option [value]="pm.idValue">
                  {{ pm.description }}
                </option>
                } @empty {
                <option value="" disabled>Loading Project Managers...</option>
                }
              </select>
              <span class="error-message" *ngIf="isFieldInvalid('projectManagerName')">
                {{ getFieldError('projectManagerName') }}
              </span>
            </div>



            <div class="form-group hod-name-group" *ngIf="formType === 'P'">
              <label for="responsibilitiesHandedOverTo">Responsibilities Handed Over To *</label>
              <div class="searchable-dropdown">
                <input type="text" id="responsibilitiesHandedOverTo" formControlName="responsibilitiesHandedOverTo"
                  [class.error]="isFieldInvalid('responsibilitiesHandedOverTo')"
                  placeholder="Search and select employee..." class="dropdown-input" #plannedSearchInput
                  (input)="onPlannedSearchInputChange($event)" (focus)="showPlannedDropdown()"
                  (blur)="hidePlannedDropdown()" autocomplete="off">
                <div class="dropdown-icon">
                  <i class="fas fa-chevron-down"></i>
                </div>
                <div class="dropdown-list planned-dropdown" *ngIf="isPlannedDropdownVisible()"
                  [class.small-list]="shouldUseSmallDropdown(plannedSearchTerm)">
                  <div class="dropdown-item" *ngFor="let employee of getFilteredEmployees(plannedSearchTerm)"
                    (mousedown)="selectPlannedEmployee(employee)"
                    [class.selected]="isPlannedEmployeeSelected(employee)">
                    <div class="employee-info">
                      <div class="employee-name">{{ getEmployeeName(employee.description || '') }}</div>
                      <div class="employee-id">{{ employee.idValue || '' }}</div>
                    </div>
                  </div>
                  <div class="no-results" *ngIf="getFilteredEmployees(plannedSearchTerm).length === 0">
                    No employees found
                  </div>
                </div>
              </div>
              <span class="error-message" *ngIf="isFieldInvalid('responsibilitiesHandedOverTo')">
                {{ getFieldError('responsibilitiesHandedOverTo') }}
              </span>
            </div>

          </div>
        </div>

        <div class="form-section" *ngIf="formType === 'E'">
          <h3><i class="fas fa-address-card"></i> Contact Details</h3>
          <div class="contact-info-note">
            <i class="fas fa-info-circle"></i>
            <span>Contact details are automatically populated from your profile. To update, please modify your profile information.</span>
          </div>
          
          <div class="contact-details-grid">
            <!-- Address Information -->
            <div class="contact-item">
              <label><i class="fas fa-home"></i> Address *</label>
              <div class="contact-value">
                {{ exitForm.get('address')?.value || 'Not provided' }}
              </div>
            </div>

            <!-- Place -->
            <div class="contact-item">
              <label><i class="fas fa-map-marker-alt"></i> Place</label>
              <div class="contact-value">
                {{ exitForm.get('place')?.value || 'Not provided' }}
              </div>
            </div>

            <!-- District -->
            <div class="contact-item">
              <label><i class="fas fa-map"></i> District</label>
              <div class="contact-value">
                {{ exitForm.get('district')?.value || 'Not provided' }}
              </div>
            </div>

            <!-- State -->
            <div class="contact-item">
              <label><i class="fas fa-flag"></i> State</label>
              <div class="contact-value">
                {{ exitForm.get('state')?.value || 'Not provided' }}
              </div>
            </div>

            <!-- Post Office -->
            <div class="contact-item">
              <label><i class="fas fa-mail-bulk"></i> Post Office</label>
              <div class="contact-value">
                {{ exitForm.get('postOffice')?.value || 'Not provided' }}
              </div>
            </div>

            <!-- Nation -->
            <div class="contact-item">
              <label><i class="fas fa-globe"></i> Nation</label>
              <div class="contact-value">
                {{ exitForm.get('nation')?.value || 'Not provided' }}
              </div>
            </div>

            <!-- Mobile Number -->
            <div class="contact-item">
              <label><i class="fas fa-mobile-alt"></i> Telephone No (Mobile) *</label>
              <div class="contact-value">
                {{ exitForm.get('telephoneMobile')?.value || 'Not provided' }}
              </div>
            </div>

            <!-- Landline Number -->
            <div class="contact-item">
              <label><i class="fas fa-phone"></i> Telephone No (Landline)</label>
              <div class="contact-value">
                {{ exitForm.get('telephoneLandline')?.value || 'Not provided' }}
              </div>
            </div>

            <!-- Email Address -->
            <div class="contact-item">
              <label><i class="fas fa-envelope"></i> Email ID *</label>
              <div class="contact-value">
                {{ exitForm.get('emailId')?.value || 'Not provided' }}
              </div>
            </div>
          </div>

          <!-- Hidden form controls to maintain form structure -->
          <div style="display: none;">
            <textarea formControlName="address"></textarea>
            <input formControlName="district">
            <input formControlName="telephoneMobile">
            <input formControlName="place">
            <input formControlName="state">
            <input formControlName="telephoneLandline">
            <input formControlName="postOffice">
            <input formControlName="nation">
            <input formControlName="emailId">
          </div>
        </div>

        <div class="form-section travel-section">
          <h3><i class="fas fa-plane"></i> Travel Information</h3>
          <div class="travel-grid">
            <div class="form-group">
              <label for="dateOfDeparture">Date of Departure *</label>
              <input type="date" id="dateOfDeparture" formControlName="dateOfDeparture"
                [class.error]="isFieldInvalid('dateOfDeparture')">
              <span class="error-message" *ngIf="isFieldInvalid('dateOfDeparture')">
                {{ getFieldError('dateOfDeparture') }}
              </span>
            </div>

            <div class="form-group">
              <label for="dateOfArrival">Date of Arrival</label>
              <input type="date" id="dateOfArrival" formControlName="dateOfArrival">
            </div>

            <div class="form-group">
              <label for="noOfDaysApproved">No. of Days Requested *</label>
              <input type="number" id="noOfDaysApproved" formControlName="noOfDaysApproved"
                [class.error]="isFieldInvalid('noOfDaysApproved')" min="1" placeholder="Number of days">
              <span class="error-message" *ngIf="isFieldInvalid('noOfDaysApproved')">
                {{ getFieldError('noOfDaysApproved') }}
              </span>
            </div>

            <div class="form-group">
              <label for="flightTime">Flight Time</label>
              <input type="time" id="flightTime" formControlName="flightTime">
            </div>
          </div>
        </div>

        <div class="form-section">
          <h3>
            <i class="fas fa-exclamation-triangle" *ngIf="formType === 'E'"></i>
            <i class="fas fa-clipboard-list" *ngIf="formType === 'P'"></i>
            {{ formType === 'E' ? 'Emergency Details' : 'Leave Details' }}
          </h3>
          <div class="form-group full-width">
            <label for="reasonForEmergency">
              {{ formType === 'E' ? 'Reason for the Emergency *' : 'Reason for Planned Leave *' }}
            </label>
            <textarea id="reasonForEmergency" formControlName="reasonForEmergency"
              [class.error]="isFieldInvalid('reasonForEmergency')" rows="4"
              [placeholder]="formType === 'E' ? 'Please provide detailed reason for emergency leave' : 'Please provide detailed reason for planned leave'"></textarea>
            <span class="error-message" *ngIf="isFieldInvalid('reasonForEmergency')">
              {{ getFieldError('reasonForEmergency') }}
            </span>
          </div>

          <!-- Responsibilities Handed Over To (Planned Leave Only) -->
          <!-- <div class="form-group full-width" *ngIf="formType === 'P'">
            <label for="responsibilitiesHandedOverTo">Responsibilities Handed Over To *</label>
            <input type="text" id="responsibilitiesHandedOverTo" formControlName="responsibilitiesHandedOverTo"
              [class.error]="isFieldInvalid('responsibilitiesHandedOverTo')"
              placeholder="Enter name of person taking over responsibilities">
            <span class="error-message" *ngIf="isFieldInvalid('responsibilitiesHandedOverTo')">
              {{ getFieldError('responsibilitiesHandedOverTo') }}
            </span>
          </div> -->
        </div>
      </div>

      <!-- Step 2: Responsibility Handover (Emergency Only) -->
      <div class="step-content" *ngIf="currentStep === 2 && formType === 'E'" [@fadeInUp]="'in'">
        <div class="form-section">
          <div class="section-header">
            <h3><i class="fas fa-handshake"></i> Responsibilities Handed Over To</h3>
            <button type="button" class="btn-add" (click)="addResponsibility()">
              <i class="fas fa-plus"></i> Add Responsibility
            </button>
          </div>

          <div class="responsibilities-container" formArrayName="responsibilities">
            <div class="responsibility-card"
              *ngFor="let responsibility of responsibilitiesFormArray.controls; let i = index" [formGroupName]="i">

              <div class="card-header">
                <h4>Responsibility {{ i + 1 }}</h4>
                <button type="button" class="btn-remove" (click)="removeResponsibility(i)"
                  *ngIf="responsibilitiesFormArray.length > 1">
                  <i class="fas fa-trash"></i>
                </button>
              </div>

              <div class="responsibility-form-grid">
                <div class="form-group project-field">
                  <label>Project *</label>
                  <input type="text" formControlName="project" placeholder="Enter project name">
                </div>

                <div class="form-group activities-field">
                  <label>Activities *</label>
                  <textarea formControlName="activities" rows="4"
                    placeholder="Describe the activities and responsibilities being handed over"></textarea>
                </div>

                <div class="form-group name-field">
                  <label>Responsible Person Name *</label>
                  <div class="searchable-dropdown">
                    <input type="text" formControlName="responsiblePersonName"
                      placeholder="Search and select employee..." class="dropdown-input" #searchInput
                      (input)="onSearchInputChange($event, i)" (focus)="showDropdown(i)" (blur)="hideDropdown(i)"
                      autocomplete="off">
                    <div class="dropdown-icon">
                      <i class="fas fa-chevron-down"></i>
                    </div>
                    <div class="dropdown-list" *ngIf="isDropdownVisible(i)" [attr.data-index]="i"
                      [class.small-list]="shouldUseSmallDropdown(getSearchTerm(i))">
                      <div class="dropdown-item" *ngFor="let employee of getFilteredEmployees(getSearchTerm(i))"
                        (mousedown)="selectEmployee(i, employee)" [class.selected]="isEmployeeSelected(i, employee)">
                        <div class="employee-info">
                          <div class="employee-name">{{ getEmployeeName(employee.description || '') }}</div>
                          <div class="employee-id">{{ employee.idValue || '' }}</div>
                        </div>
                      </div>
                      <div class="no-results" *ngIf="getFilteredEmployees(getSearchTerm(i)).length === 0">
                        No employees found
                      </div>
                    </div>
                  </div>
                </div>

                <div class="form-group phone-field">
                  <label>Phone Number *</label>
                  <input type="tel" formControlName="responsiblePersonPhone" placeholder="Contact phone number">
                </div>

                <div class="form-group email-field">
                  <label>Email ID *</label>
                  <input type="email" formControlName="responsiblePersonEmail" placeholder="Email address">
                </div>

                <div class="form-group remarks-field">
                  <label>Remarks</label>
                  <textarea formControlName="remarks" rows="3"
                    placeholder="Any additional remarks or special instructions"></textarea>
                </div>
              </div>


            </div>
          </div>
        </div>
      </div>

      <!-- Step 3: Final Review (Emergency) / Approval Workflow (Planned) -->
      <div class="step-content" *ngIf="currentStep === 3" [@fadeInUp]="'in'">
        <!-- For Emergency: Show Final Review -->
        <div class="form-section" *ngIf="formType === 'E'">
          <h3><i class="fas fa-eye"></i> Final Review & Submission</h3>

          <div class="review-summary">
            <div class="summary-card">
              <h4>Employee Information</h4>
              <div class="summary-grid">
                <div><strong>Name:</strong> {{ exitForm.get('employeeName')?.value }}</div>
                <div><strong>ID:</strong> {{ exitForm.get('employeeId')?.value }}</div>
                <div><strong>Department:</strong> {{ exitForm.get('department')?.value }}</div>
                <div><strong>Departure Date:</strong> {{ exitForm.get('dateOfDeparture')?.value | date }}</div>
                <div><strong>Days Approved:</strong> {{ exitForm.get('noOfDaysApproved')?.value }}</div>
                <div><strong>Email:</strong> {{ exitForm.get('emailId')?.value }}</div>
              </div>
            </div>

            <div class="summary-card">
              <h4>Responsibilities</h4>
              <div class="responsibilities-summary">
                <div *ngFor="let resp of responsibilitiesFormArray.controls; let i = index"
                  class="responsibility-summary">
                  <strong>{{ i + 1 }}. {{ resp.get('project')?.value }}</strong>
                  <p>Handed over to: {{ resp.get('responsiblePersonName')?.value }}</p>
                </div>
              </div>
            </div>
          </div>

          <div class="declarations">
            <h4>Declarations</h4>
            <div class="declaration-list">
              <label class="checkbox-label">
                <input type="checkbox" formControlName="decInfoAccurate">
                <span class="checkmark"></span>
                I confirm that all information provided is accurate and complete
              </label>

              <label class="checkbox-label">
                <input type="checkbox" formControlName="decHandoverComplete">
                <span class="checkmark"></span>
                I have handed over all my responsibilities to the designated personnel
              </label>
              <label class="checkbox-label">
                <input type="checkbox" formControlName="decReturnAssets">
                <span class="checkmark"></span>
                I will return all company assets (laptop, phone, keys, etc.) before departure
              </label>
              <label class="checkbox-label">
                <input type="checkbox" formControlName="decUnderstandReturn">
                <span class="checkmark"></span>
                I understand this is an emergency exit and I will return as per the approved dates
              </label>
            </div>

            <div class="declaration-notes">
              <div class="note info">
                <i class="fas fa-info-circle"></i>
                <span>Once submitted, your request will be sent to all approving departments. You will receive email
                  notifications as each department approves your request.</span>
              </div>
              <div class="note success">
                <i class="fas fa-clock"></i>
                <span>Emergency exit requests are typically processed within 2-3 business days. You will be notified of
                  the final decision via email.</span>
              </div>
            </div>
          </div>
        </div>

        <!-- For Planned Leave: Show Final Review -->
        <div class="form-section" *ngIf="formType === 'P'">
          <h3><i class="fas fa-eye"></i> Final Review & Submission</h3>

          <div class="review-summary">
            <div class="summary-card">
              <h4>Employee Information</h4>
              <div class="summary-grid">
                <div><strong>Name:</strong> {{ exitForm.get('employeeName')?.value }}</div>
                <div><strong>ID:</strong> {{ exitForm.get('employeeId')?.value }}</div>
                <div><strong>Department:</strong> {{ exitForm.get('department')?.value }}</div>
                <div><strong>Category:</strong> {{ exitForm.get('category')?.value }}</div>
                <div><strong>Departure Date:</strong> {{ exitForm.get('dateOfDeparture')?.value | date }}</div>
                <div><strong>Days Requested:</strong> {{ exitForm.get('noOfDaysApproved')?.value }}</div>
                <div><strong>Responsibilities Handed Over To:</strong> {{
                  exitForm.get('responsibilitiesHandedOverTo')?.value }}</div>
              </div>
            </div>
          </div>

          <div class="declarations">
            <h4>Declarations</h4>
            <div class="declaration-list">
              <label class="checkbox-label">
                <input type="checkbox" formControlName="decInfoAccurate">
                <span class="checkmark"></span>
                I confirm that all information provided is accurate and complete
              </label>

              <label class="checkbox-label">
                <input type="checkbox" formControlName="decHandoverComplete">
                <span class="checkmark"></span>
                I have properly handed over my responsibilities to {{
                exitForm.get('responsibilitiesHandedOverTo')?.value ||
                'the designated person' }}
              </label>
              <label class="checkbox-label">
                <input type="checkbox" formControlName="decReturnAssets">
                <span class="checkmark"></span>
                I will return all company assets (laptop, phone, keys, etc.) before my planned departure
              </label>
              <label class="checkbox-label">
                <input type="checkbox" formControlName="decUnderstandReturn">
                <span class="checkmark"></span>
                I understand this is a planned leave and I will return as per the approved schedule
              </label>
            </div>

            <div class="declaration-notes">
              <div class="note info">
                <i class="fas fa-info-circle"></i>
                <span>Once submitted, your request will be sent to all approving departments. You will receive email
                  notifications as each department approves your request.</span>
              </div>
              <div class="note success">
                <i class="fas fa-calendar-check"></i>
                <span>Planned leave requests are typically processed within 5-7 business days. You will be notified of
                  the final decision via email.</span>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Step 4: Department Approvals (Post-Submission) -->
      <div class="step-content" *ngIf="currentStep === 4" [@fadeInUp]="'in'">
        <div class="form-section">
          <h3><i class="fas fa-clipboard-check"></i> Approval From Concerned Departments</h3>



          <div class="approval-progress">
            <div class="progress-header">
              <span>Overall Progress</span>
              <span>{{ getProgressPercentage() | number:'1.0-0' }}%</span>
            </div>
            <div class="progress-bar">
              <div class="progress-fill" [style.width.%]="getProgressPercentage()"></div>
            </div>
          </div>

          <div class="departments-grid">
            <!-- Project Manager Approval Card (Planned Leave Only) -->
            <div class="department-card pm-approval-card" *ngIf="formType === 'P'" [ngClass]="'status-pending'">

              <div class="dept-header">
                <h4>Project Manager / Site Incharge Approval</h4>
                <div class="status-indicator status-pending">
                  <i class="fas fa-clock"></i>
                  Pending
                </div>
              </div>

              <div class="pm-approval-actions">
                <div class="pm-approval-form">
                  <div class="approval-inputs">
                    <div class="form-group">
                      <label>Number of Days Allowed *</label>
                      <input type="number" [(ngModel)]="pmDaysAllowed" placeholder="Enter number of days allowed"
                        min="1" required>
                    </div>
                    <div class="form-group">
                      <label>Remarks *</label>
                      <textarea [(ngModel)]="pmRemarks" placeholder="Enter your remarks or comments" rows="4"
                        required></textarea>
                    </div>
                  </div>
                  <div class="approval-buttons">
                    <button type="button" class="btn-approve" (click)="approveProjectManager(true)">
                      <i class="fas fa-check"></i> Approve
                    </button>
                    <button type="button" class="btn-reject" (click)="approveProjectManager(false)">
                      <i class="fas fa-times"></i> Reject
                    </button>
                  </div>
                </div>
              </div>
            </div>

            <!-- HOD and Other Department Approval Cards -->
            <div class="department-card hod-approval-card" *ngFor="let dept of departments; let first = first"
              [ngClass]="'status-' + dept.status" [class.hod-approval]="first">

              <div class="dept-header">
                <h4>{{ dept.name }}</h4>
                <div class="status-indicator" [ngClass]="'status-' + dept.status">
                  <i class="fas fa-clock" *ngIf="dept.status === 'pending'"></i>
                  <i class="fas fa-check" *ngIf="dept.status === 'approved'"></i>
                  <i class="fas fa-times" *ngIf="dept.status === 'rejected'"></i>
                  {{ dept.status | titlecase }}
                </div>
              </div>

              <div class="dept-items">
                <div class="item-row" *ngFor="let item of dept.items">
                  <label>{{ item.label }}</label>
                  <div class="item-input">
                    <input *ngIf="item.type === 'text'" type="text"
                      [value]="getDepartmentItemValue(dept.id, item.label)"
                      (input)="updateDepartmentItem(dept.id, item.label, $event)" placeholder="Enter value">

                    <input *ngIf="item.type === 'number'" type="number"
                      [value]="getDepartmentItemValue(dept.id, item.label)"
                      (input)="updateDepartmentItem(dept.id, item.label, $event)" placeholder="0">

                    <label *ngIf="item.type === 'checkbox'" class="checkbox-label">
                      <input type="checkbox" [checked]="getDepartmentItemValue(dept.id, item.label)"
                        (change)="updateDepartmentItem(dept.id, item.label, $event)">
                      <span class="checkmark"></span>
                    </label>
                  </div>
                </div>
              </div>

              <div class="dept-approval" *ngIf="dept.status !== 'pending'">
                <div class="approval-info">
                  <p><strong>HOD:</strong> {{ dept.hodName || 'System Admin' }}</p>
                  <p><strong>Date:</strong> {{ dept.approvedDate | date:'short' }}</p>
                  <p *ngIf="dept.comments"><strong>Comments:</strong> {{ dept.comments }}</p>
                </div>
              </div>

              <!-- HOD Approval Actions -->
              <div class="hod-approval-actions" *ngIf="dept.id === 0 && dept.status === 'pending'">
                <div class="hod-approval-form">
                  <div class="approval-inputs">
                    <div class="form-group">
                      <label>Number of Days Allowed *</label>
                      <input type="number" [(ngModel)]="hodDaysAllowed" placeholder="Enter number of days allowed"
                        min="1" required>
                    </div>
                    <div class="form-group">
                      <label>Remarks *</label>
                      <textarea [(ngModel)]="hodRemarks" placeholder="Enter your remarks or comments" rows="4"
                        required></textarea>
                    </div>
                  </div>
                  <div class="approval-buttons">
                    <button type="button" class="btn-approve" (click)="approveHOD(true)">
                      <i class="fas fa-check"></i> Approve
                    </button>
                    <button type="button" class="btn-reject" (click)="approveHOD(false)">
                      <i class="fas fa-times"></i> Reject
                    </button>
                  </div>
                </div>
              </div>

              <!-- Demo approval buttons for other departments -->
              <div class="demo-approval-actions" *ngIf="dept.id !== 0 && dept.status === 'pending'">
                <button type="button" class="btn-approve" (click)="approveDepartment(dept.id, true, 'Approved by HOD')">
                  <i class="fas fa-check"></i> Approve
                </button>
                <button type="button" class="btn-reject" (click)="approveDepartment(dept.id, false, 'Rejected by HOD')">
                  <i class="fas fa-times"></i> Reject
                </button>
              </div>
            </div>
          </div>



          <div class="final-actions" *ngIf="getAllApprovalStatus() === 'approved'">
            <div class="success-notice">
              <i class="fas fa-check-circle"></i>
              <span>All approvals completed! Your {{ formType === 'E' ? 'emergency exit' : 'planned leave' }} request
                has been fully approved.</span>
            </div>
            <div class="action-buttons">
              <button type="button" class="btn-primary" (click)="downloadPDF()">
                <i class="fas fa-download"></i> Download Approved Form
              </button>
              <button type="button" class="btn-secondary" (click)="resetForm()">
                <i class="fas fa-plus"></i> New Request
              </button>
            </div>
          </div>
        </div>
      </div>
    </form>

    <!-- Form Navigation -->
    <div class="form-navigation" *ngIf="!formSubmitted">
      <button type="button" class="btn-secondary" (click)="previousStep()" [disabled]="currentStep === 1">
        <i class="fas fa-arrow-left"></i> Previous
      </button>

      <div class="step-indicator">
        Step {{ getDisplayStepNumber(currentStep) }} of {{ getTotalDisplaySteps() }}
      </div>

      <button type="button" class="btn-primary" (click)="nextStep()" *ngIf="shouldShowNextButton()">
        Next <i class="fas fa-arrow-right"></i>
      </button>

      <button type="button" class="btn-submit" (click)="submitForm()"
        [disabled]="!allDeclarationsChecked() || isSubmitting" *ngIf="currentStep === 3">
        <i class="fas fa-spinner fa-spin" *ngIf="isSubmitting"></i>
        <i class="fas fa-paper-plane" *ngIf="!isSubmitting"></i>
        {{ isSubmitting ? 'Submitting...' : 'Submit Form' }}
      </button>

      <button type="button" class="btn-primary" (click)="downloadPDF()"
        *ngIf="currentStep === 4 && getAllApprovalStatus() === 'approved'">
        <i class="fas fa-download"></i> Download Approved Form
      </button>
    </div>

    <!-- Success Message -->
    <div class="success-container" *ngIf="formSubmitted" [@fadeInUp]="'in'">
      <div class="success-card">
        <div class="success-icon">
          <i class="fas fa-check-circle"></i>
        </div>
        <h2>Form Submitted Successfully!</h2>
        <p>Your {{ formType === 'E' ? 'emergency exit' : 'planned leave' }} form has been submitted and is now being
          processed.</p>
        <p><strong>Reference ID:</strong> {{ formType === 'E' ? 'EEF' : 'PLF' }}-{{ getCurrentTimestamp() }}</p>

        <div class="success-actions">
          <button type="button" class="btn-primary" (click)="downloadPDF()">
            <i class="fas fa-download"></i> Download PDF
          </button>
          <button type="button" class="btn-secondary" (click)="resetForm()">
            <i class="fas fa-plus"></i> New Form
          </button>
        </div>
      </div>
    </div>