<!-- Toaster Component -->
<app-toaster></app-toaster>

<div class="task-board-container" [class.dark-mode]="isDarkMode">
  <!-- Top Section with Active Task and Stats -->
  <div class="top-section">
    <!-- Active Task Card -->
    <div class="active-task-card reduced-width">
      <!-- Empty State -->
      <div class="empty-task-state" *ngIf="!hasActiveTask">
        <div class="empty-icon">
          <i class="fas fa-tasks"></i>
        </div>
        <h3 class="empty-title">No Active Task</h3>
        <p class="empty-message">Start working on a task to track your progress and time</p>
        <button class="start-task-btn" (click)="openCreateTaskModal()">
          <i class="fas fa-play-circle"></i>
          <span>Start a Task</span>
        </button>
      </div>

      <!-- Active Task Content -->
      <div *ngIf="hasActiveTask">
      <div class="task-status">
        <div class="status-indicator">
          <div class="status-dot"></div>
          <span class="status-text">{{ activeTask?.status || 'NO STATUS' }}</span>
        </div>

        <!-- Ultra Modern Timer Control Section -->
        <div class="timer-control-section">
          <!-- Animated Bars -->
          <div class="timer-bars">
            <span class="bar bar-1"></span>
            <span class="bar bar-2"></span>
            <span class="bar bar-3"></span>
            <span class="bar bar-4"></span>
          </div>

          <!-- Timer Display -->
          <div class="timer-box">
            <div class="timer-glow-bg"></div>
            <div class="timer-digits">
              <span class="digit-group">
                <span class="digit">{{ getActiveTaskTimer().substring(0, 1) }}</span>
                <span class="digit">{{ getActiveTaskTimer().substring(1, 2) }}</span>
              </span>
              <span class="separator">:</span>
              <span class="digit-group">
                <span class="digit">{{ getActiveTaskTimer().substring(3, 4) }}</span>
                <span class="digit">{{ getActiveTaskTimer().substring(4, 5) }}</span>
              </span>
              <span class="separator">:</span>
              <span class="digit-group">
                <span class="digit">{{ getActiveTaskTimer().substring(6, 7) }}</span>
                <span class="digit">{{ getActiveTaskTimer().substring(7, 8) }}</span>
              </span>
            </div>
            <div class="timer-label-modern">TIME ELAPSED</div>
          </div>

          <!-- Modern Control Buttons -->
          <div class="modern-controls">
            <button class="modern-control-btn pause-btn" 
                    *ngIf="activeTask?.status === 'RUNNING'" 
                    (click)="pauseActiveTask()">
              <div class="btn-glow"></div>
              <i class="fas fa-pause"></i>
              <span class="btn-label">Pause</span>
            </button>
            <button class="modern-control-btn resume-btn" 
                    *ngIf="activeTask?.status === 'PAUSED'" 
                    (click)="resumeActiveTask()">
              <div class="btn-glow"></div>
              <i class="fas fa-play"></i>
              <span class="btn-label">Resume</span>
            </button>
            <button class="modern-control-btn stop-btn" 
                    (click)="stopActiveTask()">
              <div class="btn-glow"></div>
              <i class="fas fa-stop"></i>
              <span class="btn-label">Stop</span>
            </button>
          </div>

          <!-- Animated Wave -->
          <div class="timer-wave">
            <svg viewBox="0 0 40 40" class="wave-svg">
              <circle class="wave-circle wave-1" cx="20" cy="20" r="8" />
              <circle class="wave-circle wave-2" cx="20" cy="20" r="8" />
              <circle class="wave-circle wave-3" cx="20" cy="20" r="8" />
            </svg>
          </div>
        </div>
      </div>

      <div class="task-info">
        <div class="task-header">
          <span class="category-badge" [class]="getCategoryClass(activeTask?.category || '')">
            {{ activeTask?.category || 'NO CATEGORY' }}
          </span>
          <h2 class="task-title">{{ activeTask?.title || 'No Task Selected' }}</h2>
        </div>

        <!-- Modern Animated Progress Section -->
        <div class="modern-progress-section">
          <div class="progress-info">
            <span class="progress-label">Task Completion</span>
            <span class="progress-value">{{ activeTask?.progress || 0 }}%</span>
          </div>
          <div class="animated-progress-bar">
            <div class="progress-track">
              <div class="progress-fill" [style.width.%]="activeTask?.progress || 0">
                <div class="progress-shimmer"></div>
                <div class="progress-glow"></div>
              </div>
            </div>
            <div class="progress-particles">
              <span class="particle"></span>
              <span class="particle"></span>
              <span class="particle"></span>
              <span class="particle"></span>
              <span class="particle"></span>
            </div>
          </div>
        </div>

        <div class="task-meta">
          <div class="task-details">
            <div class="task-detail-item">
              <i class="fas fa-calendar-alt"></i>
              <span>Started: {{ activeTask?.startDate | date:'MMM dd, yyyy' }}</span>
            </div>
            <div class="task-detail-item">
              <i class="fas fa-user"></i>
              <span>Assigned by: {{ activeTask?.assignee || 'N/A' }}</span>
            </div>

          </div>
        </div>
      </div>
      </div>
      <!-- End Active Task Content -->
    </div>

    <!-- Break Tracker Section -->
    <div class="break-tracker-section">
      <div class="break-tracker-card">
        <div class="break-tracker-header">
          <div class="break-tracker-icon">
            <i class="fas fa-mug-hot"></i>
          </div>
          <div class="break-tracker-title">Break Tracker</div>
        </div>

        <!-- Break Type Selection -->
        <div class="break-type-selection">
          <button class="break-type-btn" [class.active]="selectedBreakType === 'lunch'"
            (click)="selectBreakType('lunch')">
            <i class="fas fa-utensils"></i>
            <span>Lunch</span>
          </button>
          <button class="break-type-btn" [class.active]="selectedBreakType === 'coffee'"
            (click)="selectBreakType('coffee')">
            <i class="fas fa-coffee"></i>
            <span>Coffee</span>
          </button>
          <button class="break-type-btn" [class.active]="selectedBreakType === 'quick'"
            (click)="selectBreakType('quick')">
            <i class="fas fa-bolt"></i>
            <span>Quick</span>
          </button>
        </div>

        <!-- Running Timer Display -->
        <div class="break-timer-display">
          <div class="timer-value">{{ breakTimerDisplay }}</div>
          <div class="timer-caption">{{ breakTimerCaption }}</div>
        </div>

        <!-- Remarks Field -->
        <div class="break-remarks">
          <input type="text" class="remarks-input" [(ngModel)]="breakRemarks" placeholder="Add notes (optional)..."
            maxlength="50">
        </div>

        <!-- Control Buttons -->
        <div class="break-controls">
          <button class="break-control-btn start" *ngIf="!isBreakRunning" (click)="startBreak()"
            [disabled]="!selectedBreakType">
            <i class="fas fa-play"></i>
            <span>Start</span>
          </button>
          <button class="break-control-btn stop" *ngIf="isBreakRunning" (click)="stopBreak()">
            <i class="fas fa-stop"></i>
            <span>End</span>
          </button>
        </div>

        <!-- Break Status Caption -->
        <div class="break-status-caption">
          {{ getBreakStatusCaption() }}
        </div>
      </div>
    </div>

    <!-- Right Side Section with New Task Button and Stats -->
    <div class="right-section">
      <!-- New Task Button -->
      <button class="new-task-btn" (click)="openCreateTaskModal()">
        <i class="fas fa-plus"></i>
        New Task
      </button>

      <!-- Stats Cards -->
      <div class="stats-grid">

        <div class="stat-card running-time">
          <div class="stat-header">
            <span class="stat-label">TOTAL DAY LOGGED</span>
            <div class="stat-icon">
              <i class="fas fa-bolt"></i>
            </div>
          </div>
          <div class="stat-value">{{ runningTime }}</div>
          <div class="stat-sublabel">RUNNING TIME</div>
        </div>

        <div class="stat-card punched-hours">
          <div class="stat-header">
            <span class="stat-label">LAST PUNCHED TIME</span>
            <div class="stat-icon">
              <i class="fas fa-clock"></i>
            </div>
          </div>
          <div class="stat-value">{{ lastPunchTime || 'N/A' }}</div>
        </div>

      </div>
    </div>
  </div>

  <!-- Task Tabs and Table -->
  <div class="task-section">
    <div class="task-tabs">
      <div class="tabs-container">
        <button class="tab-btn" [class.active]="activeTab === 'MY TASKS'" (click)="setActiveTab('MY TASKS')">
          MY TASKS ({{ myTasksCount }})
        </button>
        <button class="tab-btn" [class.active]="activeTab === 'ASSIGNED TO OTHERS'"
          (click)="setActiveTab('ASSIGNED TO OTHERS')">
          ASSIGNED TO OTHERS ({{ assignedToOthersCount }})
        </button>
      </div>

      <div class="tab-actions">
        <div class="search-box">
          <i class="fas fa-search"></i>
          <input type="text" placeholder="Filter tasks" [(ngModel)]="searchTerm">
        </div>
      </div>
    </div>

    <!-- Task Table -->
    <div class="task-table">
      <div class="table-header">
        <div class="header-cell category">TASK CATEGORY</div>
        <div class="header-cell title">TASK TITLE</div>
        <div class="header-cell start-date">START DATE</div>
        <div class="header-cell assignee">ASSIGNEE</div>
        <div class="header-cell logged">TODAY LOGGED HOURS</div>
        <div class="header-cell total">TOTAL HOURS</div>
        <div class="header-cell progress">PROGRESS</div>
        <div class="header-cell status">STATUS</div>
        <div class="header-cell action">ACTION</div>
      </div>

      <div class="table-body">
        @for (task of getFilteredTasks(); track task.id) {
        <div class="table-row" (click)="openTaskDetailsModal(task)">
          <div class="cell category">
            <span class="category-badge" [class]="getCategoryClass(task.category)">
              {{ task.category }}
            </span>
          </div>
          <div class="cell title">
            <div class="task-title-cell">
              <h4>{{ task.title }}</h4>
              <p>{{ task.description }}</p>
            </div>
          </div>
          <div class="cell start-date">{{ task.startDate | date:'MMM dd, yyyy' }}</div>
          <div class="cell assignee">
            <div class="assignee-info">
              <div class="assignee-avatar" *ngIf="!task.assigneeImage">{{ task.assignee.charAt(0) }}</div>
              <img *ngIf="task.assigneeImage" [src]="task.assigneeImage" alt="{{ task.assignee }}" class="assignee-avatar" />
              <span>{{ task.assignee }}</span>
            </div>
          </div>
          <div class="cell logged">{{ task.loggedHours }}</div>
          <div class="cell total">{{ task.totalHours }}</div>
          <div class="cell progress">
            <div class="progress-container">
              <div class="progress-bar">
                <div class="progress-fill" [style.width.%]="task.progress"></div>
              </div>
              <span class="progress-text">{{ task.progress }}%</span>
            </div>
          </div>
          <div class="cell status">
            <span class="status-badge" [class]="getStatusClass(task.status)">
              {{ task.status }}
            </span>
          </div>
          <div class="cell action" (click)="$event.stopPropagation()">
            <div class="action-buttons">
              @if (task.status !== 'RUNNING') {
              <button class="action-btn play" (click)="startTask(task.id)" title="Start/Resume Task">
                <i class="fas fa-play"></i>
              </button>
              } @else {
              <button class="action-btn pause" (click)="pauseTask(task.id)" title="Pause Task">
                <i class="fas fa-pause"></i>
              </button>
              }
              <button class="action-btn stop" (click)="openTaskDetailsModal(task)" title="View Task Details">
                <i class="fas fa-stop"></i>
              </button>
              @if (task.status === 'NOT STARTED') {
              <button class="action-btn delete" (click)="deleteTask(task.id)" title="Delete Task">
                <i class="fas fa-trash"></i>
              </button>
              }
            </div>
          </div>
        </div>
        }
      </div>
    </div>

    <!-- Pagination -->
    <div class="pagination">
      <span class="pagination-info">Showing {{ currentPageTasks }} of {{ totalTasks }} active tasks</span>
      <div class="pagination-controls">
        <button class="pagination-btn" [disabled]="currentPage === 1">PREVIOUS</button>
        <button class="pagination-btn active">{{ currentPage }}</button>
        <button class="pagination-btn">{{ currentPage + 1 }}</button>
        <button class="pagination-btn" [disabled]="currentPage >= totalPages">NEXT</button>
      </div>
    </div>
  </div>
</div>

<!-- Task Creation Modal -->
<div *ngIf="showCreateTaskModal" class="modal-overlay" (click)="closeCreateTaskModal()">
  <div class="modal-container" (click)="$event.stopPropagation()">
    <!-- Modal Header -->
    <div class="modal-header">
      <div>
        <h3 class="modal-title">Create New Task</h3>
        <p class="modal-subtitle">Fill in the details to schedule and track your work.</p>
      </div>
      <button class="modal-close-btn" (click)="closeCreateTaskModal()">
        <i class="fas fa-times"></i>
      </button>
    </div>

    <!-- Modal Content -->
    <div class="modal-content">
      <!-- Left Side - Form -->
      <div class="modal-form">
        <!-- Task Name -->
        <div class="form-group">
          <label for="task-name" class="form-label">
            Task Name <span class="required">*</span>
          </label>
          <input type="text" id="task-name" class="form-input" [(ngModel)]="newTask.name"
            placeholder="e.g. Redesign Homepage Hero Section" required>
        </div>

        <!-- Assignee (Multi-Select) -->
        <div class="form-group">
          <label for="assignee" class="form-label">
            Assigned To <span class="required">*</span>
          </label>
          <div class="multi-select-wrapper">
            <div class="multi-select-display" (click)="showAssigneeDropdown()">
              <span class="multi-select-text">{{ getSelectedAssigneesDisplay() }}</span>
              <i class="fas fa-chevron-down select-icon"></i>
            </div>
            
            <!-- Selected Assignees Tags -->
            @if (newTask.assignees.length > 0) {
              <div class="selected-tags">
                @for (assigneeId of newTask.assignees; track assigneeId) {
                  <span class="tag">
                    {{ getEmployeeName(assigneeId) }}
                      <i class="fas fa-times" (click)="removeAssignee(assigneeId)"></i>
                    </span>
                }
              </div>
            }
            
            <!-- Dropdown List -->
            @if (isAssigneeDropdownVisible) {
              <div class="multi-select-dropdown">
                <div class="dropdown-search">
                  <i class="fas fa-search"></i>
                  <input 
                    type="text" 
                    placeholder="Search assignees..." 
                    [(ngModel)]="assigneeSearchTerm"
                    (input)="onAssigneeSearchInputChange($event)"
                    (click)="$event.stopPropagation()"
                  >
                </div>
                <div class="dropdown-options">
                  @for (employee of getFilteredAssignees(); track employee.idValue) {
                    <div class="dropdown-option" (click)="toggleAssigneeSelection(employee.idValue); $event.stopPropagation()">
                      <input 
                        type="checkbox" 
                        [checked]="isAssigneeSelectedInMulti(employee.idValue)"
                        (click)="$event.stopPropagation()"
                      >
                      <span class="option-text">{{ employee.description }}</span>
                    </div>
                  }
                  @if (getFilteredAssignees().length === 0) {
                    <div class="no-options">No assignees found</div>
                  }
                </div>
              </div>
            }
          </div>
        </div>

        <!-- Description -->
        <div class="form-group">
          <label for="description" class="form-label">Description</label>
          <textarea id="description" class="form-textarea" [(ngModel)]="newTask.description"
            placeholder="Add detailed instructions, goals, or notes..." rows="3"></textarea>
        </div>

        <!-- Task Type -->
        <div class="form-group">
          <label class="form-label">Task Type</label>
          <div class="task-type-grid">
            <label class="task-type-option" [class.selected]="newTask.type === 'single'">
              <input type="radio" name="task-type" value="single" [(ngModel)]="newTask.type" class="sr-only">
              <div class="task-type-icon">
                <i class="fas fa-calendar-day"></i>
              </div>
              <div class="task-type-content">
                <span class="task-type-title">Single Day</span>
                <span class="task-type-desc">One-time effort</span>
              </div>
              <i class="fas fa-check-circle task-type-check"></i>
            </label>

            <label class="task-type-option" [class.selected]="newTask.type === 'continuous'">
              <input type="radio" name="task-type" value="continuous" [(ngModel)]="newTask.type" class="sr-only">
              <div class="task-type-icon">
                <i class="fas fa-calendar-alt"></i>
              </div>
              <div class="task-type-content">
                <span class="task-type-title">Continuous</span>
                <span class="task-type-desc">Span multiple days</span>
              </div>
              <i class="fas fa-check-circle task-type-check"></i>
            </label>
          </div>
        </div>

        <!-- Date and Hours -->
        <div class="form-row">
          <div class="form-group">
            <label for="date" class="form-label-small">Date</label>
            <div class="input-with-icon">
              <i class="fas fa-calendar-alt input-icon"></i>
              <input type="date" id="date" class="form-input-small" [(ngModel)]="newTask.date">
            </div>
          </div>

          <div class="form-group">
            <label for="est-hours" class="form-label-small">Est. Hours</label>
            <div class="input-with-icon">
              <i class="fas fa-clock input-icon"></i>
              <input type="number" id="est-hours" class="form-input-small" [(ngModel)]="newTask.estimatedHours"
                placeholder="0.00" step="0.25" min="0">
            </div>
          </div>
        </div>

        <!-- Subtasks -->
        <div class="form-group">
          <div class="subtasks-header">
            <label class="form-label">Subtasks</label>
            <button type="button" class="add-subtask-btn" (click)="addSubtask()">
              <i class="fas fa-plus"></i>
              Add New
            </button>
          </div>

          <div class="subtasks-list">
            <!-- Existing Subtasks -->
            <div *ngFor="let subtask of newTask.subtasks; let i = index" class="subtask-item">
              <input type="checkbox" [(ngModel)]="subtask.completed" class="subtask-checkbox">
              <input type="text" [(ngModel)]="subtask.name" class="subtask-input" placeholder="Subtask name">
              <input type="number" [(ngModel)]="subtask.estimatedHours" class="subtask-hours" placeholder="0h"
                step="0.25" min="0">

              <!-- Subtask Timer Controls -->
              <div class="subtask-timer-controls">
                <button type="button" class="subtask-timer-btn start" [class.active]="subtask.isRunning"
                  (click)="startSubtaskTimer(subtask.id)" [disabled]="subtask.isRunning">
                  <i class="fas fa-play"></i>
                </button>
                <button type="button" class="subtask-timer-btn pause" (click)="pauseSubtaskTimer(subtask.id)"
                  [disabled]="!subtask.isRunning">
                  <i class="fas fa-pause"></i>
                </button>
                <button type="button" class="subtask-timer-btn stop" (click)="stopSubtaskTimer(subtask.id)"
                  [disabled]="!subtask.isRunning && subtask.timeSpent === 0">
                  <i class="fas fa-stop"></i>
                </button>
              </div>

              <button type="button" class="remove-subtask-btn" (click)="removeSubtask(i)">
                <i class="fas fa-trash-alt"></i>
              </button>
            </div>

            <!-- Add New Subtask Row -->
            <div class="subtask-item subtask-add">
              <div class="subtask-checkbox-placeholder"></div>
              <input type="text" class="subtask-input" placeholder="Type subtask name..." #newSubtaskInput>
              <input type="text" class="subtask-hours" placeholder="0h">
              <div class="subtask-timer-placeholder"></div>
              <div class="subtask-spacer"></div>
            </div>
          </div>
        </div>
      </div>

      <!-- Right Side - Timer & Summary -->
      <div class="modal-sidebar">
        <!-- Task Timer -->
        <div class="timer-widget">
          <div class="timer-header">
            <h4 class="timer-title">Task Timer</h4>
            <div class="timer-status-dot"></div>
          </div>

          <div class="timer-display-widget">
            <div class="timer-gradient-bg"></div>
            <span class="timer-text">00:00:00</span>
          </div>

          <div class="timer-controls-widget">
            <button class="timer-start-btn" disabled>
              <i class="fas fa-play"></i>
              Start
            </button>
            <button class="timer-pause-btn" disabled>
              <i class="fas fa-pause"></i>
            </button>
            <button class="timer-stop-btn" disabled>
              <i class="fas fa-stop"></i>
            </button>
          </div>

          <p class="timer-note">
            <i class="fas fa-info-circle"></i>
            Create task to start tracking
          </p>
        </div>

        <!-- Time Summary -->
        <div class="time-summary-widget">
          <h4 class="summary-title">Time Summary</h4>

          <div class="summary-items">
            <div class="summary-item">
              <div class="summary-icon estimated">
                <i class="fas fa-clock"></i>
              </div>
              <span class="summary-label">Estimated</span>
              <span class="summary-value">{{ newTask.estimatedHours || 0 }}.0h</span>
            </div>

            <div class="summary-item">
              <div class="summary-icon logged">
                <i class="fas fa-history"></i>
              </div>
              <span class="summary-label">Logged</span>
              <span class="summary-value logged-value">0.0h</span>
            </div>

            <div class="summary-divider"></div>

            <div class="summary-item">
              <div class="summary-icon remaining">
                <i class="fas fa-hourglass-half"></i>
              </div>
              <span class="summary-label">Remaining</span>
              <span class="summary-value remaining-value">--</span>
            </div>
          </div>

          <div class="budget-usage">
            <div class="budget-header">
              <span class="budget-label">Budget Usage</span>
              <span class="budget-percentage">0%</span>
            </div>
            <div class="budget-bar">
              <div class="budget-fill" style="width: 0%"></div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Modal Footer -->
    <div class="modal-footer">
      <button type="button" class="save-draft-btn" (click)="saveAsDraft()">
        Save as Draft
      </button>

      <div class="modal-actions">
        <button type="button" class="cancel-btn" (click)="closeCreateTaskModal()">
          Cancel
        </button>
        <button type="button" class="create-btn" (click)="createTask()" [disabled]="!newTask.name || newTask.assignees.length === 0">
          Create Task
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Task Creation Modal -->
@if (showCreateTaskModal) {
<div class="modal-overlay" (click)="closeCreateTaskModal()">
  <div class="modal-container" (click)="$event.stopPropagation()">
    <!-- Modal Header -->
    <div class="modal-header">
      <div>
        <h3 class="modal-title">Create New Task</h3>
        <p class="modal-subtitle">Fill in the details to schedule and track your work.</p>
      </div>
      <button class="modal-close-btn" (click)="closeCreateTaskModal()">
        <i class="fas fa-times"></i>
      </button>
    </div>

    <!-- Modal Content -->
    <div class="modal-content">
      <!-- Left Side - Form -->
      <div class="modal-form">
        <!-- Task Name -->
        <div class="form-group">
          <label for="task-name" class="form-label">
            Task Name <span class="required">*</span>
          </label>
          <input type="text" id="task-name" class="form-input" [(ngModel)]="newTask.name"
            placeholder="e.g. Redesign Homepage Hero Section" required>
        </div>

        <!-- Assignee (Multi-Select) -->
        <div class="form-group">
          <label for="assignee" class="form-label">
            Assigned To <span class="required">*</span>
          </label>
          <div class="multi-select-wrapper">
            <div class="multi-select-display" (click)="showAssigneeDropdown()">
              <span class="multi-select-text">{{ getSelectedAssigneesDisplay() }}</span>
              <i class="fas fa-chevron-down select-icon"></i>
            </div>
            
            <!-- Selected Assignees Tags -->
            @if (newTask.assignees.length > 0) {
              <div class="selected-tags">
                @for (assigneeId of newTask.assignees; track assigneeId) {
                  <span class="tag">
                    {{ getEmployeeName(assigneeId) }}
                      <i class="fas fa-times" (click)="removeAssignee(assigneeId)"></i>
                    </span>
                }
              </div>
            }
            
            <!-- Dropdown List -->
            @if (isAssigneeDropdownVisible) {
              <div class="multi-select-dropdown">
                <div class="dropdown-search">
                  <i class="fas fa-search"></i>
                  <input 
                    type="text" 
                    placeholder="Search assignees..." 
                    [(ngModel)]="assigneeSearchTerm"
                    (input)="onAssigneeSearchInputChange($event)"
                    (click)="$event.stopPropagation()"
                  >
                </div>
                <div class="dropdown-options">
                  @for (employee of getFilteredAssignees(); track employee.idValue) {
                    <div class="dropdown-option" (click)="toggleAssigneeSelection(employee.idValue); $event.stopPropagation()">
                      <input 
                        type="checkbox" 
                        [checked]="isAssigneeSelectedInMulti(employee.idValue)"
                        (click)="$event.stopPropagation()"
                      >
                      <span class="option-text">{{ employee.description }}</span>
                    </div>
                  }
                  @if (getFilteredAssignees().length === 0) {
                    <div class="no-options">No assignees found</div>
                  }
                </div>
              </div>
            }
          </div>
        </div>

        <!-- Description -->
        <div class="form-group">
          <label for="description" class="form-label">Description</label>
          <textarea id="description" class="form-textarea" [(ngModel)]="newTask.description"
            placeholder="Add detailed instructions, goals, or notes..." rows="3"></textarea>
        </div>

        <!-- Task Type -->
        <div class="form-group">
          <label class="form-label">Task Type</label>
          <div class="task-type-grid">
            <label class="task-type-option" [class.selected]="newTask.type === 'single'">
              <input type="radio" name="task-type" value="single" [(ngModel)]="newTask.type" class="sr-only">
              <div class="task-type-icon">
                <i class="fas fa-calendar-day"></i>
              </div>
              <div class="task-type-content">
                <span class="task-type-title">Single Day</span>
                <span class="task-type-desc">One-time effort</span>
              </div>
              <i class="fas fa-check-circle task-type-check"></i>
            </label>

            <label class="task-type-option" [class.selected]="newTask.type === 'continuous'">
              <input type="radio" name="task-type" value="continuous" [(ngModel)]="newTask.type" class="sr-only">
              <div class="task-type-icon">
                <i class="fas fa-calendar-alt"></i>
              </div>
              <div class="task-type-content">
                <span class="task-type-title">Continuous</span>
                <span class="task-type-desc">Span multiple days</span>
              </div>
              <i class="fas fa-check-circle task-type-check"></i>
            </label>
          </div>
        </div>

        <!-- Date and Hours -->
        <div class="form-row">
          <div class="form-group">
            <label for="date" class="form-label-small">Date</label>
            <div class="input-with-icon">
              <i class="fas fa-calendar-alt input-icon"></i>
              <input type="date" id="date" class="form-input-small" [(ngModel)]="newTask.date">
            </div>
          </div>

          <div class="form-group">
            <label for="est-hours" class="form-label-small">Est. Hours</label>
            <div class="input-with-icon">
              <i class="fas fa-clock input-icon"></i>
              <input type="number" id="est-hours" class="form-input-small" [(ngModel)]="newTask.estimatedHours"
                placeholder="0.00" step="0.25" min="0">
            </div>
          </div>
        </div>

        <!-- Subtasks -->
        <div class="form-group">
          <div class="subtasks-header">
            <label class="form-label">Subtasks</label>
            <button type="button" class="add-subtask-btn" (click)="addSubtask()">
              <i class="fas fa-plus"></i>
              Add New
            </button>
          </div>

          <div class="subtasks-list">
            <!-- Existing Subtasks -->
            @for (subtask of newTask.subtasks; track subtask.id; let i = $index) {
            <div class="subtask-item">
              <input type="checkbox" [(ngModel)]="subtask.completed" class="subtask-checkbox">
              <input type="text" [(ngModel)]="subtask.name" class="subtask-input" placeholder="Subtask name">
              <input type="number" [(ngModel)]="subtask.estimatedHours" class="subtask-hours" placeholder="0h"
                step="0.25" min="0">

              <!-- Subtask Timer Controls -->
              <div class="subtask-timer-controls">
                <button type="button" class="subtask-timer-btn start" [class.active]="subtask.isRunning"
                  (click)="startSubtaskTimer(subtask.id)" [disabled]="subtask.isRunning">
                  <i class="fas fa-play"></i>
                </button>
                <button type="button" class="subtask-timer-btn pause" (click)="pauseSubtaskTimer(subtask.id)"
                  [disabled]="!subtask.isRunning">
                  <i class="fas fa-pause"></i>
                </button>
                <button type="button" class="subtask-timer-btn stop" (click)="stopSubtaskTimer(subtask.id)"
                  [disabled]="!subtask.isRunning && subtask.timeSpent === 0">
                  <i class="fas fa-stop"></i>
                </button>
              </div>

              <button type="button" class="remove-subtask-btn" (click)="removeSubtask(i)">
                <i class="fas fa-trash-alt"></i>
              </button>
            </div>
            }

            <!-- Add New Subtask Row -->
            <div class="subtask-item subtask-add">
              <div class="subtask-checkbox-placeholder"></div>
              <input type="text" class="subtask-input" placeholder="Type subtask name..." #newSubtaskInput>
              <input type="text" class="subtask-hours" placeholder="0h">
              <div class="subtask-timer-placeholder"></div>
              <div class="subtask-spacer"></div>
            </div>
          </div>
        </div>
      </div>

      <!-- Right Side - Timer & Summary -->
      <div class="modal-sidebar">
        <!-- Task Timer -->
        <div class="timer-widget">
          <div class="timer-header">
            <h4 class="timer-title">Task Timer</h4>
            <div class="timer-status-dot"></div>
          </div>

          <div class="timer-display-widget">
            <div class="timer-gradient-bg"></div>
            <span class="timer-text">00:00:00</span>
          </div>

          <div class="timer-controls-widget">
            <button class="timer-start-btn" disabled>
              <i class="fas fa-play"></i>
              Start
            </button>
            <button class="timer-pause-btn" disabled>
              <i class="fas fa-pause"></i>
            </button>
            <button class="timer-stop-btn" disabled>
              <i class="fas fa-stop"></i>
            </button>
          </div>

          <p class="timer-note">
            <i class="fas fa-info-circle"></i>
            Create task to start tracking
          </p>
        </div>

        <!-- Time Summary -->
        <div class="time-summary-widget">
          <h4 class="summary-title">Time Summary</h4>

          <div class="summary-items">
            <div class="summary-item">
              <div class="summary-icon estimated">
                <i class="fas fa-clock"></i>
              </div>
              <span class="summary-label">Estimated</span>
              <span class="summary-value">{{ newTask.estimatedHours || 0 }}.0h</span>
            </div>

            <div class="summary-item">
              <div class="summary-icon logged">
                <i class="fas fa-history"></i>
              </div>
              <span class="summary-label">Logged</span>
              <span class="summary-value logged-value">0.0h</span>
            </div>

            <div class="summary-divider"></div>

            <div class="summary-item">
              <div class="summary-icon remaining">
                <i class="fas fa-hourglass-half"></i>
              </div>
              <span class="summary-label">Remaining</span>
              <span class="summary-value remaining-value">--</span>
            </div>
          </div>

          <div class="budget-usage">
            <div class="budget-header">
              <span class="budget-label">Budget Usage</span>
              <span class="budget-percentage">0%</span>
            </div>
            <div class="budget-bar">
              <div class="budget-fill" style="width: 0%"></div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Modal Footer -->
    <div class="modal-footer">
      <button type="button" class="save-draft-btn" (click)="saveAsDraft()">
        Save as Draft
      </button>

      <div class="modal-actions">
        <button type="button" class="cancel-btn" (click)="closeCreateTaskModal()">
          Cancel
        </button>
        <button type="button" class="create-btn" (click)="createTask()" [disabled]="!newTask.name || newTask.assignees.length === 0">
          Create Task
        </button>
      </div>
    </div>
  </div>
</div>
}


<!-- Select Task Modal -->
@if (showSelectTaskModal) {
<div class="modal-overlay" (click)="closeSelectTaskModal()">
  <div class="select-task-modal" (click)="$event.stopPropagation()">
    <!-- Modal Header -->
    <div class="select-modal-header">
      <div>
        <h3 class="select-modal-title">Select Task</h3>
        <p class="select-modal-subtitle">Manage team workflow and initiate time tracking.</p>
      </div>
      <div class="header-actions">
        <button class="manage-tasks-btn" (click)="openManageTasksModal()">
          <i class="fas fa-cog"></i>
          <span>Manage Tasks</span>
        </button>
        <button class="modal-close-btn" (click)="closeSelectTaskModal()">
          <i class="fas fa-times"></i>
        </button>
      </div>
    </div>

    <!-- Search Box -->
    <div class="select-search-box">
      <i class="fas fa-search search-icon"></i>
      <input 
        type="text" 
        placeholder="Search tasks, departments, or assignees..." 
        class="select-search-input"
        [(ngModel)]="selectTaskSearchTerm"
      >
    </div>

    <!-- Tabs -->
    <div class="select-tabs">
      <button class="select-tab-btn" [class.active]="selectTaskActiveTab === 'favorites'"
        (click)="setSelectTaskTab('favorites')">
        <i class="fas fa-star"></i>
        PINNED FAVORITES
        <span class="tab-count">{{ getFavoritesCount() }}</span>
      </button>
      <button class="select-tab-btn" [class.active]="selectTaskActiveTab === 'myDepartment'" (click)="setSelectTaskTab('myDepartment')">
        <i class="fas fa-users"></i>
        MY DEPARTMENT TASKS
        <span class="tab-count">{{ getMyDepartmentTasksCount() }}</span>
      </button>
      <button class="select-tab-btn" [class.active]="selectTaskActiveTab === 'all'" (click)="setSelectTaskTab('all')">
        <i class="fas fa-th-large"></i>
        ALL DEPARTMENT TASKS
        <span class="tab-count">{{ getAllDepartmentTasksCount() }}</span>
      </button>
    </div>

    <!-- Tab Content -->
    <div class="select-tab-content">
      <!-- Pinned Favorites Tab -->
      @if (selectTaskActiveTab === 'favorites') {
      <div class="task-list-container">
        @if (getFilteredFavouriteTaskList().length === 0) {
        <div class="empty-state">
          <i class="fas fa-star"></i>
          @if (selectTaskSearchTerm) {
            <p>No matching favorites found</p>
            <span>Try a different search term</span>
          } @else {
            <p>No favorite tasks yet</p>
            <span>Star tasks to add them to your favorites</span>
          }
        </div>
        } @else {
        <div class="task-list">
          @for (task of getFilteredFavouriteTaskList(); track task.categoryId) {
          <div class="task-item" (click)="selectTask(task)">
            <i class="fas fa-star star-icon active" (click)="toggleFavourite(task, $event)" title="Remove from favorites"></i>
            <div class="task-item-content">
              <h4 class="task-item-title">{{ task.categoryName }}</h4>
              <p class="task-item-dept">DEPARTMENT: {{ task.departmentName }}</p>
            </div>
            <div class="task-item-info">
              <div class="task-info-item assigned">
                <i class="fas fa-user-friends"></i>
                <span>Assigned Task</span>
              </div>
            </div>
            <button class="add-start-btn" (click)="addTaskToMyList(task); $event.stopPropagation()">
              <i class="fas fa-plus"></i>
              Add
            </button>
          </div>
          }
        </div>
        }
      </div>
      }

      <!-- My Department Tasks Tab -->
      @if (selectTaskActiveTab === 'myDepartment') {
      <div class="task-list-container">
        @if (getFilteredDepartmentTaskList().length === 0) {
        <div class="empty-state">
          <i class="fas fa-users"></i>
          @if (selectTaskSearchTerm) {
            <p>No matching department tasks found</p>
            <span>Try a different search term</span>
          } @else {
            <p>No department tasks available</p>
            <span>Tasks from your department will appear here</span>
          }
        </div>
        } @else {
        <div class="task-list">
          @for (task of getFilteredDepartmentTaskList(); track task.categoryId) {
          <div class="task-item" (click)="selectTask(task)">
            <i [class]="isFavourited(task) ? 'fas fa-star star-icon active' : 'far fa-star star-icon'" 
               (click)="toggleFavourite(task, $event)" 
               [title]="isFavourited(task) ? 'Remove from favorites' : 'Add to favorites'"></i>
            <div class="task-item-content">
              <h4 class="task-item-title">{{ task.categoryName }}</h4>
              <p class="task-item-dept">DEPARTMENT: {{ task.departmentName }}</p>
            </div>
            <div class="task-item-info">
              <div class="task-info-item assigned">
                <i class="fas fa-user-friends"></i>
                <span>Assigned Task</span>
              </div>
            </div>
            <button class="add-start-btn" (click)="addTaskToMyList(task); $event.stopPropagation()">
              <i class="fas fa-plus"></i>
              Add
            </button>
          </div>
          }
        </div>
        }
      </div>
      }

      <!-- All Department Tasks Tab -->
      @if (selectTaskActiveTab === 'all') {
      <div class="task-list-container">
        @if (getFilteredAllDepartmentTaskList().length === 0) {
        <div class="empty-state">
          <i class="fas fa-th-large"></i>
          @if (selectTaskSearchTerm) {
            <p>No matching tasks found</p>
            <span>Try a different search term</span>
          } @else {
            <p>No tasks available</p>
            <span>All department tasks will appear here</span>
          }
        </div>
        } @else {
        <div class="task-list">
          @for (task of getFilteredAllDepartmentTaskList(); track task.categoryId) {
          <div class="task-item" (click)="selectTask(task)">
            <i [class]="isFavourited(task) ? 'fas fa-star star-icon active' : 'far fa-star star-icon'" 
               (click)="toggleFavourite(task, $event)" 
               [title]="isFavourited(task) ? 'Remove from favorites' : 'Add to favorites'"></i>
            <div class="task-item-content">
              <h4 class="task-item-title">{{ task.categoryName }}</h4>
              <p class="task-item-dept">DEPARTMENT: {{ task.departmentName }}</p>
            </div>
            <div class="task-item-info">
              <div class="task-info-item assigned">
                <i class="fas fa-user-friends"></i>
                <span>Assigned Task</span>
              </div>
            </div>
            <button class="add-start-btn" (click)="addTaskToMyList(task); $event.stopPropagation()">
              <i class="fas fa-plus"></i>
              Add
            </button>
          </div>
          }
        </div>
        }
      </div>
      }

    </div>

    <!-- Modal Footer -->

    <!-- <div class="select-modal-footer">
        <div class="footer-info">
          <i class="fas fa-info-circle"></i>
          <span>Missing a specific item? <a href="#" class="create-custom-link">Create custom task</a></span>
        </div>
        <div class="footer-actions">
          <button class="cancel-btn" (click)="closeSelectTaskModal()">Cancel</button>
          <button class="manual-entry-btn">Manual Time Entry</button>
        </div>
      </div> -->


  </div>
</div>
}


<!-- Task Details Modal - Using Standalone Component -->
@if (showTaskDetailsModal) {
  <app-task-details-modal
    [taskId]="selectedTaskIdForModal"
    [userId]="selectedUserIdForModal"
    [categoryId]="selectedCategoryIdForModal"
    (closeModal)="closeTaskDetailsModal()"
    (taskUpdated)="onTaskUpdatedFromModal($event)"
    (taskPaused)="onTaskPausedFromModal($event)"
    (taskResumed)="onTaskResumedFromModal($event)"
    (taskStopped)="onTaskStoppedFromModal($event)">
  </app-task-details-modal>
}

<!-- Add Field Modal - Small Popup -->
@if (showAddFieldModal) {
<div class="modal-overlay" (click)="closeAddFieldModal()">
  <div class="add-field-modal" (click)="$event.stopPropagation()">
    <!-- Modal Header -->
    <div class="add-field-modal-header">
      <h3 class="add-field-modal-title">Add Fields</h3>
      <p class="add-field-modal-subtitle">Select fields to add to project metadata</p>
      <button class="modal-close-btn" (click)="closeAddFieldModal()">
        <i class="fas fa-times"></i>
      </button>
    </div>

    <!-- Fields List with Checkboxes -->
    <div class="add-field-modal-content">
      <div class="fields-checklist">
        @for (field of availableCustomFields; track field.key) {
        <label class="field-checkbox-item" [class.disabled]="isFieldMapped(field.key)">
          <input type="checkbox" [checked]="isFieldChecked(field.key)" [disabled]="isFieldMapped(field.key)"
            (change)="toggleFieldSelection(field.key)">
          <div class="checkbox-custom-field">
            <i class="fas fa-check"></i>
          </div>
          <div class="field-checkbox-content">
            <div class="field-checkbox-header">
              <span class="field-checkbox-name">{{ field.label }}</span>
              <span class="field-type-badge" [ngClass]="'type-' + field.type">
                @if (field.type === 'text') { Text Input }
                @else if (field.type === 'number') { Number }
                @else if (field.type === 'dropdown') { Dropdown }
                @else if (field.type === 'textarea') { Text Area }
              </span>
            </div>
            <span class="field-checkbox-description">{{ field.description }}</span>
          </div>
          @if (isFieldMapped(field.key)) {
          <span class="field-already-added">
            <i class="fas fa-check-circle"></i>
            Already Mapped
          </span>
          }
        </label>
        }
      </div>
    </div>

    <!-- Modal Footer -->
    <div class="add-field-modal-footer">
      <div class="selected-count">
        {{ tempSelectedFields.length }} field(s) selected
      </div>
      <div class="add-field-modal-actions">
        <button class="cancel-btn" (click)="closeAddFieldModal()">Cancel</button>
        <button class="apply-btn" (click)="applySelectedFields()">Apply</button>
      </div>
    </div>
  </div>
</div>
}

<!-- Custom Fields Modal -->
@if (showCustomFieldsModal) {
<div class="modal-overlay" (click)="closeCustomFieldsModal()">
  <div class="custom-fields-modal" (click)="$event.stopPropagation()">
    <!-- Modal Header -->
    <div class="custom-fields-header">
      <h3 class="custom-fields-modal-title">Manage Custom Fields</h3>
      <p class="custom-fields-subtitle">Select additional fields to add to your task</p>
      <button class="modal-close-btn" (click)="closeCustomFieldsModal()">
        <i class="fas fa-times"></i>
      </button>
    </div>

    <!-- Available Fields List -->
    <div class="custom-fields-content">
      <div class="available-fields-list">
        <div class="field-option" *ngFor="let field of availableCustomFields">
          <div class="field-checkbox">
            <input type="checkbox" [id]="'field-' + field.key" [checked]="isFieldSelected(field.key)"
              (change)="selectCustomField(field)">
            <label [for]="'field-' + field.key">
              <div class="field-info">
                <span class="field-name">{{ field.label }}</span>
                <span class="field-type">{{ field.type }}</span>
              </div>
              <span class="field-description">{{ field.description }}</span>
            </label>
          </div>
        </div>
      </div>
    </div>

    <!-- Modal Footer -->
    <div class="custom-fields-footer">
      <button class="cancel-btn" (click)="closeCustomFieldsModal()">Cancel</button>
      <button class="apply-btn" (click)="applyCustomFields()">Apply</button>
    </div>
  </div>
</div>
}

<!-- Manage Tasks Modal -->
@if (showManageTasksModal) {
<div class="modal-overlay" (click)="closeManageTasksModal()">
  <div class="manage-tasks-modal" (click)="$event.stopPropagation()">
    <!-- Modal Header -->
    <div class="manage-modal-header">
      <div class="header-content">
        <h3 class="manage-modal-title">Manage Task Categories</h3>
        <p class="manage-modal-subtitle">Add, edit, or remove task categories for your organization</p>
      </div>
      <button class="modal-close-btn" (click)="closeManageTasksModal()">
        <i class="fas fa-times"></i>
      </button>
    </div>

    <!-- Action Bar -->
    <div class="manage-action-bar">
      <button class="add-new-category-btn" (click)="showAddCategoryForm()">
        <i class="fas fa-plus-circle"></i>
        Add New Category
      </button>
      
      <div class="filter-department">
        <label class="filter-dept-label">
          <i class="fas fa-filter"></i>
          FILTER BY DEPARTMENT
        </label>
        <select class="filter-dept-select" [(ngModel)]="selectedDepartmentFilter">
          @for (dept of getDepartments(); track dept) {
            <option [value]="dept">{{ dept }}</option>
          }
        </select>
      </div>
    </div>

    <!-- Categories Content -->
    <div class="manage-categories-content">
      <!-- Section Title -->
      <h4 class="categories-section-title">EXISTING TASK CATEGORIES ({{ getFilteredCategories().length }})</h4>

      <!-- Add/Edit Form -->
      @if (isAddingNewCategory) {
        <div class="category-edit-form">
          <div class="form-fields-row">
            <div class="form-field">
              <label class="field-label">DEPARTMENT <span class="required">*</span></label>
              <select class="field-input" [(ngModel)]="newTaskCategory.departmentId">
                <option value="0">Select Department</option>
                @for (dept of departmentMasterList; track dept.departmentId) {
                  <option [value]="dept.departmentId">{{ dept.deptName }}</option>
                }
              </select>
            </div>
            
            <div class="form-field">
              <label class="field-label">TASK CATEGORY NAME <span class="required">*</span></label>
              <input type="text" class="field-input" [(ngModel)]="newTaskCategory.categoryName" placeholder="Enter category name">
            </div>
            
            <div class="form-field">
              <label class="field-label">ESTIMATED HOURS</label>
              <input type="number" class="field-input" [(ngModel)]="newTaskCategory.sequenceNumber" placeholder="0">
            </div>
          </div>
          
          <div class="form-actions-row">
            <button class="btn-form-cancel" (click)="cancelAddCategory()">
              <i class="fas fa-times"></i>
              Cancel
            </button>
            <button class="btn-form-save" (click)="saveNewCategory()">
              <i class="fas fa-check"></i>
              Save
            </button>
          </div>
        </div>
      }

      <!-- Categories List -->
      <div class="categories-items-list">
        @for (category of getFilteredCategories(); track category.categoryId) {
          @if (category.isEditing) {
            <!-- Edit Form for this category -->
            <div class="category-edit-form">
              <div class="form-fields-row">
                <div class="form-field">
                  <label class="field-label">DEPARTMENT <span class="required">*</span></label>
                  <select class="field-input" [(ngModel)]="category.departmentId" (change)="onDepartmentChange(category.departmentId, category)">
                    <option value="0">Select Department</option>
                    @for (dept of departmentMasterList; track dept.departmentId) {
                      <option [value]="dept.departmentId">{{ dept.deptName }}</option>
                    }
                  </select>
                </div>
                
                <div class="form-field">
                  <label class="field-label">TASK CATEGORY NAME <span class="required">*</span></label>
                  <input type="text" class="field-input" [(ngModel)]="category.categoryName" placeholder="Enter category name">
                </div>
                
                <div class="form-field">
                  <label class="field-label">ESTIMATED HOURS</label>
                  <input type="number" class="field-input" [(ngModel)]="category.sequenceNumber" placeholder="0">
                </div>
              </div>
              
              <div class="form-actions-row">
                <button class="btn-form-cancel" (click)="cancelEdit(category)">
                  <i class="fas fa-times"></i>
                  Cancel
                </button>
                <button class="btn-form-save" (click)="saveCategory(category)">
                  <i class="fas fa-check"></i>
                  Save
                </button>
              </div>
            </div>
          } @else {
            <!-- Category List Item -->
            <div class="category-list-item">
              <div class="category-item-icon">
                <i class="fas fa-list"></i>
              </div>
              <div class="category-item-content">
                <h5 class="category-item-title">{{ category.categoryName }}</h5>
                <p class="category-item-dept">{{ category.departmentName }}</p>
              </div>
              <button class="category-edit-btn" (click)="startEditCategory(category)">
                <i class="fas fa-edit"></i>
                Edit
              </button>
            </div>
          }
        }
      </div>
    </div>
  </div>
</div>
}
