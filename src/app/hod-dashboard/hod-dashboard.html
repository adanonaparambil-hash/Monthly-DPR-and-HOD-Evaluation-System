<div class="hod-dashboard-container">
  <!-- Loading Indicator -->
  @if (isLoading) {
    <div class="loading-container">
      <div class="loading-spinner">
        <i class="fas fa-spinner fa-spin"></i>
      </div>
      <p>Loading dashboard data...</p>
    </div>
  } @else {

  <!-- Header Section with Month/Year Selector -->
  <header class="dashboard-header" #dashboardHeader>
    <div class="header-glow"></div>
    <div class="header-content">
      <!-- Top Row: Title, Quote, Birthday, Month/Year -->
      <div class="header-main-row">
        <!-- Dashboard Title -->
        <div class="section-title">
          <div class="title-icon">
            <i class="fas fa-user-tie"></i>
          </div>
          <div class="title-text">
            <h2>HOD Performance Dashboard</h2>
            <p>Monitor your department's performance</p>
          </div>
        </div>

        <!-- Quote of the Day -->
        <div class="info-card quote-card">
          <div class="card-glow-effect"></div>
          <div class="card-icon">
            <i class="fas fa-quote-left"></i>
          </div>
          <div class="card-content">
            <h3 class="card-title">Quote of the Day</h3>
            <p class="quote-text">"{{ quoteOfTheDay.text }}"</p>
            <span class="quote-author">â€” {{ quoteOfTheDay.author }}</span>
          </div>
          <div class="card-decoration">
            <i class="fas fa-quote-right"></i>
          </div>
        </div>

        <!-- Today's Birthdays -->
        <div class="info-card birthday-card">
          <div class="card-glow-effect"></div>
          <div class="card-icon">
            <i class="fas fa-birthday-cake"></i>
          </div>
          <div class="card-content">
            <h3 class="card-title">Today's Birthdays ðŸŽ‰</h3>
            @if (todaysBirthdays.length > 0) {
              <div class="birthday-carousel">
                <div class="birthday-slider" [style.transform]="'translateX(-' + (currentBirthdayIndex * 100) + '%)'">
                  @for (birthday of todaysBirthdays; track birthday.id) {
                    <div class="birthday-slide">
                      <div class="birthday-avatar">
                        <img [src]="birthday.profileImage" [alt]="birthday.name">
                        <div class="birthday-badge">
                          <i class="fas fa-gift"></i>
                        </div>
                      </div>
                      <div class="birthday-info">
                        <h4 class="birthday-name">{{ birthday.name }}</h4>
                        <p class="birthday-department">{{ birthday.department }}</p>
                        <div class="birthday-wish">
                          <i class="fas fa-heart"></i>
                          <span>Happy Birthday!</span>
                        </div>
                      </div>
                    </div>
                  }
                </div>
                @if (todaysBirthdays.length > 1) {
                  <div class="carousel-indicators">
                    @for (birthday of todaysBirthdays; track birthday.id; let i = $index) {
                      <button 
                        class="indicator" 
                        [class.active]="i === currentBirthdayIndex"
                        (click)="goToBirthday(i)">
                      </button>
                    }
                  </div>
                }
              </div>
            } @else {
              <div class="no-birthdays">
                <i class="fas fa-calendar-check"></i>
                <p>No birthdays today</p>
              </div>
            }
          </div>
        </div>

        <!-- Month/Year Selector -->
        <div class="date-selector">
          <div class="selector-wrapper">
            <div class="selector-group">
              <label>
                <i class="fas fa-calendar-alt"></i>
                Month
              </label>
              <div class="select-container">
                <select [(ngModel)]="selectedMonth" (change)="onMonthYearChange()" class="modern-select">
                  <option *ngFor="let month of months" [value]="month.value">{{ month.name }}</option>
                </select>
                <i class="fas fa-chevron-down select-arrow"></i>
              </div>
            </div>
            <div class="selector-divider"></div>
            <div class="selector-group">
              <label>
                <i class="fas fa-calendar"></i>
                Year
              </label>
              <div class="select-container">
                <select [(ngModel)]="selectedYear" (change)="onMonthYearChange()" class="modern-select">
                  <option *ngFor="let year of years" [value]="year">{{ year }}</option>
                </select>
                <i class="fas fa-chevron-down select-arrow"></i>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </header>

  <!-- Parallax Background -->
  <div class="parallax-bg">
    <div class="parallax-layer bg-layer-1"></div>
    <div class="parallax-layer bg-layer-2"></div>
    <div class="parallax-layer bg-layer-3"></div>

    <!-- Floating Elements -->
    <div class="floating-elements">
      <div class="floating-shape shape-1"></div>
      <div class="floating-shape shape-2"></div>
      <div class="floating-shape shape-3"></div>
      <div class="floating-shape shape-4"></div>
      <div class="floating-shape shape-5"></div>
      <div class="floating-shape shape-6"></div>
    </div>

    <!-- Animated Particles -->
    <div class="particles-bg">
      @for (particle of particles; track particle.x) {
      <div class="particle" [style.left.px]="particle.x" [style.top.px]="particle.y" [style.width.px]="particle.size"
        [style.height.px]="particle.size" [style.animation-delay.s]="particle.delay">
      </div>
      }
    </div>
  </div>

  <!-- Stats Cards -->
  <div class="stats-grid">
    <div class="stat-card blue gsap-stat-card">
      <div class="card-glow"></div>
      <div class="stat-icon">
        <i class="fas fa-users"></i>
      </div>
      <div class="stat-content">
        <div class="stat-number counter-number">{{ dashboardData?.departmentEmployeeCount || 0 }}</div>
        <div class="stat-label">My Department Employees</div>
        <div class="stat-department">{{ dashboardData?.topPerformerDepartment || 'Department' }}</div>
      </div>
      <div class="stat-badge">My Dept</div>
      <div class="stat-sparkline">
        <div class="sparkline-bar" style="height: 60%"></div>
        <div class="sparkline-bar" style="height: 80%"></div>
        <div class="sparkline-bar" style="height: 100%"></div>
        <div class="sparkline-bar" style="height: 70%"></div>
        <div class="sparkline-bar" style="height: 90%"></div>
      </div>
    </div>

    <div class="stat-card orange gsap-stat-card">
      <div class="card-glow"></div>
      <div class="stat-icon">
        <i class="fas fa-clock"></i>
      </div>
      <div class="stat-content">
        <div class="stat-number counter-number">{{ dashboardData?.pendingMPRs || 0 }}</div>
        <div class="stat-label">My Pending MPRs</div>
        <div class="stat-department">Require my approval</div>
      </div>
      <div class="stat-badge">My Dept</div>
      <div class="pulse-indicator urgent"></div>
    </div>

    <div class="stat-card green gsap-stat-card">
      <div class="card-glow"></div>
      <div class="stat-icon">
        <i class="fas fa-check-circle"></i>
      </div>
      <div class="stat-content">
        <div class="stat-number counter-number">{{ dashboardData?.evaluatedMPRs || 0 }}</div>
        <div class="stat-label">My Evaluated MPRs</div>
        <div class="stat-department">Completed this month</div>
      </div>
      <div class="stat-badge">My Dept</div>
      <div class="progress-arc">
        <svg width="60" height="30" viewBox="0 0 60 30">
          <path d="M 5 25 Q 30 5 55 25" stroke="rgba(34, 197, 94, 0.3)" stroke-width="3" fill="none" />
          <path d="M 5 25 Q 30 5 55 25" stroke="#22c55e" stroke-width="3" fill="none" stroke-dasharray="70"
            stroke-dashoffset="20" class="progress-path" />
        </svg>
      </div>
    </div>

    <div class="stat-card gold gsap-stat-card top-performer-card">
      <div class="card-glow"></div>
      <div class="stat-icon">
        <i class="fas fa-trophy"></i>
      </div>
      <div class="stat-content">
        <div class="top-performer-header">
          <i class="fas fa-crown top-performer-crown"></i>
          <span class="stat-label">My Top Performer</span>
        </div>
        <div class="top-performer-name">{{ dashboardData?.topPerformerEmployeeName || 'No Data Available' }}</div>
        <div class="top-performer-score">
          <span class="score-label">Overall Score:</span>
          <span class="score-value">{{ dashboardData?.topPerformerRating || 0 }}/100</span>
        </div>
        <div class="stat-department">{{ dashboardData?.topPerformerDepartment || 'Department' }}</div>
      </div>
      <div class="stat-badge">My Dept</div>
      <div class="achievement-stars">
        <i class="fas fa-star"></i>
        <i class="fas fa-star"></i>
        <i class="fas fa-star"></i>
        <i class="fas fa-star"></i>
        <i class="fas fa-star"></i>
      </div>
    </div>
  </div>

  <!-- Main Content Grid -->
  <div class="main-content-grid">


    <!-- Performance Charts -->
    <div class="charts-section">
      <div class="chart-container gsap-chart-card">
        <div class="chart-glow"></div>
        <div class="chart-header">
          <h3>Employee Performance Trends</h3>
          <span class="chart-subtitle">Last 6 Months</span>
          <div class="chart-icon">
            <i class="fas fa-chart-line"></i>
          </div>
        </div>
        <canvas #performanceTrendChart></canvas>
      </div>

      <!-- Evaluation Summary -->
      <div class="chart-container gsap-chart-card evaluation-summary-container">
        <div class="chart-glow"></div>
        <div class="chart-header">
          <h3>Evaluation Summary</h3>
          <span class="chart-subtitle">{{ dashboardData?.hodEvaluationSummary?.[0]?.departmentName || 'Department' }}</span>
          <div class="chart-icon">
            <i class="fas fa-chart-pie"></i>
          </div>
        </div>

        <div class="evaluation-content">
          <div class="summary-chart-wrapper">
            <canvas #summaryChart></canvas>
          </div>

          @if (dashboardData?.hodEvaluationSummary?.[0]; as summary) {
          <div class="summary-legend">
            <div class="legend-item">
              <div class="legend-color excellent"></div>
              <span class="legend-label">Excellent (100)</span>
              <span class="percentage">{{ summary.excellentCount || 0 }} ({{ summary.excellentPercentage || 0 }}%)</span>
            </div>
            <div class="legend-item">
              <div class="legend-color good"></div>
              <span class="legend-label">Good (80)</span>
              <span class="percentage">{{ summary.goodCount || 0 }} ({{ summary.goodPercentage || 0 }}%)</span>
            </div>
            <div class="legend-item">
              <div class="legend-color average"></div>
              <span class="legend-label">Average (60)</span>
              <span class="percentage">{{ summary.averageCount || 0 }} ({{ summary.averagePercentage || 0 }}%)</span>
            </div>
            <div class="legend-item">
              <div class="legend-color below-average"></div>
              <span class="legend-label">Below Average (40)</span>
              <span class="percentage">{{ summary.belowAverageCount || 0 }} ({{ summary.belowAveragePercentage || 0 }}%)</span>
            </div>
            <div class="legend-item">
              <div class="legend-color poor"></div>
              <span class="legend-label">Poor (20)</span>
              <span class="percentage">{{ summary.poorCount || 0 }} ({{ summary.poorPercentage || 0 }}%)</span>
            </div>
          </div>
          }</div>
      </div>
    </div>


    <!-- Top Performers Section -->
    <div class="leaderboard-section">
      <div class="section-header">
        <h2><i class="fas fa-medal"></i> {{ dashboardData?.topPerformerDepartment || 'Department' }} Rankings</h2>
        <div class="tabs">
          <button class="tab active">My Department ({{ dashboardData?.hodDepartmentRankings?.length || 0 }})</button>
          <!-- <button class="tab">Company-wide (Top 5)</button> -->
        </div>
      </div>

      <div class="leaderboard">
        @if (getDepartmentRankings().length > 0) {
          @for (employee of getDepartmentRankings(); track $index; let i = $index) {
            @if (employee) {
            <div class="leaderboard-item" [class]="'rank-' + (i + 1)">
              <div class="rank-badge" [class]="i === 0 ? 'gold' : i === 1 ? 'silver' : 'bronze'">
                @if (i === 0) {
                  <i class="fas fa-crown"></i>
                }
                <span>#{{ employee?.rank || (i + 1) }}</span>
              </div>
              <div class="employee-info">
                @if (employee?.profileImageBase64 || employee?.profileImage) {
                  <img [src]="employee?.profileImageBase64 || employee?.profileImage" [alt]="employee?.employeeName || 'Employee'">
                } @else {
                  <img src="https://images.unsplash.com/photo-1494790108755-2616b612b786?w=50&h=50&fit=crop&crop=face&auto=format" [alt]="employee?.employeeName || 'Employee'">
                }
                <div class="employee-details">
                  <h4>{{ employee?.employeeName || 'Unknown Employee' }}</h4>
                </div>
              </div>
              <div class="rating">
                <span class="rating-number">{{ employee?.rating || 0 }} / 100</span>
              </div>
            </div>
            }
          }
        } @else {
          <div class="no-data">
            <p>No ranking data available</p>
          </div>
        }
      </div>

    </div>

    <!-- Pending Evaluations -->
    <div class="evaluations-section" [@fadeInUp] style="animation-delay: 0.6s">
      <div class="section-header">
        <h2><i class="fas fa-clock"></i> Pending Evaluations</h2>
        <div class="search-bar">
          <i class="fas fa-search"></i>
          <input type="text" placeholder="Search employees or departments..." (input)="onSearchChange($event)" [value]="searchTerm">
        </div>
      </div>

      <div class="tabs-container">
        <div class="tabs">
          <button class="tab active">My Department ({{ totalCount || filteredPendingEvaluations.length }})</button>
          <!-- <button class="tab">All Departments (4)</button> -->
        </div>
        <p class="approval-note">You can approve these evaluations</p>
      </div>

      <div class="evaluations-table">
        <div class="table-header">
          <span>Employee Name</span>
          <span>Department</span>
          <span>Submission Date</span>
          <span>Status</span>
          <span>Action</span>
        </div>

        @if (filteredPendingEvaluations.length > 0) {
          @for (evaluation of filteredPendingEvaluations; track evaluation.dprid; let i = $index) {
            <div class="table-row" [@slideInRight] [style.animation-delay]="(i * 0.1) + 's'">
              <div class="employee-cell">
                <img [src]="getProfileImage(evaluation)" [alt]="evaluation.employeeName || 'Employee'">
                <span>{{ evaluation.employeeName || 'Unknown Employee' }}</span>
              </div>
              <div class="department-cell">
                <span class="department-badge">{{ evaluation.department || 'N/A' }}</span>
                <span>My Dept</span>
              </div>
              <div class="date-cell">{{ formatDate(evaluation.submissionDate) }}</div>
              <div class="priority-cell">
                <span class="priority" [class]="evaluation.actionStatus === 'Submitted' ? 'high' : 'normal'">
                  {{ evaluation.actionStatus || 'Pending' }}
                </span>
              </div>
              <div class="action-cell">
                <button class="evaluate-btn" (click)="evaluateEmployee(evaluation.dprid)">Evaluate Now</button>
              </div>
            </div>
          }
        } @else {
          <div class="no-data-row">
            <div class="no-data-message">
              @if (searchTerm) {
                <p>No evaluations found matching "{{ searchTerm }}"</p>
              } @else {
                <p>No pending evaluations available</p>
              }
            </div>
          </div>
        }
      </div>
    </div>

  </div>
  }
</div>