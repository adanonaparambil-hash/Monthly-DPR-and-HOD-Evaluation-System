<div class="monthly-dpr-page" [@slideIn]>
  <!-- Header -->
  <div class="header-section" [@scaleIn]>
    <div class="header-content">
      <h1>Monthly Performance Review</h1>
      <p><i class="fas fa-calendar-alt"></i> <b> {{ monthYear }} </b></p>
    </div>
    <div class="header-actions">
    </div>
  </div>

  <!-- Employee Info Card -->
  <div class="info-card" [@scaleIn]>
    <div class="info-row">
      <div class="info-item">
        <label><b>Employee Id</b></label>
        <input [(ngModel)]="empId" placeholder="Enter employee ID" disabled>
      </div>
      <div class="info-item">
        <label><b>Name</b></label>
        <input [(ngModel)]="empName" placeholder="Enter your full name" disabled>
      </div>
      <div class="info-item">
        <label><b>Designation</b></label>
        <input [(ngModel)]="designation" placeholder="Enter your designation" disabled>
      </div>
    </div>
    <div class="info-row">
      <div class="info-item">
        <label><b>Department</b></label>
        <input [(ngModel)]="department" placeholder="Enter your department" disabled>
      </div>
      <div class="info-item">
        <label><b>Worked Hours</b></label>
        <input type="number" [(ngModel)]="WorkedHours" placeholder="Enter Worked Hours: e.g., 160" disabled>
      </div>
      <div class="info-item">
        <label><b>Reporting To</b></label>
        <select [(ngModel)]="reportingTo" [disabled]="!canEditFields">
          <option value="">Select HOD</option>
          @for (hod of hodList; track hod.idValue) {
            <option [value]="hod.idValue">
              {{ hod.description }}
            </option>
          }
        </select>
      </div>
    </div>
  </div>

  <!-- Task Details Section -->
  <div class="task-card" [@scaleIn]>
    <div class="section-header" (click)="toggleTaskDetails()">
      <div class="header-left">
        <i class="fas fa-hourglass-half"></i>
        <span>Task Details</span>
      </div>
      <div class="header-right">
        @if (showTableActions) {
          <div class="button-container" (click)="$event.stopPropagation()">
            <button class="add-btn ptask" (click)="GetProofHubTask()">Get ProofHub Task History</button>
            <button class="add-btn" (click)="addNewTask()">+ Add New Task</button>
          </div>
        }
        <i class="fas" [class.fa-chevron-down]="showTaskDetails" [class.fa-chevron-right]="!showTaskDetails"></i>
      </div>
    </div>

    @if (showTaskDetails) {
      <div class="task-content" [@fadeInUp]>
        <div class="table-container my-task-table">
          <table>
            <thead>
              <tr>
                <th class="SlNo-col">SL No</th>
                <th class="task-col">Task Name</th>
                <th class="desc-col">Task Description</th>
                <th class="hours-col">Actual Hours</th>
                @if (showTableActions) {
                  <th class="delete-col" style="text-align: center;">Action</th>
                }
              </tr>
            </thead>
            <tbody>
              @for (task of tasks; track $index; let i = $index) {
                <tr>
                  <td class="SlNo-col">{{ i + 1 }}</td>
                  <td class="task-col">
                    <textarea [(ngModel)]="task.taskName" placeholder="Task name" [disabled]="!canEditFields"></textarea>
                  </td>
                  <td class="desc-col">
                    <textarea [(ngModel)]="task.description" placeholder="Description and status" [disabled]="!canEditFields"></textarea>
                  </td>
                  <td class="hours-col">
                    <input type="number" [(ngModel)]="task.actualHours" placeholder="0" (keyup)="validateActualHours()" [disabled]="!canEditFields">
                  </td>
                  @if (showTableActions) {
                    <td class="delete-col" style="text-align: center;">
                      <button class="delete-btn" (click)="deleteTask(i)" title="Delete Task">
                        <i class="fas fa-trash"></i>
                      </button>
                    </td>
                  }
                </tr>
              }
            </tbody>
          </table>
        </div>
      </div>
    }
  </div>



  <!-- KPI Performance Section -->
  <div class="kpi-card" [@scaleIn]>
    <div class="section-header" (click)="toggleKpiPerformance()">
      <div class="header-left">
        <i class="fas fa-chart-line"></i>
        <span>KPI Performance</span>
      </div>
      <div class="header-right">
        @if (showTableActions) {
          <div class="button-container" (click)="$event.stopPropagation()">
            @if (!maxKPIsReached) {
              <button class="add-btn" (click)="addNewKPI()">+ Add KPI</button>
            }
            @if (maxKPIsReached) {
              <span class="max-kpi-message">
                All KPIs Added ({{ availableKPIs.length }}/{{ availableKPIs.length }})
              </span>
            }
          </div>
        }
        <i class="fas" [class.fa-chevron-down]="showKpiPerformance" [class.fa-chevron-right]="!showKpiPerformance"></i>
      </div>
    </div>

    @if (showKpiPerformance) {
      <div class="kpi-content" [@fadeInUp]>
        <div class="table-container kpi-table">
          <table>
            <thead>
              <tr>
                <th class="SlNo-col">Sl No</th>
                <th class="kpi-col">KPI</th>
                <th class="desc-col">Description</th>
                <th class="kpi-value-col">KPI Value</th>
                @if (showTableActions) {
                  <th class="delete-col" style="text-align: center;">Action</th>
                }
              </tr>
            </thead>
            <tbody>
              @for (kpi of kpis; track $index; let i = $index) {
                <tr>
                  <td class="SlNo-col">{{ i + 1 }}</td>
                  <td class="kpi-col">
                    @if (canEditFields) {
                      <select [(ngModel)]="kpi.kpiMasterId" (ngModelChange)="onKPISelectionChange(i, $event)">
                        <option [value]="0">Select KPI</option>
                        @for (availableKpi of getAvailableKPIsForRow(i); track availableKpi.kpiid) {
                          <option [value]="availableKpi.kpiid">
                            {{ availableKpi.kpiname }}
                          </option>
                        }
                      </select>
                    } @else {
                      <span class="readonly-value">
                        {{ getKPINameById(kpi.kpiMasterId) || 'No KPI Selected' }}
                      </span>
                    }
                  </td>
                  <td class="desc-col">{{ kpi.description }}</td>
                  <td class="kpi-value-col">
                    @if (canEditFields) {
                      <input [(ngModel)]="kpi.kpiValue" [placeholder]="getPlaceholderForKPI(i)" type="text" class="rating-input">
                    } @else {
                      <span class="readonly-value">{{ kpi.kpiValue || '-' }}</span>
                    }
                  </td>
                  @if (showTableActions) {
                    <td class="delete-col" style="text-align: center;">
                      <button class="delete-btn" (click)="deleteKPI(i)" title="Delete KPI">
                        <i class="fas fa-trash"></i>
                      </button>
                    </td>
                  }
                </tr>
              }
            </tbody>
          </table>
        </div>

        @if (showTableActions && availableKPIs.length > 0) {
          <div class="kpi-status-info">
            <small class="text-muted">
              <i class="fas fa-info-circle"></i>
              @if (!maxKPIsReached) {
                <span>
                  {{ getRemainingKPICount() }} KPI(s) remaining out of {{ availableKPIs.length }} available
                </span>
              }
              @if (maxKPIsReached) {
                <span>
                  All {{ availableKPIs.length }} available KPIs have been added
                </span>
              }
            </small>
          </div>
        }
      </div>
    }
  </div>


  <!-- Achievements and Challenges -->
  <div class="achievements-challenges" [@scaleIn]>
    <div class="achievement-card">
      <h3><i class="fas fa-trophy colorful-icon"></i> Achievements</h3>
      <p>Describe your major accomplishments, achievements, deliverables and quality deliverables...</p>
      <textarea [(ngModel)]="achievements" placeholder="Enter your achievements..." [disabled]="!canEditFields"></textarea>
    </div>
    <div class="challenge-card">
      <h3><i class="fas fa-question-circle colorful-icon"></i> Challenges</h3>
      <p>Detail the challenges you encountered, the steps taken to address them...</p>
      <textarea [(ngModel)]="challenges" placeholder="Enter challenges faced..." [disabled]="!canEditFields"></textarea>
    </div>
  </div>

   <!-- Support Needed Section -->
  <div class="support-card" [@scaleIn]>
    <h3><i class="fas fa-handshake colorful-icon"></i> Support Needed / Suggestions</h3>
    <p>Specify the support you need from management, team or resources. Include any suggestions for process improvement...</p>
    <textarea [(ngModel)]="supportNeeded" placeholder="Enter your support requirements..." [disabled]="!canEditFields"></textarea>
  </div>

  <!-- HOD Evaluation Section -->
  @if (showHodEvaluationSection) {
    <div class="evaluation-card" [@scaleIn]>
      <div class="section-header" (click)="toggleHodEvaluation()">
        <div class="header-left">
          <i class="fas fa-star"></i>
          <span>HOD Evaluation</span>
        </div>
        <i class="fas" [class.fa-chevron-down]="showHodEvaluation" [class.fa-chevron-right]="!showHodEvaluation"></i>
      </div>

      @if (showHodEvaluation) {
        <div class="evaluation-content" [@fadeInUp]>
          <div class="evaluation-grid">
            <div class="eval-item">
              <label>Quality <small>(Rate 1-100)</small></label>
              <input [(ngModel)]="quality" placeholder="Enter score (1-100, e.g., 85)" type="number" min="1" max="100" step="1"
                class="rating-input" [disabled]="!canEditHodEvaluation" (ngModelChange)="calculateOverallRating()"
                (keyup)="validateRatingInput('quality', $event)" (blur)="finalizeRatingInput('quality', $event)">
            </div>
            <div class="eval-item">
              <label>Timeliness <small>(Rate 1-100)</small></label>
              <input [(ngModel)]="timeliness" placeholder="Enter score (1-100, e.g., 85)" type="number" min="1" max="100"
                step="1" class="rating-input" [disabled]="!canEditHodEvaluation"
                (ngModelChange)="calculateOverallRating()" (keyup)="validateRatingInput('timeliness', $event)" (blur)="finalizeRatingInput('timeliness', $event)">
            </div>
            <div class="eval-item">
              <label>Initiative <small>(Rate 1-100)</small></label>
              <input [(ngModel)]="initiative" placeholder="Enter score (1-100, e.g., 85)" type="number" min="1" max="100"
                step="1" class="rating-input" [disabled]="!canEditHodEvaluation"
                (ngModelChange)="calculateOverallRating()" (keyup)="validateRatingInput('initiative', $event)" (blur)="finalizeRatingInput('initiative', $event)">
            </div>
            <div class="eval-item">
              <label>Problem Solving <small>(Rate 1-100)</small></label>
              <input [(ngModel)]="problemSolving" placeholder="Enter score (1-100, e.g., 85)" type="number" min="1"
                max="100" step="1" class="rating-input" [disabled]="!canEditHodEvaluation"
                (ngModelChange)="calculateOverallRating()" (keyup)="validateRatingInput('problemSolving', $event)" (blur)="finalizeRatingInput('problemSolving', $event)">
            </div>
            <div class="eval-item">
              <label>Team Work <small>(Rate 1-100)</small></label>
              <input [(ngModel)]="teamWork" placeholder="Enter score (1-100, e.g., 85)" type="number" min="1" max="100"
                step="1" class="rating-input" [disabled]="!canEditHodEvaluation"
                (ngModelChange)="calculateOverallRating()" (keyup)="validateRatingInput('teamWork', $event)" (blur)="finalizeRatingInput('teamWork', $event)">
            </div>
            <div class="eval-item">
              <label>Communication <small>(Rate 1-100)</small></label>
              <input [(ngModel)]="communication" placeholder="Enter score (1-100, e.g., 85)" type="number" min="1" max="100"
                step="1" class="rating-input" [disabled]="!canEditHodEvaluation"
                (ngModelChange)="calculateOverallRating()" (keyup)="validateRatingInput('communication', $event)" (blur)="finalizeRatingInput('communication', $event)">
            </div>
            <div class="eval-item">
              <label>HOD Rating <small>(Rate 1-100)</small></label>
              <input [(ngModel)]="hodRating" placeholder="Enter rating (1-100, e.g., 85)" type="number" min="1" max="100" step="1"
                class="rating-input" [disabled]="!canEditHodEvaluation" (ngModelChange)="calculateOverallRating()"
                (keyup)="validateRatingInput('hodRating', $event)" (blur)="finalizeRatingInput('hodRating', $event)">
            </div>
          </div>

          @if (showOverallRating) {
            <div class="overall-rating-section" [@scaleIn]>
              <div class="overall-rating-card">
                <h3><i class="fas fa-trophy"></i> Overall Performance Rating</h3>

                <div class="rating-breakdown">
                  <div class="breakdown-item">
                    <span class="label">HOD Rating (70%):</span>
                    <span class="value">{{ hodRating }}/100</span>
                  </div>
                  <div class="breakdown-item">
                    <span class="label">Quality (5%):</span>
                    <span class="value">{{ quality }}/100</span>
                  </div>
                  <div class="breakdown-item">
                    <span class="label">Timeliness (5%):</span>
                    <span class="value">{{ timeliness }}/100</span>
                  </div>
                  <div class="breakdown-item">
                    <span class="label">Initiative (5%):</span>
                    <span class="value">{{ initiative }}/100</span>
                  </div>
                  <div class="breakdown-item">
                    <span class="label">Communication (5%):</span>
                    <span class="value">{{ communication }}/100</span>
                  </div>
                  <div class="breakdown-item">
                    <span class="label">Teamwork (5%):</span>
                    <span class="value">{{ teamWork }}/100</span>
                  </div>
                  <div class="breakdown-item">
                    <span class="label">Problem Solving (5%):</span>
                    <span class="value">{{ problemSolving }}/100</span>
                  </div>
                  <div class="breakdown-item final-score">
                    <span class="label">Final Overall Score:</span>
                    <span class="value">{{ overallScore }}/100</span>
                  </div>
                </div>

                <div class="final-rating-container">
                  <div class="rating-circle" [class]="getRatingClass(overallScore)" [@pulseAnimation]>
                    <div class="rating-score">{{ overallScore }}</div>
                    <div class="rating-text">{{ getRatingText(overallScore) }}</div>
                  </div>
                  <div class="rating-description">
                    <h4>{{ getRatingText(overallScore) }}</h4>
                    <p>{{ getRatingDescription(overallScore) }}</p>
                  </div>
                </div>

                <div class="rating-legend">
                  <div class="legend-item excellent">
                    <span class="legend-color"></span>
                    <span>Excellent (4.5-5.0)</span>
                  </div>
                  <div class="legend-item good">
                    <span class="legend-color"></span>
                    <span>Good (3.5-4.4)</span>
                  </div>
                  <div class="legend-item average">
                    <span class="legend-color"></span>
                    <span>Average (2.5-3.4)</span>
                  </div>
                  <div class="legend-item below-average">
                    <span class="legend-color"></span>
                    <span>Below Average (1.5-2.4)</span>
                  </div>
                  <div class="legend-item poor">
                    <span class="legend-color"></span>
                    <span>Poor (1.0-1.4)</span>
                  </div>
                </div>
              </div>
            </div>
          }
        </div>
      }
    </div>
  }

  <!-- Management Remarks Section -->
  @if (showManagementRemarksSection) {
    <div class="remarks-card" [@scaleIn]>
      <div class="section-header" (click)="toggleManagementRemarks()">
        <div class="header-left">
          <i class="fas fa-comment"></i>
          <span>Management Remarks</span>
        </div>
        <i class="fas" [class.fa-chevron-down]="showManagementRemarks"
          [class.fa-chevron-right]="!showManagementRemarks"></i>
      </div>

      @if (showManagementRemarks) {
        <div class="remarks-content" [@fadeInUp]>
          <p>Add your remarks about the employee's performance...</p>
          <textarea [(ngModel)]="managementRemarks" placeholder="Enter management remarks..."
            [disabled]="!canEditManagementRemarks"></textarea>
        </div>
      }
    </div>
  }

  <!-- Remarks History Section -->
  @if (showRemarksHistorySection) {
    <div class="history-card" [@scaleIn]>
      <div class="section-header" (click)="toggleRemarksHistory()">
        <div class="header-left">
          <i class="fas fa-history"></i>
          <span>Remarks History</span>
        </div>
        <i class="fas" [class.fa-chevron-down]="showRemarksHistory" [class.fa-chevron-right]="!showRemarksHistory"></i>
      </div>

      @if (showRemarksHistory) {
        <div class="history-content" [@fadeInUp]>
          @for (remark of remarksHistory; track remark.commentId) {
            <div class="history-item" [@scaleIn]>
              <div class="history-header">
                <div class="history-user">
                  <i class="fas fa-user-circle"></i>
                  <span class="user-name">{{ remark.hodId }}</span>
                  <span class="status-badge" [class]="'status-' + remark.commentType">{{ remark.commentType }}</span>
                </div>
                <span class="history-date">{{ remark.createdat }}</span>
              </div>
              <p class="history-comment">{{ remark.commentText }}</p>
            </div>
          }
        </div>
      }
    </div>
  }

  <!-- Action Buttons -->
  <div class="action-buttons right-action-buttons" [@scaleIn]>
    @if (showEmployeeButtons) {
      <button class="btn-draft colorful-btn" (click)="saveDraft()">
        <i class="fas fa-save"></i> Save as Draft
      </button>
      <button class="btn-available colorful-btn" (click)="SubmitReview()">
        <i class="fas fa-check"></i> Submit for Review
      </button>
    }

    @if (showHodButtons) {
      <button class="btn-approve colorful-btn" (click)="ApproveReview()">
        <i class="fas fa-thumbs-up"></i> Approve
      </button>
      <button class="btn-pushback colorful-btn" (click)="ReWorkReview()">
        <i class="fas fa-undo"></i> ReWork
      </button>
    }
  </div>
</div>

<!-- Modal -->
@if (showModal) {
  <div class="modal-overlay">
    <div class="modal-box" [@scaleIn]>
      <div class="modal-header">
        <span class="back-arrow" (click)="closeModal()">&#8592;</span>
        <h2>ProofHub Task History</h2>
      </div>

      <div class="modal-body" style="overflow-x: hidden; max-width: 100%;">
        <div class="table-container">
          <table>
            <thead>
              <tr>
                <th class="SlNo-col">SL No</th>
                <th class="task-col">Task Name</th>
                <th class="desc-col">Task Description</th>
                <th class="date-col">Start Date</th>
                <th class="date-col">Due Date</th>
                <th class="hours-col">Estimated Hours</th>
                <th class="hours-col">Logged Hours</th>
                <th class="status-col">Completion Status</th>
                <th class="select-col">Select</th>
              </tr>
            </thead>
            <tbody>
              @for (task of Proofhubtasks; track task.TASK_ID; let i = $index) {
                <tr>
                  <td>{{ i + 1 }}</td>
                  <td class="task-col">{{ task.TASK_TITLE }}</td>
                  <td class="desc-col">{{ task.TASK_DESCRIPTION }}</td>
                  <td class="date-col">{{ task.START_DATE }}</td>
                  <td class="date-col">{{ task.DUE_DATE }}</td>
                  <td class="hours-col">{{ task.ESTIMATED_HOURS }}</td>
                  <td class="hours-col">{{ task.LOGGED_HOURS }}</td>
                  <td class="status-col">
                    <span [class]="task.COMPLETED ? 'status-completed' : 'status-incomplete'">
                      {{ task.COMPLETED ? 'Completed' : 'Incomplete' }}
                    </span>
                  </td>
                  <td><input type="checkbox" [(ngModel)]="task.selected" /></td>
                </tr>
              }
            </tbody>
          </table>
        </div>

        <div class="summary-box" style="overflow: hidden;">
          <div class="summary-header"
            style="display: flex; justify-content: space-between; align-items: center; position: relative; min-height: 40px; padding-right: 50px;">
            <h3 style="margin: 0; flex-grow: 1;">AI Generated Summary</h3>
            @if (summaryText) {
              <button class="copy-btn" (click)="copySummaryToClipboard($event)"
                [title]="'Copy clean summary to clipboard: ' + (cleanedSummaryText.length > 50 ? cleanedSummaryText.substring(0, 50) + '...' : cleanedSummaryText)"
                type="button"
                style="position: absolute; right: 15px; top: 50%; transform: translateY(-50%); background: none; border: none; cursor: pointer; padding: 8px; border-radius: 4px; transition: background-color 0.2s; color: #666; font-size: 16px; width: 32px; height: 32px; display: flex; align-items: center; justify-content: center;"
                onmouseover="this.style.backgroundColor='#f0f0f0'" onmouseout="this.style.backgroundColor='transparent'">
                <i class="fas fa-clipboard"></i>
              </button>
            }
          </div>
          <div class="textarea-container">
            <textarea readonly #summaryTextarea
              [placeholder]="isGeneratingSummary ? 'Generating summary...' : 'Click \'Generate Summary\' to create an AI-powered summary of selected tasks...'">{{ summaryText }}</textarea>
          </div>
        </div>

        <div class="summary-actions">
          <button class="generate-summary-btn" (click)="generateSummary()" [disabled]="isGeneratingSummary" type="button">
            @if (isGeneratingSummary) {
              <span>
                <i class="fas fa-spinner fa-spin"></i> Generating...
              </span>
            } @else {
              <span>Generate Summary</span>
            }
          </button>
          <button class="close-modal-btn" (click)="closeModal()" type="button">Close</button>
        </div>
      </div>
    </div>
  </div>
}