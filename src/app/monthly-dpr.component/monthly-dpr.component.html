<div class="monthly-dpr-page" [@slideIn]>
  <!-- Header -->
  <div class="header-section" [@scaleIn]>
    <div class="header-content">
      <h1>Monthly Performance Review</h1>
      <p><i class="fas fa-calendar-alt"></i> <b> {{ monthYear }} </b></p>
    </div>
    <div class="header-actions">

    </div>
  </div>


  <!-- Employee Info Card -->
  <div class="info-card" [@scaleIn]>
    <div class="info-row">
      <div class="info-item">
        <label><b>Employee Id</b></label>
        <input [(ngModel)]="empId" placeholder="Enter employee ID" disabled>
      </div>
      <div class="info-item">
        <label><b>Name</b></label>
        <input [(ngModel)]="empName" placeholder="Enter your full name" disabled>
      </div>
      <div class="info-item">
        <label><b>Designation</b></label>
        <input [(ngModel)]="designation" placeholder="Enter your designation" disabled>
      </div>


    </div>
    <div class="info-row">


      <div class="info-item">
        <label><b>Department</b></label>
        <input [(ngModel)]="department" placeholder="Enter your department" disabled>
      </div>

      <div class="info-item">
        <label><b>Worked Hours</b></label>
        <input type="number" [(ngModel)]="WorkedHours" placeholder="Enter Worked Hours: e.g., 160" disabled>
      </div>


      <div class="info-item">
        <label><b>Reporting To</b></label>
        <select [(ngModel)]="reportingTo" [disabled]="!canEditFields">
          <option value="">Select HOD</option>
          <option *ngFor="let hod of hodList" [value]="hod.idValue">
            {{ hod.description }}
          </option>
        </select>
      </div>


    </div>

  </div>


  <!-- Task Details Section -->
  <div class="task-card" [@scaleIn]>
    <div class="section-header" (click)="toggleTaskDetails()">
      <div class="header-left">
        <i class="fas fa-hourglass-half"></i>
        <span>Task Details</span>
      </div>
      <div class="header-right">
        <div class="button-container" (click)="$event.stopPropagation()" *ngIf="showTableActions">
          <button class="add-btn ptask" (click)="GetProofHubTask()">Get ProofHub Task History</button>
          <button class="add-btn" (click)="addNewTask()">+ Add New Task</button>
        </div>
        <i class="fas" [class.fa-chevron-down]="showTaskDetails" [class.fa-chevron-right]="!showTaskDetails"></i>
      </div>
    </div>

    <div class="task-content" *ngIf="showTaskDetails" [@fadeInUp]>
      <div class="table-container my-task-table">
        <table>
          <thead>
            <tr>
              <th class="SlNo-col">SL No</th>
              <th class="task-col">Task Name</th>
              <th class="desc-col">Task Description</th>
              <th class="hours-col">Actual Hours</th>
              <th class="delete-col" style="text-align: center;" *ngIf="showTableActions">Action</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let task of tasks; let i = index">
              <td class="SlNo-col">{{ i + 1 }}</td>
              <td class="task-col">
                <textarea [(ngModel)]="task.taskName" placeholder="Task name"
                  [disabled]="!canEditFields"></textarea>
              </td>
              <td class="desc-col">
                <textarea [(ngModel)]="task.description" placeholder="Description and status"
                  [disabled]="!canEditFields"></textarea>
              </td>

              <td class="hours-col">
                <input type="number" [(ngModel)]="task.actualHours" placeholder="0" (keyup)="validateActualHours()"
                  [disabled]="!canEditFields">
              </td>

              <td class="delete-col" style="text-align: center;" *ngIf="showTableActions">
                <button class="delete-btn" (click)="deleteTask(i)" title="Delete Task">
                  <i class="fas fa-trash"></i>
                </button>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>



  </div>

  <!-- Support Needed Section -->
  <div class="support-card" [@scaleIn]>
    <h3><i class="fas fa-handshake colorful-icon"></i> Support Needed / Suggestions</h3>
    <p>Specify the support you need from management, team or resources. Include any suggestions for process
      improvement...</p>
    <textarea [(ngModel)]="supportNeeded" placeholder="Enter your support requirements..."
      [disabled]="!canEditFields"></textarea>
  </div>


  <!-- Achievements and Challenges -->
  <div class="achievements-challenges" [@scaleIn]>
    <div class="achievement-card">
      <h3><i class="fas fa-trophy colorful-icon"></i> Achievements</h3>
      <p>Describe your major accomplishments, achievements, deliverables and quality deliverables...</p>
      <textarea [(ngModel)]="achievements" placeholder="Enter your achievements..."
        [disabled]="!canEditFields"></textarea>
    </div>
    <div class="challenge-card">
      <h3><i class="fas fa-question-circle colorful-icon"></i> Challenges</h3>
      <p>Detail the challenges you encountered, the steps taken to address them...</p>
      <textarea [(ngModel)]="challenges" placeholder="Enter challenges faced..."
        [disabled]="!canEditFields"></textarea>
    </div>
  </div>



  <!-- KPI Performance Section -->
  <div class="kpi-card" [@scaleIn]>
    <div class="section-header" (click)="toggleKpiPerformance()">
      <div class="header-left">
        <i class="fas fa-chart-line"></i>
        <span>KPI Performance</span>
      </div>
      <div class="header-right">
        <div class="button-container" (click)="$event.stopPropagation()" *ngIf="showTableActions">
          <button class="add-btn" (click)="addNewKPI()" *ngIf="!maxKPIsReached">+ Add KPI</button>
          <span class="max-kpi-message" *ngIf="maxKPIsReached">
            All KPIs Added ({{ availableKPIs.length }}/{{ availableKPIs.length }})
          </span>
        </div>
        <i class="fas" [class.fa-chevron-down]="showKpiPerformance" [class.fa-chevron-right]="!showKpiPerformance"></i>
      </div>
    </div>

    <div class="kpi-content" *ngIf="showKpiPerformance" [@fadeInUp]>
      <div class="table-container kpi-table">
        <table>
          <thead>
            <tr>
              <th class="SlNo-col">Sl No</th>
              <th class="kpi-col">KPI</th>
              <th class="desc-col">Description</th>
              <th class="kpi-value-col">KPI Value</th>
              <th class="delete-col" style="text-align: center;" *ngIf="showTableActions">Action</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let kpi of kpis; let i = index">
              <td class="SlNo-col">{{ i + 1 }}</td>

              <!-- KPI Dropdown -->
              <td class="kpi-col">
                <select *ngIf="canEditFields" [(ngModel)]="kpi.kpiMasterId" (ngModelChange)="onKPISelectionChange(i, $event)">
                  <option [value]="0">Select KPI</option>
                  <option *ngFor="let availableKpi of getAvailableKPIsForRow(i)" [value]="availableKpi.kpiid">
                    {{ availableKpi.kpiname }}
                  </option>
                </select>
                <span *ngIf="!canEditFields" class="readonly-value">
                  {{ getKPINameById(kpi.kpiMasterId) || 'No KPI Selected' }}
                </span>
              </td>

              <!-- KPI Description (read-only) -->
              <td class="desc-col">{{ kpi.description }}</td>

              <!-- KPI Value Input -->
              <td class="kpi-value-col">
                <input *ngIf="canEditFields" [(ngModel)]="kpi.kpiValue" [placeholder]="getPlaceholderForKPI(i)" type="text"
                  class="rating-input">
                <span *ngIf="!canEditFields" class="readonly-value">{{ kpi.kpiValue || '-' }}</span>
              </td>

              <td class="delete-col" style="text-align: center;" *ngIf="showTableActions">
                <button class="delete-btn" (click)="deleteKPI(i)" title="Delete KPI">
                  <i class="fas fa-trash"></i>
                </button>
              </td>
            </tr>
          </tbody>
        </table>
      </div>

      <!-- KPI Status Information -->
      <div class="kpi-status-info" *ngIf="showTableActions && availableKPIs.length > 0">
        <small class="text-muted">
          <i class="fas fa-info-circle"></i>
          <span *ngIf="!maxKPIsReached">
            {{ getRemainingKPICount() }} KPI(s) remaining out of {{ availableKPIs.length }} available
          </span>
          <span *ngIf="maxKPIsReached">
            All {{ availableKPIs.length }} available KPIs have been added
          </span>
        </small>
      </div>
    </div>
  </div>



  <!-- HOD Evaluation Section -->
  <div class="evaluation-card" [@scaleIn] *ngIf="showHodEvaluationSection">
    <div class="section-header" (click)="toggleHodEvaluation()">
      <div class="header-left">
        <i class="fas fa-star"></i>
        <span>HOD Evaluation</span>
      </div>
      <i class="fas" [class.fa-chevron-down]="showHodEvaluation" [class.fa-chevron-right]="!showHodEvaluation"></i>
    </div>

    <div class="evaluation-content" *ngIf="showHodEvaluation" [@fadeInUp]>
      <div class="evaluation-grid">
        <div class="eval-item">
          <label>Quality</label>
          <input [(ngModel)]="quality" placeholder="Enter quality score (0-100)" type="number" min="1" max="100"
            class="rating-input" [disabled]="!canEditHodEvaluation">
        </div>
        <div class="eval-item">
          <label>Timeliness</label>
          <input [(ngModel)]="timeliness" placeholder="Enter timeliness score (0-100)" type="number" min="1" max="100"
            class="rating-input" [disabled]="!canEditHodEvaluation">
        </div>
        <div class="eval-item">
          <label>Initiative</label>
          <input [(ngModel)]="initiative" placeholder="Enter initiative score (0-100)" type="number" min="1" max="100"
            class="rating-input" [disabled]="!canEditHodEvaluation">
        </div>
        <div class="eval-item">
          <label>Overall Score</label>
          <input [(ngModel)]="overallScore" placeholder="Enter overall score (0-100)" type="number" min="1" max="100"
            class="rating-input" [disabled]="!canEditHodEvaluation">
        </div>
      </div>
    </div>
  </div>

  <!-- Management Remarks Section -->
  <div class="remarks-card" [@scaleIn] *ngIf="showManagementRemarksSection">
    <div class="section-header" (click)="toggleManagementRemarks()">
      <div class="header-left">
        <i class="fas fa-comment"></i>
        <span>Management Remarks</span>
      </div>
      <i class="fas" [class.fa-chevron-down]="showManagementRemarks"
        [class.fa-chevron-right]="!showManagementRemarks"></i>
    </div>

    <div class="remarks-content" *ngIf="showManagementRemarks" [@fadeInUp]>
      <p>Add your remarks about the employee's performance...</p>
      <textarea [(ngModel)]="managementRemarks" placeholder="Enter management remarks..."
        [disabled]="!canEditManagementRemarks"></textarea>
    </div>
  </div>

  <!-- Remarks History Section -->
  <div class="history-card" [@scaleIn] *ngIf="showRemarksHistorySection">
    <div class="section-header" (click)="toggleRemarksHistory()">
      <div class="header-left">
        <i class="fas fa-history"></i>
        <span>Remarks History</span>
      </div>
      <i class="fas" [class.fa-chevron-down]="showRemarksHistory" [class.fa-chevron-right]="!showRemarksHistory"></i>
    </div>

    <div class="history-content" *ngIf="showRemarksHistory" [@fadeInUp]>
      <div class="history-item" *ngFor="let remark of remarksHistory" [@scaleIn]>
        <div class="history-header">
          <div class="history-user">
            <i class="fas fa-user-circle"></i>
            <span class="user-name">{{ remark.hodId }}</span>
            <span class="status-badge" [class]="'status-' + remark.commentType">{{ remark.commentType }}</span>
          </div>
          <span class="history-date">{{ remark.createdat }}</span>
        </div>
        <p class="history-comment">{{ remark.commentText }}</p>
      </div>
    </div>
  </div>


  <!-- Action Buttons (Now under Achievements/Challenges, right aligned) -->
  <div class="action-buttons right-action-buttons" [@scaleIn]>
    <!-- Employee Buttons: Save Draft and Submit (only when status is D or R) -->
    <button class="btn-draft colorful-btn" (click)="saveDraft()" *ngIf="showEmployeeButtons">
      <i class="fas fa-save"></i> Save as Draft
    </button>
    <button class="btn-available colorful-btn" (click)="SubmitReview()" *ngIf="showEmployeeButtons">
      <i class="fas fa-check"></i> Submit for Review
    </button>
    
    <!-- HOD Buttons: Approve and Rework (only when status is S) -->
    <button class="btn-approve colorful-btn" (click)="ApproveReview()" *ngIf="showHodButtons">
      <i class="fas fa-thumbs-up"></i> Approve
    </button>
    <button class="btn-pushback colorful-btn" (click)="ReWorkReview()" *ngIf="showHodButtons">
      <i class="fas fa-undo"></i> ReWork
    </button>
  </div>
</div>


<!-- Modal -->
<div *ngIf="showModal" class="modal-overlay">
  <div class="modal-box" [@scaleIn]>

    <!-- Header -->
    <div class="modal-header">
      <span class="back-arrow" (click)="closeModal()">&#8592;</span>
      <h2>ProofHub Task History</h2>
      <!-- Removed close button from header -->
    </div>

    <!-- Body -->
    <div class="modal-body" style="overflow-x: hidden; max-width: 100%;">

      <div class="table-container">
        <table>
          <thead>
            <tr>
              <th class="SlNo-col">SL No</th>
              <th class="task-col">Task Name</th>
              <th class="desc-col">Task Description</th>
              <th class="date-col">Start Date</th>
              <th class="date-col">Due Date</th>
              <th class="hours-col">Estimated Hours</th>
              <th class="hours-col">Logged Hours</th>
              <th class="status-col">Completion Status</th>
              <th class="select-col">Select</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let task of Proofhubtasks; let i = index">
              <td>{{ i + 1 }}</td>
              <td class="task-col">{{ task.TASK_TITLE }}</td>
              <td class="desc-col">{{ task.TASK_DESCRIPTION }}</td>
              <td class="date-col">{{ task.START_DATE }}</td>
              <td class="date-col">{{ task.DUE_DATE }}</td>
              <td class="hours-col">{{ task.ESTIMATED_HOURS }}</td>
              <td class="hours-col">{{ task.LOGGED_HOURS }}</td>
              <td class="status-col">
                <span [class]="task.COMPLETED ? 'status-completed' : 'status-incomplete'">
                  {{ task.COMPLETED ? 'Completed' : 'Incomplete' }}
                </span>
              </td>
              <td><input type="checkbox" [(ngModel)]="task.selected" /></td>
            </tr>
          </tbody>
        </table>
      </div>

      <!-- Summary Text Area (Always visible) -->
      <div class="summary-box" style="overflow: hidden;">
        <div class="summary-header"
          style="display: flex; justify-content: space-between; align-items: center; position: relative; min-height: 40px; padding-right: 50px;">
          <h3 style="margin: 0; flex-grow: 1;">AI Generated Summary</h3>
          <button *ngIf="summaryText" class="copy-btn" (click)="copySummaryToClipboard($event)"
            [title]="'Copy clean summary to clipboard: ' + (cleanedSummaryText.length > 50 ? cleanedSummaryText.substring(0, 50) + '...' : cleanedSummaryText)"
            type="button"
            style="position: absolute; right: 15px; top: 50%; transform: translateY(-50%); background: none; border: none; cursor: pointer; padding: 8px; border-radius: 4px; transition: background-color 0.2s; color: #666; font-size: 16px; width: 32px; height: 32px; display: flex; align-items: center; justify-content: center;"
            onmouseover="this.style.backgroundColor='#f0f0f0'" onmouseout="this.style.backgroundColor='transparent'">
            <i class="fas fa-clipboard"></i>
          </button>
        </div>
        <div class="textarea-container">
          <textarea readonly #summaryTextarea
            [placeholder]="isGeneratingSummary ? 'Generating summary...' : 'Click \'Generate Summary\' to create an AI-powered summary of selected tasks...'">{{ summaryText }}</textarea>
        </div>
      </div>

      <!-- Generate Summary Button and Close Button -->
      <div class="summary-actions">
        <button class="generate-summary-btn" (click)="generateSummary()" [disabled]="isGeneratingSummary" type="button">
          <span *ngIf="isGeneratingSummary">
            <i class="fas fa-spinner fa-spin"></i> Generating...
          </span>
          <span *ngIf="!isGeneratingSummary">Generate Summary</span>
        </button>
        <button class="close-modal-btn" (click)="closeModal()" type="button">Close</button>
      </div>
    </div>
  </div>
</div>