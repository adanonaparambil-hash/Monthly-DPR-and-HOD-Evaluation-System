<!-- CED Dashboard Container -->
<div class="ced-dashboard-container">
  <!-- Simple Background -->
  <div class="simple-background"></div>

  <!-- Compact Header Section -->
  <header class="dashboard-header">
    <div class="header-content">
      <!-- Department Overview Section -->
      <div class="section-info" *ngIf="currentView === 'departments'">
        <div class="section-title">
          <h2>Department Overview</h2>
          <p>Select a department to view employee performance rankings</p>
        </div>
        
        <!-- Month/Year Selector -->
        <div class="date-selector">
          <div class="selector-group">
            <label>Month</label>
            <select [(ngModel)]="selectedMonth" (change)="onMonthYearChange()" class="modern-select">
              <option *ngFor="let month of months" [value]="month.value">{{ month.name }}</option>
            </select>
          </div>
          <div class="selector-group">
            <label>Year</label>
            <select [(ngModel)]="selectedYear" (change)="onMonthYearChange()" class="modern-select">
              <option *ngFor="let year of years" [value]="year">{{ year }}</option>
            </select>
          </div>
        </div>
      </div>

      <!-- Employee View Header -->
      <div class="employee-view-header" *ngIf="currentView === 'employees'">
        <div class="back-section">
          <button class="back-button" (click)="backToDepartments()">
            <i class="fas fa-arrow-left"></i>
            <span>Back to Departments</span>
          </button>
        </div>
        
        <div class="department-info" *ngIf="selectedDepartment">
          <div class="dept-icon">
            <i [class]="selectedDepartment.icon"></i>
          </div>
          <div class="dept-details">
            <h2>{{ selectedDepartment.department }} Department</h2>
            <p>Performance Rankings - {{ getMonthName(selectedMonth) }} {{ selectedYear }}</p>
          </div>
        </div>

        <!-- Modern Filter Bar -->
        <div class="modern-filter-bar">
          <div class="filter-container">
            <!-- Status Pills -->
            <div class="status-pills">
              <button 
                *ngFor="let filter of statusFilters" 
                [class]="'status-pill ' + (selectedStatusFilter === filter.value ? 'active' : '')"
                (click)="selectedStatusFilter = filter.value; onStatusFilterChange()">
                <i [class]="filter.icon"></i>
                <span>{{ filter.label }}</span>
                <span class="count">{{ getEmployeeCountByStatus(filter.value) }}</span>
              </button>
            </div>

            <!-- Search Input -->
            <div class="modern-search">
              <i class="fas fa-search"></i>
              <input 
                type="text" 
                [(ngModel)]="searchQuery" 
                (input)="onSearchChange()"
                placeholder="Search employees..."
                class="search-field">
              <button *ngIf="searchQuery" (click)="searchQuery = ''; onSearchChange()" class="clear-btn">
                <i class="fas fa-times"></i>
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </header>

  <!-- Main Content Area -->
  <main class="main-content">
    
    <!-- Department Cards View -->
    <div *ngIf="currentView === 'departments'" class="departments-view">
      <!-- Loading State -->
      <div *ngIf="isLoading" class="loading-state">
        <div class="loading-spinner">
          <i class="fas fa-spinner fa-spin"></i>
        </div>
        <p>Loading department data...</p>
      </div>

      <!-- No Data State -->
      <div *ngIf="!isLoading && departments.length === 0" class="no-data-state">
        <div class="no-data-icon">
          <i class="fas fa-building"></i>
        </div>
        <h3>No Department Data Available</h3>
        <p>No data found for {{ getMonthName(selectedMonth) }} {{ selectedYear }}</p>
      </div>
      
      <!-- Departments Grid -->
      <div *ngIf="!isLoading && departments.length > 0" class="departments-grid">
        <div 
          *ngFor="let department of departments; trackBy: trackByDepartmentId" 
          class="department-card glassmorphism"
          (click)="selectDepartment(department)">
          
          <!-- Card Background Gradient -->
          <div class="card-gradient" [ngClass]="department.color"></div>
          
          <!-- Card Content -->
          <div class="card-content">
            <div class="card-header">
              <div class="department-icon">
                <i [class]="department.icon"></i>
              </div>
              <h3>{{ department.department }}</h3>
            </div>
            
            <div class="stats-grid">
              <div class="stat-item">
                <div class="stat-top-row">
                  <div class="stat-icon">
                    <i [class]="getStatIcon('totalEmployees')"></i>
                  </div>
                  <div class="stat-number">{{ department.totalEmployees }}</div>
                </div>
                <div class="stat-label">Total Employees</div>
              </div>
              <div class="stat-item">
                <div class="stat-top-row">
                  <div class="stat-icon submitted-icon">
                    <i class="fas fa-file" style="color: white !important; font-size: 0.9rem !important; display: block !important;"></i>
                  </div>
                  <div class="stat-number">{{ department.submittedMPR }}</div>
                </div>
                <div class="stat-label">Submitted MPR</div>
              </div>
              <div class="stat-item">
                <div class="stat-top-row">
                  <div class="stat-icon">
                    <i [class]="getStatIcon('pendingMPR')"></i>
                  </div>
                  <div class="stat-number">{{ department.pendingMPR }}</div>
                </div>
                <div class="stat-label">Pending MPR</div>
              </div>
              <div class="stat-item">
                <div class="stat-top-row">
                  <div class="stat-icon">
                    <i [class]="getStatIcon('approvedMPR')"></i>
                  </div>
                  <div class="stat-number">{{ department.approvedMPR }}</div>
                </div>
                <div class="stat-label">Approved MPR</div>
              </div>
            </div>
            
            <!-- Progress Bar -->
            <div class="progress-section">
              <div class="progress-header">
                <span>Completion Rate</span>
                <span class="progress-percentage">{{ getCompletionPercentage(department) }}%</span>
              </div>
              <div class="progress-bar">
                <div 
                  class="progress-fill" 
                  [style.width.%]="getCompletionPercentage(department)">
                </div>
              </div>
            </div>
          </div>
          
          <!-- Hover Effect -->
          <div class="card-hover-effect"></div>
          
          <!-- Click Indicator -->
          <div class="click-indicator">
            <i class="fas fa-arrow-right"></i>
          </div>
        </div>
      </div>
    </div>

    <!-- Employee Listing View -->
    <div *ngIf="currentView === 'employees'" class="employees-view">
      
      <!-- Empty State -->
      <div *ngIf="getDisplayedEmployees().length === 0" class="empty-state">
        <div class="empty-state-content">
          <div class="empty-state-icon">
            <i class="fas fa-users"></i>
          </div>
          <h3>No Employees Found</h3>
          <p *ngIf="searchQuery">No employees match your search "<strong>{{ searchQuery }}</strong>" in {{ selectedDepartment?.department }} department.</p>
          <p *ngIf="!searchQuery">No employees found in {{ selectedDepartment?.department }} department for {{ getMonthName(selectedMonth) }} {{ selectedYear }}.</p>
          <button *ngIf="searchQuery" class="clear-search-btn" (click)="searchQuery = ''; onSearchChange()">
            <i class="fas fa-times"></i>
            Clear Search
          </button>
        </div>
      </div>
      
      <!-- Employee List -->
      <div class="employee-list" *ngIf="getDisplayedEmployees().length > 0">
        <div 
          *ngFor="let employee of getDisplayedEmployees(); trackBy: trackByEmployeeId" 
          class="employee-card glassmorphism"
          [class.expanded]="isEmployeeExpanded(employee.id)">
          
          <!-- Main Employee Row -->
          <div class="employee-main-row" 
               [class.expandable]="canExpandEmployee(employee)"
               [class.non-expandable]="!canExpandEmployee(employee)"
               (click)="toggleEmployeeDetails(employee.id, employee)">
            <!-- Rank Badge -->
            <div class="rank-badge" [class]="getRankIconClass(employee.rank)">
              <i *ngIf="employee.rank === 1" class="fas fa-crown rank-icon-gold"></i>
              <i *ngIf="employee.rank === 2" class="fas fa-medal rank-icon-silver"></i>
              <i *ngIf="employee.rank === 3" class="fas fa-award rank-icon-bronze"></i>
              <span *ngIf="employee.rank > 3" class="rank-number">#{{ employee.rank }}</span>
            </div>
          
            <!-- Employee Info -->
            <div class="employee-info">
              <div class="employee-avatar" (click)="viewEmployeeProfile(employee); $event.stopPropagation()">
                <img [src]="employee.profileImage" [alt]="employee.name" />
                <div class="avatar-overlay">
                  <i class="fas fa-user"></i>
                </div>
              </div>
              
              <div class="employee-details">
                <h3 class="employee-name">
                  {{ employee.name }}
                </h3>
                <div class="employee-meta">
                  <span class="month-year">{{ employee.month }} {{ employee.year }}</span>
                  <span class="status-badge" [ngClass]="getStatusClass(employee.status)">
                    {{ getStatusText(employee.status) }}
                  </span>
                </div>
              </div>
            </div>
            
            <!-- Overall Score Section -->
            <div class="score-section">
              <div class="score-display">
                <div class="score-number">{{ getDisplayScore(employee) }}</div>
                <div class="score-label">Overall Score</div>
              </div>
            </div>
            
            <!-- Expand/Collapse Icon (only for approved employees) -->
            <div class="expand-icon" *ngIf="canExpandEmployee(employee)">
              <i class="fas" [class.fa-chevron-down]="!isEmployeeExpanded(employee.id)" 
                 [class.fa-chevron-up]="isEmployeeExpanded(employee.id)"></i>
            </div>
            
            <!-- Status indicator for non-approved employees -->
            <div class="status-indicator" *ngIf="!canExpandEmployee(employee)">
              <span class="status-badge" [ngClass]="getStatusClass(employee.status)">
                {{ getStatusText(employee.status) }}
              </span>
            </div>
          </div>

          <!-- Compact Performance Metrics (only for approved employees) -->
          <div class="compact-metrics" *ngIf="isEmployeeExpanded(employee.id) && employee.performanceMetrics && canExpandEmployee(employee)">
            <div class="metrics-header">
              <span class="metrics-title">Performance Breakdown</span>
              <button class="view-full-btn" (click)="viewMPRDetails(employee); $event.stopPropagation()">
                <i class="fas fa-external-link-alt"></i>
                View Details
              </button>
            </div>
            
            <div class="metrics-compact-grid">
              <div class="metric-compact">
                <div class="metric-info">
                  <i [class]="getPerformanceMetricIcon('quality')" [style.color]="getPerformanceMetricColor(employee.performanceMetrics.quality)"></i>
                  <span class="metric-label">Quality</span>
                </div>
                <div class="metric-value">{{ employee.performanceMetrics.quality }}</div>
                <div class="metric-mini-bar">
                  <div class="metric-fill" [style.width.%]="employee.performanceMetrics.quality" [style.background-color]="getPerformanceMetricColor(employee.performanceMetrics.quality)"></div>
                </div>
              </div>

              <div class="metric-compact">
                <div class="metric-info">
                  <i [class]="getPerformanceMetricIcon('timeliness')" [style.color]="getPerformanceMetricColor(employee.performanceMetrics.timeliness)"></i>
                  <span class="metric-label">Timeliness</span>
                </div>
                <div class="metric-value">{{ employee.performanceMetrics.timeliness }}</div>
                <div class="metric-mini-bar">
                  <div class="metric-fill" [style.width.%]="employee.performanceMetrics.timeliness" [style.background-color]="getPerformanceMetricColor(employee.performanceMetrics.timeliness)"></div>
                </div>
              </div>

              <div class="metric-compact">
                <div class="metric-info">
                  <i [class]="getPerformanceMetricIcon('initiative')" [style.color]="getPerformanceMetricColor(employee.performanceMetrics.initiative)"></i>
                  <span class="metric-label">Initiative</span>
                </div>
                <div class="metric-value">{{ employee.performanceMetrics.initiative }}</div>
                <div class="metric-mini-bar">
                  <div class="metric-fill" [style.width.%]="employee.performanceMetrics.initiative" [style.background-color]="getPerformanceMetricColor(employee.performanceMetrics.initiative)"></div>
                </div>
              </div>

              <div class="metric-compact">
                <div class="metric-info">
                  <i [class]="getPerformanceMetricIcon('communication')" [style.color]="getPerformanceMetricColor(employee.performanceMetrics.communication)"></i>
                  <span class="metric-label">Communication</span>
                </div>
                <div class="metric-value">{{ employee.performanceMetrics.communication }}</div>
                <div class="metric-mini-bar">
                  <div class="metric-fill" [style.width.%]="employee.performanceMetrics.communication" [style.background-color]="getPerformanceMetricColor(employee.performanceMetrics.communication)"></div>
                </div>
              </div>

              <div class="metric-compact">
                <div class="metric-info">
                  <i [class]="getPerformanceMetricIcon('teamwork')" [style.color]="getPerformanceMetricColor(employee.performanceMetrics.teamwork)"></i>
                  <span class="metric-label">Teamwork</span>
                </div>
                <div class="metric-value">{{ employee.performanceMetrics.teamwork }}</div>
                <div class="metric-mini-bar">
                  <div class="metric-fill" [style.width.%]="employee.performanceMetrics.teamwork" [style.background-color]="getPerformanceMetricColor(employee.performanceMetrics.teamwork)"></div>
                </div>
              </div>

              <div class="metric-compact">
                <div class="metric-info">
                  <i [class]="getPerformanceMetricIcon('problemSolving')" [style.color]="getPerformanceMetricColor(employee.performanceMetrics.problemSolving)"></i>
                  <span class="metric-label">Problem Solving</span>
                </div>
                <div class="metric-value">{{ employee.performanceMetrics.problemSolving }}</div>
                <div class="metric-mini-bar">
                  <div class="metric-fill" [style.width.%]="employee.performanceMetrics.problemSolving" [style.background-color]="getPerformanceMetricColor(employee.performanceMetrics.problemSolving)"></div>
                </div>
              </div>

              <div class="metric-compact hod-rating">
                <div class="metric-info">
                  <i [class]="getPerformanceMetricIcon('hodRating')" [style.color]="getPerformanceMetricColor(employee.performanceMetrics.hodRating)"></i>
                  <span class="metric-label">HOD Rating</span>
                </div>
                <div class="metric-value">{{ employee.performanceMetrics.hodRating }}</div>
                <div class="metric-mini-bar">
                  <div class="metric-fill" [style.width.%]="employee.performanceMetrics.hodRating" [style.background-color]="getPerformanceMetricColor(employee.performanceMetrics.hodRating)"></div>
                </div>
              </div>
            </div>
          </div>
          
          <!-- Card Glow Effect -->
          <div class="card-glow"></div>
        </div>
      </div>
    </div>
  </main>

  <!-- Employee Profile Modal -->
  <div class="profile-modal-overlay" *ngIf="showProfileModal" (click)="closeProfileModal()">
    <div class="profile-modal" (click)="$event.stopPropagation()" *ngIf="selectedEmployeeProfile">
      <!-- Modal Header -->
      <div class="profile-modal-header">
        <h2>Employee Profile</h2>
        <button class="close-modal-btn" (click)="closeProfileModal()">
          <i class="fas fa-times"></i>
        </button>
      </div>

      <!-- Modal Content -->
      <div class="profile-modal-content">
        <!-- Profile Photo and Basic Info -->
        <div class="profile-basic-info">
          <div class="profile-photo-section">
            <img [src]="selectedEmployeeProfile.profileImage" [alt]="selectedEmployeeProfile.name" class="profile-photo">
            <div class="profile-status-badge" [ngClass]="getStatusClass(selectedEmployeeProfile.status)">
              {{ getStatusText(selectedEmployeeProfile.status) }}
            </div>
          </div>
          
          <div class="profile-details">
            <h3>{{ selectedEmployeeProfile.name }}</h3>
            <p class="department-name">{{ selectedEmployeeProfile.department }}</p>
            <div class="profile-stats">
              <div class="stat-item">
                <span class="stat-label">Overall Score</span>
                <span class="stat-value">{{ getDisplayScore(selectedEmployeeProfile) }}/100</span>
              </div>
              <div class="stat-item">
                <span class="stat-label">Department Rank</span>
                <span class="stat-value">#{{ selectedEmployeeProfile.rank }}</span>
              </div>
              <div class="stat-item">
                <span class="stat-label">Review Period</span>
                <span class="stat-value">{{ selectedEmployeeProfile.month }} {{ selectedEmployeeProfile.year }}</span>
              </div>
            </div>
          </div>
        </div>

        <!-- Performance Metrics (if available and approved) -->
        <div class="profile-performance-section" *ngIf="selectedEmployeeProfile.performanceMetrics && selectedEmployeeProfile.status === 'approved'">
          <h4>Performance Breakdown</h4>
          <div class="performance-grid">
            <div class="performance-item">
              <div class="performance-header">
                <i class="fas fa-star" [style.color]="getPerformanceMetricColor(selectedEmployeeProfile.performanceMetrics.quality)"></i>
                <span>Quality</span>
              </div>
              <div class="performance-score">{{ selectedEmployeeProfile.performanceMetrics.quality }}/100</div>
              <div class="performance-bar">
                <div class="performance-fill" 
                     [style.width.%]="selectedEmployeeProfile.performanceMetrics.quality"
                     [style.background-color]="getPerformanceMetricColor(selectedEmployeeProfile.performanceMetrics.quality)"></div>
              </div>
            </div>

            <div class="performance-item">
              <div class="performance-header">
                <i class="fas fa-clock" [style.color]="getPerformanceMetricColor(selectedEmployeeProfile.performanceMetrics.timeliness)"></i>
                <span>Timeliness</span>
              </div>
              <div class="performance-score">{{ selectedEmployeeProfile.performanceMetrics.timeliness }}/100</div>
              <div class="performance-bar">
                <div class="performance-fill" 
                     [style.width.%]="selectedEmployeeProfile.performanceMetrics.timeliness"
                     [style.background-color]="getPerformanceMetricColor(selectedEmployeeProfile.performanceMetrics.timeliness)"></div>
              </div>
            </div>

            <div class="performance-item">
              <div class="performance-header">
                <i class="fas fa-lightbulb" [style.color]="getPerformanceMetricColor(selectedEmployeeProfile.performanceMetrics.initiative)"></i>
                <span>Initiative</span>
              </div>
              <div class="performance-score">{{ selectedEmployeeProfile.performanceMetrics.initiative }}/100</div>
              <div class="performance-bar">
                <div class="performance-fill" 
                     [style.width.%]="selectedEmployeeProfile.performanceMetrics.initiative"
                     [style.background-color]="getPerformanceMetricColor(selectedEmployeeProfile.performanceMetrics.initiative)"></div>
              </div>
            </div>

            <div class="performance-item">
              <div class="performance-header">
                <i class="fas fa-comments" [style.color]="getPerformanceMetricColor(selectedEmployeeProfile.performanceMetrics.communication)"></i>
                <span>Communication</span>
              </div>
              <div class="performance-score">{{ selectedEmployeeProfile.performanceMetrics.communication }}/100</div>
              <div class="performance-bar">
                <div class="performance-fill" 
                     [style.width.%]="selectedEmployeeProfile.performanceMetrics.communication"
                     [style.background-color]="getPerformanceMetricColor(selectedEmployeeProfile.performanceMetrics.communication)"></div>
              </div>
            </div>

            <div class="performance-item">
              <div class="performance-header">
                <i class="fas fa-users" [style.color]="getPerformanceMetricColor(selectedEmployeeProfile.performanceMetrics.teamwork)"></i>
                <span>Teamwork</span>
              </div>
              <div class="performance-score">{{ selectedEmployeeProfile.performanceMetrics.teamwork }}/100</div>
              <div class="performance-bar">
                <div class="performance-fill" 
                     [style.width.%]="selectedEmployeeProfile.performanceMetrics.teamwork"
                     [style.background-color]="getPerformanceMetricColor(selectedEmployeeProfile.performanceMetrics.teamwork)"></div>
              </div>
            </div>

            <div class="performance-item">
              <div class="performance-header">
                <i class="fas fa-puzzle-piece" [style.color]="getPerformanceMetricColor(selectedEmployeeProfile.performanceMetrics.problemSolving)"></i>
                <span>Problem Solving</span>
              </div>
              <div class="performance-score">{{ selectedEmployeeProfile.performanceMetrics.problemSolving }}/100</div>
              <div class="performance-bar">
                <div class="performance-fill" 
                     [style.width.%]="selectedEmployeeProfile.performanceMetrics.problemSolving"
                     [style.background-color]="getPerformanceMetricColor(selectedEmployeeProfile.performanceMetrics.problemSolving)"></div>
              </div>
            </div>

            <div class="performance-item">
              <div class="performance-header">
                <i class="fas fa-award" [style.color]="getPerformanceMetricColor(selectedEmployeeProfile.performanceMetrics.hodRating)"></i>
                <span>HOD Rating</span>
              </div>
              <div class="performance-score">{{ selectedEmployeeProfile.performanceMetrics.hodRating }}/100</div>
              <div class="performance-bar">
                <div class="performance-fill" 
                     [style.width.%]="selectedEmployeeProfile.performanceMetrics.hodRating"
                     [style.background-color]="getPerformanceMetricColor(selectedEmployeeProfile.performanceMetrics.hodRating)"></div>
              </div>
            </div>
          </div>
        </div>

        <!-- Action Buttons -->
        <div class="profile-actions">
          <button class="action-btn primary" (click)="viewMPRDetails(selectedEmployeeProfile); closeProfileModal()">
            <i class="fas fa-file-alt"></i>
            View Full MPR
          </button>
          <button class="action-btn secondary" (click)="closeProfileModal()">
            <i class="fas fa-times"></i>
            Close
          </button>
        </div>
      </div>
    </div>
  </div>
</div>