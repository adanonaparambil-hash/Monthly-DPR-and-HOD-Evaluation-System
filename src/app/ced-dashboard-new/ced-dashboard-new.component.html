<!-- CED Dashboard Container -->
<div class="ced-dashboard-container">
  <!-- Simple Background -->
  <div class="simple-background"></div>

  <!-- Compact Header Section -->
  <header class="dashboard-header">
    <div class="header-content">
      <!-- Department Overview Section -->
      <div class="section-info" *ngIf="currentView === 'departments'">
        <div class="header-main-row">
          <!-- Dashboard Title -->
          <div class="section-title">
            <div class="title-icon">
              <i class="fas fa-building"></i>
            </div>
            <div class="title-text">
              <h2>Department Overview</h2>
              <p>View employee performance rankings</p>
            </div>
          </div>

          <!-- Quote of the Day -->
          <div class="info-card quote-card">
            <div class="card-glow-effect"></div>
            <div class="card-icon">
              <i class="fas fa-quote-left"></i>
            </div>
            <div class="card-content">
              <h3 class="card-title">Quote of the Day</h3>
              <p class="quote-text">"{{ quoteOfTheDay.text }}"</p>
              <span class="quote-author">â€” {{ quoteOfTheDay.author }}</span>
            </div>
            <div class="card-decoration">
              <i class="fas fa-quote-right"></i>
            </div>
          </div>

          <!-- Today's Birthdays -->
          <div class="info-card birthday-card">
            <div class="card-glow-effect"></div>
            <div class="card-icon">
              <i class="fas fa-birthday-cake"></i>
            </div>
            <div class="card-content">
              <h3 class="card-title">Today's Birthdays ðŸŽ‰</h3>
              @if (todaysBirthdays.length > 0) {
                <div class="birthday-carousel">
                  <div class="birthday-slider" [style.transform]="'translateX(-' + (currentBirthdayIndex * 100) + '%)'">
                    @for (birthday of todaysBirthdays; track birthday.id) {
                      <div class="birthday-slide">
                        <div class="birthday-avatar">
                          <img [src]="birthday.profileImage" [alt]="birthday.name">
                          <div class="birthday-badge">
                            <i class="fas fa-gift"></i>
                          </div>
                        </div>
                        <div class="birthday-info">
                          <h4 class="birthday-name">{{ birthday.name }}</h4>
                          <p class="birthday-department">{{ birthday.department }}</p>
                          <div class="birthday-wish">
                            <i class="fas fa-heart"></i>
                            <span>Happy Birthday!</span>
                          </div>
                        </div>
                      </div>
                    }
                  </div>
                  @if (todaysBirthdays.length > 1) {
                    <div class="carousel-indicators">
                      @for (birthday of todaysBirthdays; track birthday.id; let i = $index) {
                        <button 
                          class="indicator" 
                          [class.active]="i === currentBirthdayIndex"
                          (click)="goToBirthday(i)">
                        </button>
                      }
                    </div>
                  }
                </div>
              } @else {
                <div class="no-birthdays">
                  <i class="fas fa-calendar-check"></i>
                  <p>No birthdays today</p>
                </div>
              }
            </div>
          </div>

          <!-- Month/Year Selector -->
          <div class="date-selector">
            <div class="selector-wrapper">
              <div class="selector-group">
                <label>
                  <i class="fas fa-calendar-alt"></i>
                  Month
                </label>
                <div class="select-container">
                  <select [(ngModel)]="selectedMonth" (change)="onMonthYearChange()" class="modern-select">
                    <option *ngFor="let month of months" [value]="month.value">{{ month.name }}</option>
                  </select>
                  <i class="fas fa-chevron-down select-arrow"></i>
                </div>
              </div>
              <div class="selector-divider"></div>
              <div class="selector-group">
                <label>
                  <i class="fas fa-calendar"></i>
                  Year
                </label>
                <div class="select-container">
                  <select [(ngModel)]="selectedYear" (change)="onMonthYearChange()" class="modern-select">
                    <option *ngFor="let year of years" [value]="year">{{ year }}</option>
                  </select>
                  <i class="fas fa-chevron-down select-arrow"></i>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Employee View Header -->
      <div class="employee-view-header" *ngIf="currentView === 'employees'">
        <!-- Top Row: Back Button (Left) + Department Name (Center) -->
        <div class="header-top-row">
          <button class="back-button" (click)="backToDepartments()">
            <i class="fas fa-arrow-left"></i>
            <span>Back to Departments</span>
          </button>
          
          <div class="header-center" *ngIf="selectedDepartment">
            <div class="dept-icon-inline">
              <i [class]="selectedDepartment.icon" [style.color]="getDepartmentIconColor(selectedDepartment.department)"></i>
            </div>
            <h2 class="department-name">{{ selectedDepartment.department }} Department</h2>
          </div>
          
          <div class="header-spacer"></div>
        </div>
        
        <!-- Subtitle Row -->
        <div class="header-subtitle" *ngIf="selectedDepartment">
          <p>Performance Rankings - {{ getMonthName(selectedMonth) }} {{ selectedYear }}</p>
        </div>

        <!-- Modern Filter Bar -->
        <div class="modern-filter-bar">
          <div class="filter-container">
            <!-- Status Pills -->
            <div class="status-pills">
              <button 
                *ngFor="let filter of statusFilters" 
                [class]="'status-pill ' + (selectedStatusFilter === filter.value ? 'active' : '')"
                (click)="selectedStatusFilter = filter.value; onStatusFilterChange()">
                <i [class]="filter.icon"></i>
                <span>{{ filter.label }}</span>
                <span class="count">{{ getEmployeeCountByStatus(filter.value) }}</span>
              </button>
            </div>

            <!-- Search Input -->
            <div class="modern-search">
              <i class="fas fa-search"></i>
              <input 
                type="text" 
                [(ngModel)]="searchQuery" 
                (input)="onSearchChange()"
                placeholder="Search employees..."
                class="search-field">
              <button *ngIf="searchQuery" (click)="searchQuery = ''; onSearchChange()" class="clear-btn">
                <i class="fas fa-times"></i>
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </header>

  <!-- Main Content Area -->
  <main class="main-content">
    
    <!-- Department Cards View -->
    <div *ngIf="currentView === 'departments'" class="departments-view">
      <!-- Loading State -->
      <div *ngIf="isLoading" class="loading-state">
        <div class="loading-spinner">
          <i class="fas fa-spinner fa-spin"></i>
        </div>
        <p>Loading department data...</p>
      </div>

      <!-- No Data State -->
      <div *ngIf="!isLoading && departments.length === 0" class="no-data-state">
        <div class="no-data-icon">
          <i class="fas fa-building"></i>
        </div>
        <h3>No Department Data Available</h3>
        <p>No data found for {{ getMonthName(selectedMonth) }} {{ selectedYear }}</p>
      </div>
      
      <!-- Departments Grid -->
      <div *ngIf="!isLoading && departments.length > 0" class="departments-grid">
        <div 
          *ngFor="let department of departments; trackBy: trackByDepartmentId" 
          class="department-card glassmorphism"
          (click)="selectDepartment(department)">
          
          <!-- Card Background Gradient -->
          <div class="card-gradient" [ngClass]="department.color"></div>
          
          <!-- Card Content -->
          <div class="card-content">
            <div class="card-header">
              <div class="department-icon">
                <i [class]="department.icon" [style.color]="getDepartmentIconColor(department.department)"></i>
              </div>
              <h3>{{ department.department }}</h3>
            </div>
            
            <div class="stats-grid">
              <div class="stat-item">
                <div class="stat-top-row">
                  <div class="stat-icon">
                    <i [class]="getStatIcon('totalEmployees')"></i>
                  </div>
                  <div class="stat-number">{{ department.totalEmployees }}</div>
                </div>
                <div class="stat-label">Total Employees</div>
              </div>
              <div class="stat-item">
                <div class="stat-top-row">
                  <div class="stat-icon submitted-icon">
                    <i class="fas fa-file" style="color: white !important; font-size: 0.9rem !important; display: block !important;"></i>
                  </div>
                  <div class="stat-number">{{ department.submittedMPR }}</div>
                </div>
                <div class="stat-label">Submitted MPR</div>
              </div>
              <div class="stat-item">
                <div class="stat-top-row">
                  <div class="stat-icon">
                    <i [class]="getStatIcon('pendingMPR')"></i>
                  </div>
                  <div class="stat-number">{{ department.pendingMPR }}</div>
                </div>
                <div class="stat-label">Pending MPR</div>
              </div>
              <div class="stat-item">
                <div class="stat-top-row">
                  <div class="stat-icon">
                    <i [class]="getStatIcon('approvedMPR')"></i>
                  </div>
                  <div class="stat-number">{{ department.approvedMPR }}</div>
                </div>
                <div class="stat-label">Approved MPR</div>
              </div>
            </div>
            
            <!-- Progress Bar -->
            <div class="progress-section">
              <div class="progress-header">
                <span>Completion Rate</span>
                <span class="progress-percentage">{{ getCompletionPercentage(department) }}%</span>
              </div>
              <div class="progress-bar">
                <div 
                  class="progress-fill" 
                  [style.width.%]="getCompletionPercentage(department)">
                </div>
              </div>
            </div>
          </div>
          
          <!-- Hover Effect -->
          <div class="card-hover-effect"></div>
          
          <!-- Click Indicator -->
          <div class="click-indicator">
            <i class="fas fa-arrow-right"></i>
          </div>
        </div>
      </div>
    </div>

    <!-- Employee Listing View -->
    <div *ngIf="currentView === 'employees'" class="employees-view">
      
      <!-- Loading State for Employees -->
      <div *ngIf="isLoading" class="loading-state">
        <div class="loading-spinner">
          <i class="fas fa-spinner fa-spin"></i>
        </div>
        <p>Loading employee data...</p>
      </div>
      
      <!-- Empty State -->
      <div *ngIf="!isLoading && getDisplayedEmployees().length === 0" class="empty-state">
        <div class="empty-state-content">
          <div class="empty-state-icon">
            <i class="fas fa-users"></i>
          </div>
          <h3>No Employees Found</h3>
          <p *ngIf="searchQuery">No employees match your search "<strong>{{ searchQuery }}</strong>" in {{ selectedDepartment?.department }} department.</p>
          <p *ngIf="!searchQuery">No employees found in {{ selectedDepartment?.department }} department for {{ getMonthName(selectedMonth) }} {{ selectedYear }}.</p>
          <button *ngIf="searchQuery" class="clear-search-btn" (click)="searchQuery = ''; onSearchChange()">
            <i class="fas fa-times"></i>
            Clear Search
          </button>
        </div>
      </div>
      
      <!-- Employee List -->
      <div class="employee-list" *ngIf="!isLoading && getDisplayedEmployees().length > 0">
        <div 
          *ngFor="let employee of getDisplayedEmployees(); trackBy: trackByEmployeeId" 
          class="employee-card glassmorphism"
          [class.expanded]="isEmployeeExpanded(employee.id)">
          
          <!-- Main Employee Row -->
          <div class="employee-main-row" 
               [class.expandable]="canExpandEmployee(employee)"
               [class.non-expandable]="!canExpandEmployee(employee)"
               (click)="toggleEmployeeDetails(employee.id, employee)">
            <!-- Rank Badge -->
            <div class="rank-badge" [class]="getRankIconClass(employee.rank)">
              <i *ngIf="employee.rank === 1" class="fas fa-crown rank-icon-gold"></i>
              <i *ngIf="employee.rank === 2" class="fas fa-medal rank-icon-silver"></i>
              <i *ngIf="employee.rank === 3" class="fas fa-award rank-icon-bronze"></i>
              <span *ngIf="employee.rank > 3" class="rank-number">#{{ employee.rank }}</span>
            </div>
          
            <!-- Employee Info -->
            <div class="employee-info">
              <div class="employee-avatar" (click)="viewEmployeeProfile(employee); $event.stopPropagation()">
                <img [src]="employee.profileImage" [alt]="employee.name" />
                <div class="avatar-overlay">
                  <i class="fas fa-user"></i>
                </div>
              </div>
              
              <div class="employee-details">
                <h3 class="employee-name">
                  {{ employee.name }}
                </h3>
                <div class="employee-meta">
                  <span class="month-year">{{ employee.month }} {{ employee.year }}</span>
                  <span class="status-badge" [ngClass]="getStatusClass(employee.status)">
                    {{ getStatusText(employee.status) }}
                  </span>
                </div>
              </div>
            </div>
            
            <!-- Overall Score Section -->
            <div class="score-section">
              <div class="score-display">
                <div class="score-number">{{ getDisplayScore(employee) }}</div>
                <div class="score-label">Overall Score</div>
              </div>
            </div>
            
            <!-- Expand/Collapse Icon (only for approved employees) -->
            <div class="expand-icon" *ngIf="canExpandEmployee(employee)">
              <i class="fas" [class.fa-chevron-down]="!isEmployeeExpanded(employee.id)" 
                 [class.fa-chevron-up]="isEmployeeExpanded(employee.id)"></i>
            </div>
            
            <!-- Empty space for non-approved employees to maintain layout -->
            <div class="status-indicator" *ngIf="!canExpandEmployee(employee)">
              <!-- Status is already shown in employee-meta, no need to duplicate -->
            </div>
          </div>

          <!-- Compact Performance Metrics (only for approved employees) -->
          <div class="compact-metrics" *ngIf="isEmployeeExpanded(employee.id) && employee.performanceMetrics && canExpandEmployee(employee)">
            <div class="metrics-header">
              <span class="metrics-title">Performance Breakdown</span>
              <button class="view-full-btn" (click)="viewMPRDetails(employee); $event.stopPropagation()">
                <i class="fas fa-external-link-alt"></i>
                View Details
              </button>
            </div>
            
            <div class="metrics-compact-grid">
              <div class="metric-compact">
                <div class="metric-info">
                  <i [class]="getPerformanceMetricIcon('quality')" [style.color]="getPerformanceMetricColor(employee.performanceMetrics.quality)"></i>
                  <span class="metric-label">Quality</span>
                </div>
                <div class="metric-value">{{ employee.performanceMetrics.quality }}</div>
                <div class="metric-mini-bar">
                  <div class="metric-fill" [style.width.%]="employee.performanceMetrics.quality" [style.background-color]="getPerformanceMetricColor(employee.performanceMetrics.quality)"></div>
                </div>
              </div>

              <div class="metric-compact">
                <div class="metric-info">
                  <i [class]="getPerformanceMetricIcon('timeliness')" [style.color]="getPerformanceMetricColor(employee.performanceMetrics.timeliness)"></i>
                  <span class="metric-label">Timeliness</span>
                </div>
                <div class="metric-value">{{ employee.performanceMetrics.timeliness }}</div>
                <div class="metric-mini-bar">
                  <div class="metric-fill" [style.width.%]="employee.performanceMetrics.timeliness" [style.background-color]="getPerformanceMetricColor(employee.performanceMetrics.timeliness)"></div>
                </div>
              </div>

              <div class="metric-compact">
                <div class="metric-info">
                  <i [class]="getPerformanceMetricIcon('initiative')" [style.color]="getPerformanceMetricColor(employee.performanceMetrics.initiative)"></i>
                  <span class="metric-label">Initiative</span>
                </div>
                <div class="metric-value">{{ employee.performanceMetrics.initiative }}</div>
                <div class="metric-mini-bar">
                  <div class="metric-fill" [style.width.%]="employee.performanceMetrics.initiative" [style.background-color]="getPerformanceMetricColor(employee.performanceMetrics.initiative)"></div>
                </div>
              </div>

              <div class="metric-compact">
                <div class="metric-info">
                  <i [class]="getPerformanceMetricIcon('communication')" [style.color]="getPerformanceMetricColor(employee.performanceMetrics.communication)"></i>
                  <span class="metric-label">Communication</span>
                </div>
                <div class="metric-value">{{ employee.performanceMetrics.communication }}</div>
                <div class="metric-mini-bar">
                  <div class="metric-fill" [style.width.%]="employee.performanceMetrics.communication" [style.background-color]="getPerformanceMetricColor(employee.performanceMetrics.communication)"></div>
                </div>
              </div>

              <div class="metric-compact">
                <div class="metric-info">
                  <i [class]="getPerformanceMetricIcon('teamwork')" [style.color]="getPerformanceMetricColor(employee.performanceMetrics.teamwork)"></i>
                  <span class="metric-label">Teamwork</span>
                </div>
                <div class="metric-value">{{ employee.performanceMetrics.teamwork }}</div>
                <div class="metric-mini-bar">
                  <div class="metric-fill" [style.width.%]="employee.performanceMetrics.teamwork" [style.background-color]="getPerformanceMetricColor(employee.performanceMetrics.teamwork)"></div>
                </div>
              </div>

              <div class="metric-compact">
                <div class="metric-info">
                  <i [class]="getPerformanceMetricIcon('problemSolving')" [style.color]="getPerformanceMetricColor(employee.performanceMetrics.problemSolving)"></i>
                  <span class="metric-label">Problem Solving</span>
                </div>
                <div class="metric-value">{{ employee.performanceMetrics.problemSolving }}</div>
                <div class="metric-mini-bar">
                  <div class="metric-fill" [style.width.%]="employee.performanceMetrics.problemSolving" [style.background-color]="getPerformanceMetricColor(employee.performanceMetrics.problemSolving)"></div>
                </div>
              </div>

              <div class="metric-compact hod-rating">
                <div class="metric-info">
                  <i [class]="getPerformanceMetricIcon('hodRating')" [style.color]="getPerformanceMetricColor(employee.performanceMetrics.hodRating)"></i>
                  <span class="metric-label">HOD Rating</span>
                </div>
                <div class="metric-value">{{ employee.performanceMetrics.hodRating }}</div>
                <div class="metric-mini-bar">
                  <div class="metric-fill" [style.width.%]="employee.performanceMetrics.hodRating" [style.background-color]="getPerformanceMetricColor(employee.performanceMetrics.hodRating)"></div>
                </div>
              </div>
            </div>
          </div>
          
          <!-- Card Glow Effect -->
          <div class="card-glow"></div>
        </div>
      </div>
    </div>
  </main>

  <!-- Employee Profile Modal -->
  <app-employee-profile-modal
    [employeeId]="selectedEmployeeId"
    [isVisible]="showProfileModal"
    (closeModal)="closeProfileModal()">
  </app-employee-profile-modal>
</div>